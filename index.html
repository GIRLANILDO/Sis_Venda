<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o de √ìtica</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    




<style>
    :root { 
        --p: #00f2ff; --s: #7000ff; --a: #ff0055; 
        --bg: #050505; --text: #e0e0e0; --glass: rgba(13, 13, 21, 0.85); --border: rgba(255,255,255,0.05);
    }




/* Efeito de piscar o olho */
.logo-blink {
    animation: eye-blink 6s infinite; /* Pisca a cada 6 segundos */
    transform-origin: center;
}

@keyframes eye-blink {
    0%, 96%, 100% {
        clip-path: inset(0% 0% 0% 0%); /* Olho aberto */
    }
    98% {
        clip-path: inset(45% 0% 45% 0%); /* Olho fechado (p√°lpebras se encontram no meio) */
    }
}

/* Brilho pulsante atr√°s da logo para dar um efeito "cyber" */
.logo-container {
    position: relative;
    display: inline-block;
}

.logo-container::before {
    content: '';
    position: absolute;
    inset: -20px;
    background: radial-gradient(circle, rgba(0, 242, 255, 0.15) 0%, transparent 70%);
    border-radius: 50%;
    z-index: 0;
    animation: pulse-glow 3s infinite ease-in-out;
}

@keyframes pulse-glow {
    0%, 100% { opacity: 0.5; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.1); }
}





    * { margin: 0; padding: 0; box-sizing: border-box; }

    /* RESET PARA EVITAR A FAIXA NO LOGIN */
    html, body {
        width: 100% !important;
        height: 100dvh !important; /* Ajusta para a altura real do celular */
        margin: 0 !important;
        padding: 0 !important;
        overflow: hidden !important; 
        background-color: #020617;
        touch-action: auto; /* Permite gestos do navegador */
    }


/* MENU E CONTE√öDO: Adicionado suporte a toque suave (iOS/Android) */
    nav, main {
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch !important; /* Habilita o "deslize" com in√©rcia */
        scroll-behavior: smooth;
    }


    body { 
        color: var(--text); 
        font-family: 'Inter', sans-serif; 
        -webkit-user-select: none;
        user-select: none;
    }

    /* ESTILO DA BARRA DE ROLAGEM DISCRETA (CYBER) */
    /* Ela s√≥ aparecer√° onde houver conte√∫do excedente */
    ::-webkit-scrollbar {
        width: 5px; /* Bem fininha */
    }
    ::-webkit-scrollbar-track {
        background: transparent;
    }
    ::-webkit-scrollbar-thumb {
        background: rgba(0, 242, 255, 0.2); /* Ciano transparente */
        border-radius: 10px;
        transition: 0.3s;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: var(--p); /* Ciano s√≥lido ao passar o mouse */
    }

    /* TELA DE LOGIN */
    .auth-screen { 
        background: radial-gradient(circle at top right, #0f172a, #020617) !important; 
        position: fixed !important; 
        inset: 0 !important;
        z-index: 9999; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        overflow: hidden;
    }

    /* MENU LATERAL - ROLAGEM DISCRETA */
    nav {
        height: 100vh !important;
        overflow-y: auto !important;
        scrollbar-width: thin; /* Firefox */
        scrollbar-color: rgba(0, 242, 255, 0.2) transparent;
    }

    /* Melhora o espa√ßamento no mobile para o dedo n√£o bater na borda */
    main {
        padding-bottom: 100px !important; 
    }

    /* ESTILOS DOS COMPONENTES */
    .font-cyber { font-family: 'Orbitron', sans-serif; }
    .neon-border { box-shadow: 0 0 10px var(--p); border: 1px solid var(--p); }
    .glass { background: var(--glass); backdrop-filter: blur(10px); border: 1px solid var(--border); }
    
    .btn-cyber { background: linear-gradient(45deg, var(--s), var(--p)); transition: all 0.3s; color: white; border: none; cursor: pointer; }
    .btn-cyber:hover { transform: translateY(-2px); box-shadow: 0 0 15px var(--p); }
    
    input, select, textarea { 
        background: rgba(0,0,0,0.5) !important; 
        border: 1px solid rgba(255,255,255,0.1) !important; 
        color: white !important; 
        font-size: 16px !important; /* M√≠nimo de 16px para evitar zoom autom√°tico no mobile */
        padding: 8px !important; 
        border-radius: 0.375rem !important; 
        outline: none; 
    }
    label { font-size: 0.65rem; text-transform: uppercase; color: #888; letter-spacing: 1px; margin-bottom: 2px; display: block; font-weight: bold; }

    /* EFEITO DE BRILHO NO LOGIN */
    .glow-card::after { 
        content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; 
        background: conic-gradient(from 0deg, transparent, rgba(34, 211, 238, 0.1), transparent 40%); 
        animation: rotateGlow 10s linear infinite; pointer-events: none; 
    }
    @keyframes rotateGlow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .glow-card > div { position: relative; z-index: 10; }

    @media print {
        body * { visibility: hidden; }
        .print-area, .print-area * { visibility: visible; }
        .print-area { position: absolute; left: 0; top: 0; width: 100%; background: white !important; color: black !important; }
        .no-print { display: none !important; }
    }


/* --- GEST√ÉO DE ACESSOS: SWITCHES --- */
.switch { position: relative; display: inline-block; width: 40px; height: 20px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334; transition: .4s; border-radius: 34px; border: 1px solid rgba(255,255,255,0.1); }
.slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: #00f2ff; }
input:checked + .slider:before { transform: translateX(20px); }



/* EFEITO PISCAR AMARELO PARA EXAME VENCIDO */
@keyframes pulseYellow {
    0%, 100% { background-color: transparent; }
    20% { background-color: rgba(265, 165, 0, 0.20); } 
}
.pulse-yellow {
    animation: pulseYellow 2s infinite ease-in-out;
}



/* EFEITO PISCAR VERMELHO PARA ANIVERSARIANTES */
@keyframes pulseRedRow {
    0%, 100% { background-color: transparent; }
    50% { background-color: rgba(239, 68, 68, 0.2); } /* Vermelho suave (0.2 de opacidade) */
}

.pulse-red-row {
    animation: pulseRedRow 2s infinite ease-in-out;
}



</style>








</head>
<body>
    <div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;

    const firebaseConfig = {
        apiKey: "AIzaSyCdGEHeeJCZLUu4vsA3R2zf2cjMGYDaz4w",
        authDomain: "sisvenda-775d9.firebaseapp.com",
        projectId: "sisvenda-775d9",
        storageBucket: "sisvenda-775d9.firebasestorage.app",
        messagingSenderId: "939932489586",
        appId: "1:939932489586:web:d831767389097097a3afeb"
    };

    // Inicializa√ß√£o correta do Firebase (apenas uma vez)
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
        firebase.initializeApp(firebaseConfig, "Secondary");
    }
    
    const db = firebase.firestore();
    const auth = firebase.auth();
    const secondaryAuth = firebase.app("Secondary").auth();

    // Vari√°vel Global de Permiss√µes
    window.userPermissions = {
        isAdmin: true,
        lockDelete: false,
        hideReports: false,
        hideProducts: false,
        hideConfig: false,
        lockSales: false
    };

    // Fun√ß√µes de Modal Globais
    window.openModalPerm = (id) => document.getElementById(id).classList.remove('hidden');
    window.closeModalPerm = (id) => document.getElementById(id).classList.add('hidden');

    const METODOS = ["Esp√©cie", "Cart√£o de Cr√©dito", "D√©bito", "PIX", "Permuta"];

    const Icon = ({ name, size = 18, className = "" }) => {
        const iconRef = useRef(null);
        useEffect(() => {
            // CORRE√á√ÉO: Inicializa apenas este n√≥ espec√≠fico, evitando o congelamento da CPU
            if (window.lucide && iconRef.current) {
                window.lucide.createIcons({
                    nodes: [iconRef.current]
                });
            }
        }, [name]);
        return <i ref={iconRef} data-lucide={name} className={className} style={{ width: size, height: size, display: 'inline-block' }}></i>;
    };


    // --- FUN√á√ïES AUXILIARES (PIX, PDF, ETC) ---
    const crc16 = (str) => {
        let crc = 0xFFFF;
        for (let i = 0; i < str.length; i++) {
            crc ^= str.charCodeAt(i) << 8;
            for (let j = 0; j < 8; j++) {
                if ((crc & 0x8000) !== 0) crc = (crc << 1) ^ 0x1021;
                else crc <<= 1;
            }
        }
        return (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
    };

    const generatePixPayload = (key, name, city, amount, txtId) => {
    const format = (id, val) => id + val.length.toString().padStart(2, '0') + val;
    // Remove espa√ßos e caracteres especiais do nome para evitar erro no payload
    const cleanName = name.normalize("NFD").replace(/[\u0300-\u036f]/g, "").substring(0, 25);
    const amountStr = amount.toFixed(2);
    let payload = "000201";
    payload += format("26", format("00", "br.gov.bcb.pix") + format("01", key));
    payload += "52040000";
    payload += "5303986";
    payload += format("54", amountStr);
    payload += "5802BR";
    payload += format("59", cleanName);
    payload += format("60", city.substring(0, 15));
    payload += format("62", format("05", txtId.replace(/\s/g, '')));
    payload += "6304";
    return payload + crc16(payload);
};





        const QRCodeComponent = ({ value, size = 100 }) => {
            const containerRef = useRef();
            useEffect(() => {
                if (containerRef.current) {
                    containerRef.current.innerHTML = "";
                    new QRCode(containerRef.current, {
                        text: value,
                        width: size,
                        height: size,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                    });
                }
            }, [value]);
            return <div ref={containerRef} className="border-2 border-black p-1 bg-white inline-block"></div>;
        };
        // --- FIM DAS FUN√á√ïES PIX ---





// --- FUN√á√ÉO PARA GERAR A CAPA COM MODAL ---
const gerarCapaPDF = async (info, settings) => {
    if (!info || !info.client) return;

    // --- 1. CRIAR O MODAL DE ESCOLHA ---
    const modalHtml = `
        <div id="modal-capa" style="position:fixed; inset:0; background:rgba(0,0,0,0.9); display:flex; align-items:center; justify-content:center; z-index:9999; font-family:sans-serif;">
            <div style="background:#111; border:1px solid #00f2ff; padding:30px; border-radius:20px; text-align:center; max-width:350px; width:90%; box-shadow: 0 0 30px rgba(0,242,255,0.3);">
                <h3 style="color:#00f2ff; margin-bottom:10px; font-size:16px; font-family:'Orbitron', sans-serif;">IMPRIMIR CAPA DO CARN√ä</h3>
                <p style="color:#ccc; font-size:12px; margin-bottom:25px;">Gerar capa personalizada para:<br><b style="color:white;">${info.client.nome}</b></p>
                <div style="display:grid; gap:12px;">
                    <button id="capa-print" style="background:#00f2ff; color:#000; border:none; padding:15px; border-radius:10px; font-weight:bold; cursor:pointer; text-transform:uppercase; font-size:11px;">üñ®Ô∏è Visualizar e Imprimir</button>
                    <button id="capa-save" style="background:#7000ff; color:#fff; border:none; padding:15px; border-radius:10px; font-weight:bold; cursor:pointer; text-transform:uppercase; font-size:11px;">üíæ Salvar PDF</button>
                    <button id="capa-cancel" style="background:transparent; color:#666; border:1px solid #333; padding:10px; border-radius:10px; cursor:pointer; font-size:10px; margin-top:10px;">CANCELAR</button>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);

    const processarCapa = async (acao) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        const wCapa = 192; 
        const hCapa = 70;  
        const m = 10; 
        const y = 10;

        // --- DESIGN DA CAPA ---
        doc.setDrawColor(200);
        doc.setLineWidth(0.1);
        doc.rect(m, y, wCapa, hCapa); 

        doc.setFillColor(112, 0, 255); 
        doc.rect(m, y, 5, hCapa, 'F');

        if (settings?.logo) {
            try { doc.addImage(settings.logo, 'PNG', m + 15, y + 10, 45, 20); } catch(e) {}
        } else {
            doc.setFont("helvetica", "bold");
            doc.setFontSize(20);
            doc.text("√ìTICA ILUMINAR", m + 15, y + 20);
        }

        doc.setFont("helvetica", "bold");
        doc.setFontSize(18);
        doc.setTextColor(112, 0, 255);
        doc.text("CARN√ä DE", m + wCapa - 15, y + 18, { align: "right" });
        doc.setFontSize(24);
        doc.setTextColor(0);
        doc.text("PAGAMENTO", m + wCapa - 15, y + 28, { align: "right" });

        doc.setDrawColor(112, 0, 255);
        doc.setLineWidth(0.8);
        doc.line(m + 15, y + 35, m + wCapa - 15, y + 35);

        doc.setFontSize(16);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(0);
        doc.text(info.client.nome.toUpperCase(), m + 20, y + 45);

        doc.setFontSize(12);
        doc.setTextColor(100);
        doc.text(`CPF: ${info.client.cpf}`, m + 20, y + 52);

        doc.setFillColor(245, 245, 245);
        doc.rect(m + 5.1, y + hCapa - 6, wCapa - 5.2, 6, 'F');
        
        doc.setFontSize(9);
        doc.setTextColor(80);
        const endereco = settings?.endereco || "ENDERE√áO N√ÉO CADASTRADO";
        const tel = settings?.whatsapp || "";
        doc.text(`${endereco}  |  TEL: ${tel}`, m + (wCapa/2) + 2.5, y + hCapa - 2, { align: "center" });

        if (acao === 'save') {
            doc.save(`capa_${info.client.nome.replace(/\s+/g, '_')}.pdf`);
        } else {
            window.open(doc.output('bloburl'), '_blank');
        }
        document.getElementById('modal-capa').remove();
    };

    document.getElementById('capa-print').onclick = () => processarCapa('print');
    document.getElementById('capa-save').onclick = () => processarCapa('save');
    document.getElementById('capa-cancel').onclick = () => document.getElementById('modal-capa').remove();
};







// Substitua o in√≠cio da fun√ß√£o gerarCarnePDF por este:
const gerarCarnePDF = async (info, settings) => { 
    if (!info || !info.client || !info.sale) {
        alert("Dados insuficientes para gerar o carn√™.");
        return;
    }

    // --- VALIDA√á√ÉO CR√çTICA: S√ì GERA SE HOUVER CONFIGURA√á√ÉO ---
    if (!settings?.pixKey || !settings?.pixName || !settings?.pixCity) {
        alert("ERRO: Configure os dados do PIX (Chave, Titular e Cidade) na aba 'Configura√ß√µes' antes de gerar o carn√™.");
        return;
    }

    const MEU_PIX_CHAVE = settings.pixKey; 
    const MEU_PIX_NOME = settings.pixName;     
    const MINHA_CIDADE = settings.pixCity;




    // --- 2. L√ìGICA DO PAYLOAD PIX ---
    const crc16 = (str) => {
        let crc = 0xFFFF;
        for (let i = 0; i < str.length; i++) {
            crc ^= str.charCodeAt(i) << 8;
            for (let j = 0; j < 8; j++) {
                if ((crc & 0x8000) !== 0) crc = (crc << 1) ^ 0x1021;
                else crc <<= 1;
            }
        }
        return (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
    };

    const generatePixPayload = (key, name, city, amount, txtId = "√ìTICA ILUMINAR") => {
        const format = (id, val) => id + val.length.toString().padStart(2, '0') + val;
        const amountStr = amount.toFixed(2);
        let payload = "000201";
        payload += format("26", format("00", "br.gov.bcb.pix") + format("01", key));
        payload += "52040000";
        payload += "5303986";
        payload += format("54", amountStr);
        payload += "5802BR";
        payload += format("59", name.substring(0, 25));
        payload += format("60", city.substring(0, 15));
        payload += format("62", format("05", txtId));
        payload += "6304";
        return payload + crc16(payload);
    };

    // --- 3. FUN√á√ÉO PARA GERAR IMAGEM DO QR CODE (ALTA RESOLU√á√ÉO) ---
    const obterImagemQRCode = (texto) => {
        return new Promise((resolve) => {
            const container = document.createElement('div');
            const qrcode = new QRCode(container, {
                text: texto,
                width: 512, // Aumentado para melhor nitidez
                height: 512,
                correctLevel: QRCode.CorrectLevel.H // N√≠vel alto de corre√ß√£o
            });
            setTimeout(() => {
                const canvas = container.querySelector('canvas');
                if (canvas) resolve(canvas.toDataURL("image/png"));
                else resolve(null);
            }, 150);
        });
    };

    // --- 4. MODAL DE ESCOLHA ---
    const modalHtml = `
        <div id="modal-print" style="position:fixed; inset:0; background:rgba(0,0,0,0.9); display:flex; align-items:center; justify-content:center; z-index:9999; font-family:sans-serif;">
            <div style="background:#111; border:1px solid #00f2ff; padding:30px; border-radius:20px; text-align:center; max-width:350px; width:90%; box-shadow: 0 0 30px rgba(0,242,255,0.3);">
                <h3 style="color:#00f2ff; margin-bottom:10px; font-size:16px; font-family:'Orbitron', sans-serif;">IMPRIMIR CARN√ä</h3>
                <p style="color:#ccc; font-size:12px; margin-bottom:25px;">Selecione o destino do carn√™ de:<br><b style="color:white;">${info.client.nome}</b></p>
                <div style="display:grid; gap:12px;">
                    <button id="btn-print" style="background:#00f2ff; color:#000; border:none; padding:15px; border-radius:10px; font-weight:bold; cursor:pointer; text-transform:uppercase; font-size:11px;">üñ®Ô∏è Imprimir Carn√™</button>
                    <button id="btn-save" style="background:#7000ff; color:#fff; border:none; padding:15px; border-radius:10px; font-weight:bold; cursor:pointer; text-transform:uppercase; font-size:11px;">üíæ Salvar PDF</button>
                    <button id="btn-cancel" style="background:transparent; color:#666; border:1px solid #333; padding:10px; border-radius:10px; cursor:pointer; font-size:10px; margin-top:10px;">CANCELAR</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // --- 5. L√ìGICA DE GERA√á√ÉO DO PDF ---
const processarDoc = async (acao) => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const totalParcelas = info.installments.length;
    
    const h = 65; // Altura de cada boleto
    const m = 14; // Margem esquerda
    const espacamento = 5; // Espa√ßo de um CARN√ä para outro
    let y = 3; // Posi√ß√£o inicial no topo da p√°gina

    for (let index = 0; index < info.installments.length; index++) {
        const inst = info.installments[index];

        if (index > 0 && index % 4 === 0) {
            doc.addPage();
            y = 3; // Resetando para a posi√ß√£o inicial da nova p√°gina
        }



// --- L√ìGICA PARA IDENTIFICADOR: 1¬∫ NOME + 2 SOBRENOMES + PARCELA ---
const partesNome = info.client.nome.trim().split(/\s+/);

const primeiroNome = partesNome[0].normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9]/g, "");
// Pega o √∫ltimo sobrenome (geralmente o mais importante para identifica√ß√£o)
const ultimoSobrenome = partesNome.length > 1 ? partesNome[partesNome.length - 1].normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9]/g, "") : "";

const sufixoParcela = "P" + inst.number; // Ex: P1, P10

// Monta o nome (Ex: MARIAPEREIRA)
let identificadorTexto = (primeiroNome + ultimoSobrenome).toUpperCase();

// Se o nome + sobrenome + parcela passar de 25, cortamos um pouco do sobrenome para caber a parcela
if ((identificadorTexto + sufixoParcela).length > 25) {
    const tamanhoDisponivel = 25 - sufixoParcela.length;
    identificadorTexto = identificadorTexto.substring(0, tamanhoDisponivel);
}

// Resultado final garantido com no m√°ximo 25 caracteres
const identificadorFinal = identificadorTexto + sufixoParcela;

const payloadPix = generatePixPayload(MEU_PIX_CHAVE, MEU_PIX_NOME, MINHA_CIDADE, inst.amount, identificadorFinal);
    // --- NOVO BLOCO TERMINA AQUI ---



        const qrCodeImg = await obterImagemQRCode(payloadPix);

        const stubW = 48; 
        const mainW = 142; 
        const xMain = m + stubW + 2; 
        const xF = xMain + mainW; 
        const rightColW = 42;
        const xColD = xF - rightColW; 

        doc.setDrawColor(0);
        doc.setLineWidth(0.2);
        doc.setLineDashPattern([], 0); // Garante que as bordas sejam s√≥lidas

        // BORDAS
        doc.rect(m, y, stubW, h); 
        doc.rect(xMain, y, mainW, h); 

        // LINHAS HORIZONTAIS
        doc.line(m, y + 10, m + stubW, y + 10); 
        doc.line(m, y + 20, m + stubW, y + 20); 
        doc.line(m, y + 55, m + stubW, y + 55);

        doc.line(xMain, y + 10, xF, y + 10); 
        doc.line(xMain, y + 20, xF, y + 20); 
        doc.line(xMain, y + 32, xColD, y + 32); 
        doc.line(xMain, y + 55, xColD, y + 55); 
        doc.line(xMain, y + 65, xF, y + 65); 

        // LINHAS VERTICAIS
        doc.line(m + (stubW/2), y, m + (stubW/2), y + 10); 
        doc.line(xColD, y, xColD, y + 65); 
        doc.line(xColD + (rightColW/2), y, xColD + (rightColW/2), y + 10);
        doc.line(xMain + 55, y + 20, xMain + 55, y + 32); 
        doc.line(xMain + 75, y + 55, xMain + 75, y + 65);

        // LABELS E DADOS (omitidos para brevidade, mantenha o seu c√≥digo original aqui...)
        doc.setFontSize(6);
        doc.setFont("helvetica", "normal");
        doc.text("Parcela", m + 1, y + 3);
        doc.text("Vencimento", m + (stubW/2) + 1, y + 3);
        doc.text("Valor Documento", m + 1, y + 13);
        doc.text("PIX PARA PAGAMENTO", m + stubW/2, y + 23, {align: "center"});
        doc.text("Cliente", m + 1, y + 58);

        doc.text("Local de pagamento", xMain + 1, y + 3);
        doc.text("Cedente", xMain + 1, y + 13);
        doc.text("Data Doc.", xMain + 1, y + 23);
        doc.text("Esp√©cie Doc.", xMain + 56, y + 23);
        doc.text("Autentica√ß√£o Mec√¢nica", xMain + 1, y + 35);
        doc.text("Aten√ß√£o: Pagamentos via Pix s√≥ ter√£o baixa ap√≥s o envio do comprovante para o contato da √≥tica.", xMain + 1, y + 52);
        doc.text("Parcelas pagas em nome de terceiros tamb√©m devem ser comunicadas.", xMain + 1, y + 54);
        doc.text("Cliente", xMain + 1, y + 58);
        doc.text("CPF", xMain + 76, y + 58);

        doc.text("Parcela", xColD + 1, y + 3);
        doc.text("Vencimento", xColD + (rightColW/2) + 1, y + 3);
        doc.text("Valor Documento", xColD + 1, y + 13);
        doc.text("PIX PARA PAGAMENTO", xColD + (rightColW/2), y + 23, {align: "center"});

        doc.setFont("helvetica", "bold");
        const vVenc = inst.dueDate.split('-').reverse().join('/');
        const vValor = `R$ ${inst.amount.toFixed(2)}`;
        const vParc = `${inst.number}/${totalParcelas}`;

        doc.setFontSize(6); 
        doc.text(info.client.nome.substring(0, 30), m + 1, y + 62);
        doc.text(vParc, m + 2, y + 8);
        doc.text(vVenc, m + (stubW/2) + 2, y + 8);
        doc.text(vValor, m + 2, y + 18);

        doc.setFontSize(7);
        doc.text("PAG√ÅVEL APENAS NA √ìTICA ILUMINAR OU VIA PIX", xMain + 1, y + 8);
        doc.text(MEU_PIX_NOME, xMain + 1, y + 18);
        doc.text(new Date().toLocaleDateString(), xMain + 5, y + 28); 
        doc.text("Carn√™", xMain + 65, y + 28); 
        doc.text(info.client.nome.toUpperCase(), xMain + 1, y + 62);
        doc.text(info.client.cpf, xMain + 76, y + 62);

        doc.text(vParc, xColD + 2, y + 8);
        doc.text(vVenc, xColD + (rightColW/2) + 2, y + 8);
        doc.setFontSize(10);
        doc.text(vValor, xF - 2, y + 18, {align: "right"});

        if (qrCodeImg) {
            doc.addImage(qrCodeImg, 'PNG', m + 9, y + 24, 30, 30); 
            doc.addImage(qrCodeImg, 'PNG', xColD + 6, y + 24, 30, 30); 
        }

        // --- NOVO: LINHA DE CORTE TRACEJADA ---
        // Desenha apenas se n√£o for o √∫ltimo carn√™ da p√°gina
        if ((index + 1) % 4 !== 0 && (index + 1) < totalParcelas) {
            const posLinhaCorte = y + h + (espacamento / 2);
            doc.setDrawColor(150); // Cor cinza para a linha de corte
            doc.setLineWidth(0.1);
            doc.setLineDashPattern([2, 2], 0); // Tra√ßo de 2mm, espa√ßo de 2mm
            doc.line(m, posLinhaCorte, xF, posLinhaCorte);
            doc.setLineDashPattern([], 0); // Reseta para linha s√≥lida
            doc.setDrawColor(0); // Reseta para preto
        }

        y += h + espacamento; 
    }

        if (acao === 'save') {
            doc.save(`carne_${info.client.nome.replace(/\s+/g, '_')}.pdf`);
        } else {
            window.open(doc.output('bloburl'), '_blank');
        }
        document.getElementById('modal-print').remove();
    };

    document.getElementById('btn-print').onclick = () => processarDoc('print');
    document.getElementById('btn-save').onclick = () => processarDoc('save');
    document.getElementById('btn-cancel').onclick = () => document.getElementById('modal-print').remove();
};




// --- FUN√á√ÉO GLOBAL DE IMPRESS√ÉO DE OS ---
const imprimirOS = (cliente, venda, globalData) => {
    const receitas = cliente.receitas || [];
    const settings = globalData.settings || {};

    if (receitas.length === 0) {
        alert("‚ö†Ô∏è Venda conclu√≠da, mas o cliente n√£o possui receita para imprimir a OS.");
        return;
    }

    // Fun√ß√£o interna que gera o conte√∫do HTML
    const gerarHTML_OS = (receitaEscolhida) => {
        const nomePaciente = (receitaEscolhida && receitaEscolhida.pacienteNome) ? receitaEscolhida.pacienteNome : cliente.nome;
        const numFixo = receitaEscolhida.numeroOS || 0;
        const numeroOS = numFixo.toString().padStart(5, '0');

        const itensLente = [];
        const itensArmacao = [];
        if (venda.items) {
            venda.items.forEach(nomeItem => {
                const produto = globalData.products.find(p => p.nome === nomeItem);
                if (produto) {
                    if (produto.categoria === "LENTES") itensLente.push(nomeItem);
                    else if (produto.categoria === "ARMA√á√ÉO" || produto.categoria === "SOLAR") itensArmacao.push(nomeItem);
                }
            });
        }

        return `
            <html>
            <head>
                <title>OS ${numeroOS} - ${nomePaciente}</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; color: #000; font-size: 11px; }
                    .header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #000; padding-bottom: 10px; }
                    .logo-box { flex: 1; text-align: left; }
                    .logo-box img { max-height: 80px; max-width: 250px; object-fit: contain; }
                    .info-box { flex: 2; text-align: right; line-height: 1.4; font-size: 11px; }
                    table { width: 100%; border-collapse: collapse; margin-bottom: 0px; }
                    td { border: 1px solid #000; padding: 5px; height: 18px; }
                    .label { font-weight: bold; margin-right: 5px; text-transform: uppercase; font-size: 11px; }
                    .center { text-align: center; font-weight: bold; background: #f2f2f2; }
                    .val { font-size: 12px; text-transform: uppercase; }
                    .os-number { font-size: 22px; color: #cc0000; font-weight: bold; }
                </style>
            </head>
            <body>
                <div class="header-container">
                    <div class="logo-box">
                        ${settings.logo ? `<img src="${settings.logo}">` : `<h1 style="margin:0;">${settings.nomeClinica || '√ìTICA'}</h1>`}
                    </div>
                    <div class="info-box">
                        <strong>${settings.nomeClinica || ''}</strong><br>
                        ${settings.endereco || ''} ${settings.cidadeUf || ''}<br>
                        <strong>Fone/WhatsApp: ${settings.whatsapp || ''}</strong>
                    </div>
                </div>
                <table>
                    <tr>
                        <td colspan="2"><span class="label">Paciente:</span> <span class="val" style="font-size: 14px;">${nomePaciente}</span></td>
                        <td width="30%" align="center"><span class="label">N¬∫ OS:</span><br><span class="os-number">${numeroOS}</span></td>
                    </tr>
                    <tr><td colspan="3"><span class="label">Respons√°vel Financeiro:</span> <span class="val">${cliente.nome}</span></td></tr>
                    <tr>
                        <td width="50%"><span class="label">CPF:</span> <span class="val">${cliente.cpf || ''}</span></td>
                        <td colspan="2"><span class="label">Data da Receita:</span> <span class="val">${receitaEscolhida.dataConsulta.split('-').reverse().join('/')}</span></td>
                    </tr>
                    <tr><td colspan="3"><span class="label">Endere√ßo:</span> <span class="val">${cliente.endereco || ''}, ${cliente.numero || ''} - ${cliente.bairro || ''}</span></td></tr>
                    <tr>
                        <td><span class="label">Bairro:</span> <span class="val">${cliente.bairro || ''}</span></td>
                        <td><span class="label">Cidade:</span> <span class="val">${cliente.cidade || ''}</span></td>
                        <td><span class="label">Fone:</span> <span class="val">${cliente.tel || ''}</span></td>
                    </tr>
                    <tr>
                        <td><span class="label">Data da Compra:</span> <span class="val">${new Date(venda.date + 'T12:00:00').toLocaleDateString()}</span></td>
                        <td><span class="label">Consultor:</span> <span class="val"></span></td>
                        <td><span class="label">Data da Entrega:</span> <span class="val"></span></td>
                    </tr>
                </table>
                <table style="margin-top:5px">
                    <tr>
                        <td width="50%"><span class="label">Lente:</span> <span class="val">${itensLente.join(' + ')}</span></td>
                        <td><span class="label">Arma√ß√£o:</span> <span class="val">${itensArmacao.join(' + ')}</span></td>
                    </tr>
                    <tr><td colspan="2"><span class="label">OBS da Receita:</span> <span class="val">${receitaEscolhida.obs || ''}</span></td></tr>
                </table>
                <table style="margin-top:5px">
                    <tr class="center">
                        <td>LONGE</td><td>ESF.</td><td>CIL.</td><td>EIXO</td><td>DNP</td><td>ALT</td><td>AV L.</td><td>AV P.</td><td>AD</td>
                    </tr>
                    <tr>
                        <td class="center">OD</td>
                        <td align="center" class="val">${receitaEscolhida.od?.esferico || ''}</td>
                        <td align="center" class="val">${receitaEscolhida.od?.cilindrico || ''}</td>
                        <td align="center" class="val">${receitaEscolhida.od?.eixo || ''}</td>
                        <td align="center" class="val">${receitaEscolhida.od?.dnp || ''}</td>
                        <td align="center" class="val">${receitaEscolhida.od?.altura || ''}</td>
                        <td align="center" class="val">${receitaEscolhida.od?.avLonge || ''}</td>
                        <td align="center" class="val">${receitaEscolhida.od?.avPerto || ''}</td>
                        <td rowspan="2" align="center" class="val" style="font-size: 14px; font-weight: bold;">${receitaEscolhida.ad || ''}</td>
                    </tr>
                    <tr>
                        <td class="center">OE</td>
                        <td align="center" class="val">${receitaEscolhida.oe?.esferico || ''}</td>
                        <td align="center" class="val">${receitaEscolhida.oe?.cilindrico || ''}</td>
                        <td align="center" class="val">${receitaEscolhida.oe?.eixo || ''}</td>
                        <td align="center" class="val">${receitaEscolhida.oe?.dnp || ''}</td>
                        <td align="center" class="val">${receitaEscolhida.oe?.altura || ''}</td>
                        <td align="center" class="val">${receitaEscolhida.oe?.avLonge || ''}</td>
                        <td align="center" class="val">${receitaEscolhida.oe?.avPerto || ''}</td>
                    </tr>
                </table>
                <script>window.onload = function() { window.print(); };<\/script>
            </body>
            </html>
        `;
    };

    const abrirModalEscolhaOS = (receita) => {
        const modalId = 'modal-os-print';
        const modalHtml = `
            <div id="${modalId}" style="position:fixed; inset:0; background:rgba(0,0,0,0.9); display:flex; align-items:center; justify-content:center; z-index:9999; font-family:sans-serif;">
                <div style="background:#111; border:1px solid #00f2ff; padding:30px; border-radius:20px; text-align:center; max-width:350px; width:90%; box-shadow: 0 0 30px rgba(0,242,255,0.3);">
                    <h3 style="color:#00f2ff; margin-bottom:10px; font-size:16px; font-family:'Orbitron', sans-serif;">IMPRIMIR O.S.</h3>
                    <p style="color:#ccc; font-size:12px; margin-bottom:25px;">Selecione uma op√ß√£o para a Ordem de Servi√ßo:</p>
                    <div style="display:grid; gap:12px;">
                        <button id="os-print" style="background:#00f2ff; color:#000; border:none; padding:15px; border-radius:10px; font-weight:bold; cursor:pointer; text-transform:uppercase; font-size:11px;">üñ®Ô∏è Visualizar e Imprimir</button>
                        <button id="os-save" style="background:#7000ff; color:#fff; border:none; padding:15px; border-radius:10px; font-weight:bold; cursor:pointer; text-transform:uppercase; font-size:11px;">üíæ Salvar PDF</button>
                        <button id="os-cancel" style="background:transparent; color:#666; border:1px solid #333; padding:10px; border-radius:10px; cursor:pointer; font-size:10px; margin-top:10px;">CANCELAR</button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        const processar = () => {
            const win = window.open('', '_blank');
            win.document.write(gerarHTML_OS(receita));
            win.document.close();
            document.getElementById(modalId).remove();
        };

        document.getElementById('os-print').onclick = () => processar();
        document.getElementById('os-save').onclick = () => processar();
        document.getElementById('os-cancel').onclick = () => document.getElementById(modalId).remove();
    };

    if (receitas.length === 1) {
        abrirModalEscolhaOS(receitas[0]);
    } else {
        const modalHtml = `
            <div id="modal-selecionar-receita" style="position:fixed; inset:0; background:rgba(0,0,0,0.9); display:flex; align-items:center; justify-content:center; z-index:9999; font-family:sans-serif;">
                <div style="background:#111; border:1px solid #00f2ff; padding:30px; border-radius:20px; text-align:center; max-width:450px; width:90%; box-shadow: 0 0 30px rgba(0,242,255,0.3);">
                    <h3 style="color:#00f2ff; margin-bottom:15px; font-size:16px;">SELECIONAR PACIENTE PARA OS</h3>
                    <div style="display:grid; gap:10px; max-height:300px; overflow-y:auto;">
                        ${receitas.map((rec, idx) => `
                            <button onclick="window.confirmarSelecaoReceitaGlobal(${idx})" style="background:rgba(255,255,255,0.05); color:#fff; border:1px solid #00f2ff; padding:15px; border-radius:10px; cursor:pointer; text-align:left;">
                                <div style="font-weight:bold; color:#00f2ff;">${rec.pacienteNome || cliente.nome}</div>
                                <div style="font-size:10px; color:#aaa;">DATA: ${rec.dataConsulta.split('-').reverse().join('/')}</div>
                            </button>
                        `).join('')}
                    </div>
                    <button id="btn-cancelar-os" style="background:transparent; color:red; border:none; margin-top:15px; cursor:pointer; font-weight:bold;">CANCELAR</button>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        window.confirmarSelecaoReceitaGlobal = (index) => {
            document.getElementById('modal-selecionar-receita').remove();
            abrirModalEscolhaOS(receitas[index]);
        };
        document.getElementById('btn-cancelar-os').onclick = () => document.getElementById('modal-selecionar-receita').remove();
    }
};






// Fun√ß√µes de Gest√£o (Colar antes do const App)
    window.acessarPainelRestricoes = () => {
        window.openModalPerm('modal-restricoes');
        window.renderListaUsuarios();
    };





// >>> COLE O NOVO C√ìDIGO AQUI <<<
window.updateOSStatus = async (saleId, field, value, deliveryDate = null) => {
    try {
        const updateData = { [field]: value };
        // Se for o campo de entrega, salva a data junto ou apaga se desmarcar
        if (field === 'dataOS_entregue') {
            updateData.dataOS_entrega = value ? deliveryDate : "---";
        }
        
        await db.collection("sales").doc(saleId).update(updateData);
        console.log("Status da O.S. atualizado no Firebase!");
    } catch (e) {
        console.error("Erro ao salvar status da O.S.:", e);
    }
};





window.renderListaUsuarios = async () => {
        const lista = document.getElementById('lista-usuarios-sistema');
        lista.innerHTML = "<tr><td colspan='12' class='p-10 text-center'>Carregando funcion√°rios...</td></tr>";
        
        const adminUid = firebase.auth().currentUser.uid;

        try {
            // BUSCA: Usu√°rios onde o patr√£o √© voc√™ OU √© voc√™ mesmo
            // Nota: Como o Firebase n√£o faz OR complexo facilmente, pegamos os funcion√°rios
            const snap = await db.collection("usuarios")
                .where("ownerId", "==", adminUid)
                .get();

            lista.innerHTML = "";
            
            // Adiciona voc√™ (O Administrador) no topo da lista
            const adminDoc = await db.collection("usuarios").doc(adminUid).get();
            const users = [];
            if(adminDoc.exists) users.push({id: adminDoc.id, ...adminDoc.data()});
            
            snap.forEach(doc => {
                if(doc.id !== adminUid) users.push({id: doc.id, ...doc.data()});
            });

            users.forEach(u => {
                const isUserAdmin = u.isAdmin === true;
                lista.innerHTML += `
                    <tr class="hover:bg-white/5 text-gray-300">
                        <td class="py-4 px-6 text-right">
                            ${(isUserAdmin || u.id === adminUid) ? '-' : `<button onclick="window.deleteUserPerm('${u.id}')" class="text-red-500 hover:underline">Excluir</button>`}
                        </td>
                        <td class="py-4 px-6 font-bold text-white">
                            ${u.email} ${u.id === adminUid ? '<span class="text-[8px] bg-cyan-500/20 text-cyan-400 p-1 rounded ml-2">VOC√ä</span>' : ''}
                        </td>
                        <td class="py-4 px-6 text-center"><label class="switch"><input type="checkbox" onchange="window.updateUserPerm('${u.id}', 'isAdmin', this.checked)" ${u.isAdmin ? 'checked' : ''} ${u.id === adminUid ? 'disabled' : ''}><span class="slider"></span></label></td>
                        <td class="py-4 px-6 text-center"><label class="switch"><input type="checkbox" onchange="window.updateUserPerm('${u.id}', 'hideDashboard', this.checked)" ${u.hideDashboard ? 'checked' : ''} ${isUserAdmin ? 'disabled' : ''}><span class="slider"></span></label></td>
                        <td class="py-4 px-6 text-center"><label class="switch"><input type="checkbox" onchange="window.updateUserPerm('${u.id}', 'hideClients', this.checked)" ${u.hideClients ? 'checked' : ''} ${isUserAdmin ? 'disabled' : ''}><span class="slider"></span></label></td>
                        <td class="py-4 px-6 text-center"><label class="switch"><input type="checkbox" onchange="window.updateUserPerm('${u.id}', 'hideClientList', this.checked)" ${u.hideClientList ? 'checked' : ''} ${isUserAdmin ? 'disabled' : ''}><span class="slider"></span></label></td>
                        <td class="py-4 px-6 text-center"><label class="switch"><input type="checkbox" onchange="window.updateUserPerm('${u.id}', 'hideTemplates', this.checked)" ${u.hideTemplates ? 'checked' : ''} ${isUserAdmin ? 'disabled' : ''}><span class="slider"></span></label></td>
                        <td class="py-4 px-6 text-center"><label class="switch"><input type="checkbox" onchange="window.updateUserPerm('${u.id}', 'hideReports', this.checked)" ${u.hideReports ? 'checked' : ''} ${isUserAdmin ? 'disabled' : ''}><span class="slider"></span></label></td>
                        <td class="py-4 px-6 text-center"><label class="switch"><input type="checkbox" onchange="window.updateUserPerm('${u.id}', 'hideProducts', this.checked)" ${u.hideProducts ? 'checked' : ''} ${isUserAdmin ? 'disabled' : ''}><span class="slider"></span></label></td>
                        <td class="py-4 px-6 text-center"><label class="switch"><input type="checkbox" onchange="window.updateUserPerm('${u.id}', 'lockSales', this.checked)" ${u.lockSales ? 'checked' : ''} ${isUserAdmin ? 'disabled' : ''}><span class="slider"></span></label></td>
                        <td class="py-4 px-6 text-center"><label class="switch"><input type="checkbox" onchange="window.updateUserPerm('${u.id}', 'hideConfig', this.checked)" ${u.hideConfig ? 'checked' : ''} ${isUserAdmin ? 'disabled' : ''}><span class="slider"></span></label></td>
                        <td class="py-4 px-6 text-center"><label class="switch"><input type="checkbox" onchange="window.updateUserPerm('${u.id}', 'lockDelete', this.checked)" ${u.lockDelete ? 'checked' : ''} ${isUserAdmin ? 'disabled' : ''}><span class="slider"></span></label></td>
                    </tr>`;
            });
        } catch (e) {
            console.error("Erro ao listar usu√°rios:", e);
            lista.innerHTML = "<tr><td colspan='12' class='p-10 text-center text-red-500'>Erro de permiss√£o ao carregar lista.</td></tr>";
        }
    };





    window.updateUserPerm = async (uid, field, value) => {
        await db.collection("usuarios").doc(uid).update({ [field]: value });
    };






// FUN√á√ÉO PARA EXCLUIR USU√ÅRIO
    window.deleteUserPerm = async (uid) => {
        // Impede de excluir o pr√≥prio usu√°rio logado por engano
        if (uid === firebase.auth().currentUser.uid) {
            alert("‚ùå Voc√™ n√£o pode excluir sua pr√≥pria conta de administrador por aqui.");
            return;
        }

        if (!confirm("‚ö†Ô∏è ATEN√á√ÉO: Deseja realmente remover o acesso deste funcion√°rio?\n\nEle n√£o conseguir√° mais visualizar os dados da sua √≥tica.")) return;

        try {
            // Remove o documento de permiss√µes do Firestore
            await db.collection("usuarios").doc(uid).delete();
            
            alert("‚úÖ Acesso removido com sucesso!");
            
            // Atualiza a lista na tela automaticamente
            window.renderListaUsuarios();
        } catch (e) {
            console.error("Erro ao excluir:", e);
            alert("Erro ao excluir usu√°rio: " + e.message);
        }
    };




window.saveNewUser = async () => {
        const email = document.getElementById('new-user-email').value;
        const pass = document.getElementById('new-user-pass').value;
        
        // --- LINHA M√ÅGICA: Pega o ID do Admin que est√° logado agora ---
        const adminId = firebase.auth().currentUser.uid; 

        if(!email || !pass) return alert("Preencha e-mail e senha.");

        try {
            // Cria a conta do funcion√°rio
            const userCred = await secondaryAuth.createUserWithEmailAndPassword(email, pass);
            
            // Salva no banco de dados J√Å COM O V√çNCULO (ownerId)
            await db.collection("usuarios").doc(userCred.user.uid).set({
                email: email, 
                uid: userCred.user.uid, 
                ownerId: adminId, // <-- O v√≠nculo autom√°tico acontece aqui!
                isAdmin: false, 
                hideDashboard: false,
                hideClients: false,
                hideClientList: false,
                hideTemplates: false,
                hideReports: false,
                hideProducts: false,
                lockSales: false,
                hideConfig: true, 
                lockDelete: true  
            });

            await secondaryAuth.signOut();
            alert("Funcion√°rio cadastrado com sucesso e vinculado √† sua √≥tica!");
            window.closeModalPerm('modal-novo-usuario');
            window.renderListaUsuarios(); 
            
            // Limpa os campos
            document.getElementById('new-user-email').value = "";
            document.getElementById('new-user-pass').value = "";
        } catch (e) { 
            alert("Erro ao cadastrar: " + e.message); 
        }
    };





// Fun√ß√£o para converter valor em extenso
const valorPorExtenso = (valor) => {
    if (!valor || valor <= 0) return "Zero Reais";
    const unidades = ["", "Um", "Dois", "Tr√™s", "Quatro", "Cinco", "Seis", "Sete", "Oito", "Nove"];
    const dezena10 = ["Dez", "Onze", "Doze", "Treze", "Quaturze", "Quinze", "Dezesseis", "Dezessete", "Dezoito", "Dezenove"];
    const dezenas = ["", "", "Vinte", "Trinta", "Quarenta", "Cinquenta", "Sessenta", "Setenta", "Oitenta", "Noventa"];
    const centenas = ["", "Cento", "Duzentos", "Trezentos", "Quatrocentos", "Quinhentos", "Seiscentos", "Setecentos", "Oitocentos", "Novecentos"];
    
    let v = Math.floor(valor);
    let texto = "";
    
    if (v >= 1000) {
        let mil = Math.floor(v / 1000);
        texto += (mil === 1 ? "Um Mil" : converterSimples(mil) + " Mil");
        v %= 1000;
        if (v > 0) texto += " e ";
    }

    function converterSimples(n) {
        if (n === 100) return "Cem";
        let c = Math.floor(n / 100), d = Math.floor((n % 100) / 10), u = n % 10;
        let res = centenas[c];
        if (res && (d || u)) res += " e ";
        if (d === 1) res += dezena10[u];
        else {
            res += dezenas[d];
            if (dezenas[d] && u) res += " e ";
            res += unidades[u];
        }
        return res;
    }

    if (v > 0) texto += converterSimples(v);
    return texto + " Reais";
};

// Fun√ß√£o de Impress√£o do Recibo Profissional
const imprimirReciboVenda = (cliente, valor, dataPagto, metodo, settings, descricao) => {
    const totalExtenso = valorPorExtenso(valor);
    const dataHoje = new Intl.DateTimeFormat('pt-BR', { dateStyle: 'full' }).format(new Date());
    const logo = settings?.logo || "";

    const modalId = 'modal-recibo-print';
    const modalHtml = `
        <div id="${modalId}" style="position:fixed; inset:0; background:rgba(0,0,0,0.9); display:flex; align-items:center; justify-content:center; z-index:9999; font-family:sans-serif;">
            <div style="background:#111; border:1px solid #00f2ff; padding:30px; border-radius:20px; text-align:center; max-width:350px; width:90%; box-shadow: 0 0 30px rgba(0,242,255,0.3);">
                <h3 style="color:#00f2ff; margin-bottom:10px; font-size:16px; font-family:'Orbitron', sans-serif;">IMPRIMIR RECIBO</h3>
                <p style="color:#ccc; font-size:12px; margin-bottom:25px;">Gerar recibo para:<br><b style="color:white;">${cliente.nome}</b></p>
                <div style="display:grid; gap:12px;">
                    <button id="rec-print" style="background:#00f2ff; color:#000; border:none; padding:15px; border-radius:10px; font-weight:bold; cursor:pointer; text-transform:uppercase; font-size:11px;">üñ®Ô∏è Visualizar e Imprimir</button>
                    <button id="rec-save" style="background:#7000ff; color:#fff; border:none; padding:15px; border-radius:10px; font-weight:bold; cursor:pointer; text-transform:uppercase; font-size:11px;">üíæ Salvar PDF</button>
                    <button id="rec-cancel" style="background:transparent; color:#666; border:1px solid #333; padding:10px; border-radius:10px; cursor:pointer; font-size:10px; margin-top:10px;">CANCELAR</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    const processar = () => {
        const win = window.open('', '', 'height=600,width=800');
        win.document.write(`
            <html>
            <head>
                <title>Recibo - ${cliente.nome}</title>
                <style>
                    @page { size: A5 portrait; margin: 0; }
                    body { font-family: sans-serif; display: flex; justify-content: center; padding: 10px; margin: 0; background: #fff; color: #000; }
                    .recibo-box { width: 100%; max-width: 14cm; padding: 15px; box-sizing: border-box; border: none; }
                    .header { display: grid; grid-template-columns: 1fr 1fr 1fr; align-items: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
                    .logo-side { text-align: left; }
                    .logo-side img { height: 50px; }
                    .logo-side p { font-size: 8px; font-weight: bold; margin: 5px 0 0 0; }
                    .title-mid { text-align: center; }
                    .title-mid h1 { font-size: 28px; margin: 0; font-weight: 900; }
                    .value-side { background: #dfdfdf; border: 2px solid #000; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; }
                    .main-content { border: 2px solid #000; border-radius: 12px; padding: 15px; margin-bottom: 15px; line-height: 1.8; font-size: 13px; }
                    .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; font-weight: bold; font-size: 11px; }
                    .footer-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
                    .f-box { border: 2px solid #000; border-radius: 12px; padding: 10px; font-size: 11px; }
                    .signature-box { text-align: center; display: flex; flex-direction: column; justify-content: space-between; }
                    .optom-tag { border-top: 1px solid #000; padding-top: 5px; font-size: 9px; font-weight: bold; margin-top: 30px; }
                </style>
            </head>
            <body>
                <div class="recibo-box">
                    <div class="header">
                        <div class="logo-side">
                            ${logo ? `<img src="${logo}">` : ''}
                            <p>CNPJ: ${settings?.cnpj || ''}</p>
                        </div>
                        <div class="title-mid"><h1>RECIBO</h1></div>
                        <div class="value-side">R$ ${Number(valor).toFixed(2)}</div>
                    </div>
                    <div class="main-content">
                        Recebi (emos) de: <b>${cliente.nome.toUpperCase()}</b><br>
                        A import√¢ncia de: <span style="background:transparent; padding: 0 5px;">${totalExtenso}</span><br>
                        Referente a: <span>${descricao}</span>
                        <div class="checkbox-group">
                            <span>Forma: [X] ${metodo}</span>
                        </div>
                    </div>
                    <div class="footer-grid">
                        <div class="f-box">
                            <b>Emitente:</b> ${settings?.nomeClinica || '√ìTICA ILUMINAR'}<br><br>
                            <b>Endere√ßo:</b> ${settings?.endereco || ''}
                        </div>
                        <div class="f-box signature-box">
                            <div><b>Data:</b> <span>${dataHoje}</span></div>
                            <div class="optom-tag">${settings?.respTecnico || ''}</div>
                        </div>
                    </div>
                </div>
                <script>window.onload = function() { window.print(); };<\/script>
            </body>
            </html>
        `);
        win.document.close();
        document.getElementById(modalId).remove();
    };

    document.getElementById('rec-print').onclick = () => processar();
    document.getElementById('rec-save').onclick = () => processar();
    document.getElementById('rec-cancel').onclick = () => document.getElementById(modalId).remove();
};





// Fun√ß√£o de Impress√£o do Contrato

const imprimirContrato = (cliente, venda, parcelas, settings) => {
    const dataHoje = new Intl.DateTimeFormat('pt-BR', { dateStyle: 'long' }).format(new Date());
    const cidadeConfig = settings?.cidadeUf || "Sua Cidade";

    // 1. CRIAR O MODAL DE ESCOLHA (ESTILO CYBER)
    const modalId = 'modal-contrato-print';
    const modalHtml = `
        <div id="${modalId}" style="position:fixed; inset:0; background:rgba(0,0,0,0.9); display:flex; align-items:center; justify-content:center; z-index:9999; font-family:sans-serif;">
            <div style="background:#111; border:1px solid #00f2ff; padding:30px; border-radius:20px; text-align:center; max-width:350px; width:90%; box-shadow: 0 0 30px rgba(0,242,255,0.3);">
                <h3 style="color:#00f2ff; margin-bottom:10px; font-size:16px; font-family:'Orbitron', sans-serif;">IMPRIMIR CONTRATO</h3>
                <p style="color:#ccc; font-size:12px; margin-bottom:25px;">Gerar contrato para:<br><b style="color:white;">${cliente.nome}</b></p>
                <div style="display:grid; gap:12px;">
                    <button id="cont-print" style="background:#00f2ff; color:#000; border:none; padding:15px; border-radius:10px; font-weight:bold; cursor:pointer; text-transform:uppercase; font-size:11px;">üñ®Ô∏è Visualizar e Imprimir</button>
                    <button id="cont-save" style="background:#7000ff; color:#fff; border:none; padding:15px; border-radius:10px; font-weight:bold; cursor:pointer; text-transform:uppercase; font-size:11px;">üíæ Salvar PDF</button>
                    <button id="cont-cancel" style="background:transparent; color:#666; border:1px solid #333; padding:10px; border-radius:10px; cursor:pointer; font-size:10px; margin-top:10px;">CANCELAR</button>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // 2. FUN√á√ÉO PARA GERAR O CONTE√öDO (SEU MODELO ORIGINAL)
    const processarDoc = () => {
        const win = window.open('', '_blank');
        win.document.write(`
            <html>
            <head>
                <title>Contrato - ${cliente.nome}</title>
                <style>
                    @page { size: A4 portrait; margin: 15mm; }
                    body { font-family: Arial, sans-serif; font-size: 10pt; background-color: #fff; color: #000; margin: 0; }
                    .titulo { text-align: center; font-weight: bold; text-decoration: underline; font-size: 12pt; margin-bottom: 15px; }
                    .texto { text-align: justify; margin-bottom: 10px; }
                    table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 12px; } 
                    th, td { border: 1px solid #000; padding: 2px; }
                    .head-table { background-color: #f2f2f2; font-weight: bold; text-align: center; text-transform: uppercase; font-size: 12px; }
                    .center { text-align: center; }
                    .right { text-align: right; }
                    .bold { font-weight: bold; }
                    .assinaturas { margin-top: 30px; width: 100%; border: none; border-spacing: 0; }
                    .assinaturas td { border: none !important; width: 50%; text-align: center; padding: 10px 0; }
                    .linha-assinatura { border-top: 1px solid #000; width: 220px; margin: 30px auto 0 auto; text-align: center; font-size: 9pt; padding-top: 5px; }
                    .footer { position: fixed; bottom: 0; width: 100%; border-top: 1px solid #000; padding-top: 5px; font-size: 8pt; display: flex; justify-content: space-between; }
                    .clausula { margin-top: 6px; text-align: justify; }
                </style>
            </head>
            <body>
                <div class="titulo">CONTRATO DE COMPRA E VENDA</div>
                
                <div class="texto">
                    Os abaixo assinados, de um lado <b>${settings?.nomeClinica || '√ìTICA ILUMINAR'}</b>, CPF/CNPJ: <b>${settings?.cnpj || ''}</b>, ENDERE√áO: <b>${settings?.endereco || ''}</b>, nesta cidade, e de outro, 
                    <b>${cliente.nome}</b>, residente na <b>${cliente.endereco || ''}, N¬∫ ${cliente.numero || ''} - BAIRRO: ${cliente.bairro || ''}</b>, na cidade de <b>${cliente.cidade || ''}-${cliente.estado || ''}</b>, 
                    CEL: <b>${cliente.tel || ''}</b>, CPF: <b>${cliente.cpf || ''}</b>, NASC: <b>${cliente.nascimento ? cliente.nascimento.split('-').reverse().join('/') : ''}</b>, tem justo e contratado na melhor forma de direito, o seguinte, que mutuamente outorgam e aceitam, a saber:
                </div>

                <div class="texto">O objetivo do contrato √© a regulamenta√ß√£o da rela√ß√£o de compra e venda de produtos/servi√ßos nos termos que se seguem:</div>

                <div class="clausula"><b>Cl√°usula 1¬∫</b> O vendedor vende ao comprador, pelo pre√ßo certo e ajustado conforme relatado abaixo, por meio de carn√™(s) entregue(s) ao comprador pelo vendedor.</div>

                <table>
                    <tr class="head-table">
                        <td width="15%">Quantidade</td>
                        <td>Produto/Servi√ßo</td>
                        <td width="25%">Valor</td>
                    </tr>
                    <tr>
                        <td class="center">1</td>
                        <td>${venda.items?.join(' + ') || '√ìCULOS COMPLETO'}</td>
                        <td class="right">R$ ${Number(venda.total).toFixed(2)}</td>
                    </tr>
                    <tr class="bold">
                        <td colspan="2" class="center">TOTAL DA COMPRA</td>
                        <td class="right">R$ ${Number(venda.total).toFixed(2)}</td>
                    </tr>
                </table>

                <div class="texto" style="font-size: 12px;"><b>Valor total da venda:</b> R$ ${Number(venda.total).toFixed(2)}, a serem pagos da seguinte forma abaixo:</div>

                <table>
                    <tr class="head-table">
                        <td>Entrada/Parcelas</td>
                        <td class="center">Vencimento</td>
                        <td class="center">Valor</td>
                    </tr>
                    ${venda.entry > 0 ? `
                    <tr>
                        <td class="bold">ENTRADA</td>
                        <td class="center">${venda.entryDat.split('-').reverse().join('/')}</td>
                        <td class="right">R$ ${Number(venda.entry).toFixed(2)}</td>
                    </tr>` : ''}
                    ${parcelas.map(p => `
                    <tr>
                        <td>${p.number}¬™ Parcela</td>
                        <td class="center">${p.dueDate.split('-').reverse().join('/')}</td>
                        <td class="right">R$ ${Number(p.amount).toFixed(2)}</td>
                    </tr>`).join('')}
                </table>

                <div class="clausula"><b>Cl√°usula 2¬∫</b> O compromisso hora assumido dever√° ser pago na(s) data(s) pactuada(s) sobre pena de t√≠pica infra√ß√£o conforme legisla√ß√£o em vigor.</div>
                <div class="clausula"><b>Cl√°usula 3¬∫</b> O produto/servi√ßo entregue/prestado pelo vendedor encontra-se em perfeito estado, atendendo todas as exig√™ncias do c√≥digo de defesa do consumidor.</div>
                <div class="clausula"><b>Cl√°usula 4¬∫</b> Per√≠odo de Adapta√ß√£o: Nos primeiros 15 dias de uso das novas lentes, √© comum experimentar alguns efeitos transit√≥rios, como tonturas, dores de cabe√ßa e percep√ß√£o de desn√≠veis. Lentes bifocais e progressivas geralmente exigem um per√≠odo de adapta√ß√£o mais longo, podendo levar at√© 20 dias ou mais.</div>
                <div class="clausula"><b>Cl√°usula 5¬∫</b> Em caso de desistente do servi√ßo contratado fica o comprador ciente que ter√° que responsabilizar-se com ressarcimento financeiro de todo e qualquer servi√ßo executado pela √≥tica.</div>
                <div class="clausula"><b>Cl√°usula 6¬∫</b> Enquanto n√£o tiver pagado integralmente o pre√ßo combinado, obriga-se o comprador a manter em perfeito estado de conserva√ß√£o o objeto de compra.</div>
                <div class="clausula"><b>Cl√°usula 7¬∫</b> Em caso de inadimpl√™ncia, o vendedor conforme preceitua o art. 1¬∫ da lei 9.492/1977, providenciar√° a inclus√£o de protesto de t√≠tulos no cart√≥rio.</div>
                <div class="clausula"><b>Cl√°usula 8¬∫</b> As informa√ß√µes do consumidor fornecidas ao fornecedor s√£o autorizadas previamente para informa√ß√µes positivas aos demais fornecedores.</div>
                
                <div class="clausula"><b>E, por estarem, vendedor e comprador de pleno acordo com os dispostos neste instrumento particular, assinam em duas vias de igual teor, juntamente com as testemunhas abaixo.</b></div></b>

                <div style="margin-top:50px; text-align:right; font-weight: bold;">
                    ${cidadeConfig}, ${dataHoje}
                </div>

                <table class="assinaturas">
                    <tr>
                        <td><div class="linha-assinatura">Comprador (a)</div></td>
                        <td><div class="linha-assinatura">Vendedor (a)</div></td>
                    </tr>
                    <tr>
                        <td><div class="linha-assinatura">1¬™ Testemunha</div></td>
                        <td><div class="linha-assinatura">2¬™ Testemunha</div></td>
                    </tr>
                </table>

                <div class="footer">
                    <div>${settings?.endereco || ''}</div>
                    <div>CEP: ${settings?.cep || ''}</div>
                    <div>Fone: ${settings?.whatsapp || ''}</div>
                    <div>${settings?.cidadeUf || ''}</div>
                </div>

                <script>window.onload = function() { window.print(); };<\/script>
            </body>
            </html>
        `);
        win.document.close();
        document.getElementById(modalId).remove();
    };

    // 3. ATRIBUIR AS A√á√ïES AOS BOT√ïES DO MODAL
    document.getElementById('cont-print').onclick = () => processarDoc();
    document.getElementById('cont-save').onclick = () => processarDoc();
    document.getElementById('cont-cancel').onclick = () => document.getElementById(modalId).remove();
};









// Fun√ß√£o para imprimir o Relat√≥rio Financeiro Detalhado
const imprimirRelatorioFinanceiro = (stats, viewMode, selectedDate, settings) => {
    const dataEmissao = new Date().toLocaleDateString('pt-BR') + ' ' + new Date().toLocaleTimeString('pt-BR');
    let tituloPeriodo = selectedDate.split('-').reverse().join('-');

    const win = window.open('', '_blank');
    win.document.write(`
        <html>
        <head>


            <title>Relat√≥rio Financeiro</title>
            <style>
                body { font-family: sans-serif; padding: 20px; color: #000; font-size: 24px; }
                .header { border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
                .resumo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }


/* Estilo das caixas de resumo */
.box { 
    border: 1px solid #000; 
    padding: 5px 10px; /* Diminu√≠do de 12px para 5px (cima/baixo) */
}

/* T√≠tulo dentro da caixa (VENDAS TOTAIS / CAIXA REAL) */
.box h3 { 
    margin: 0;        /* Remove a margem padr√£o que aumenta a altura */
    font-size: 12px;  /* Ajuste se necess√°rio */
}

/* Valor dentro da caixa (R$ ...) */
.box p { 
    margin: 0;        /* Remove a margem padr√£o que empurra a caixa para baixo */
    padding: 0;       /* Removido os 12px de padding que estavam aqui */
    font-size: 18px; 
    font-weight: bold;
}


                table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                th, td { border: 1px solid #000; padding: 6px; text-align: left; }
                th { background: #f2f2f2; }
            </style>
        </head>
        <body>
            <div class="header">
                ${settings?.logo ? `<img src="${settings.logo}" style="max-height:50px">` : '<div></div>'}
                <div style="text-align:center;">
                    <h1 style="margin:0; font-size:16px;">RELAT√ìRIO FINANCEIRO (RESUMO)</h1>
                    
                </div>
                <div style="text-align:right; font-size: 14px; font-weight: bold;">Emiss√£o: ${dataEmissao}</div>
            </div>
            <div class="resumo-grid">
                <div class="box"><h3>VENDAS TOTAIS</h3><p>R$ ${stats.totalVendido.toFixed(2)}</p></div>
                <div class="box"><h3>CAIXA REAL</h3><p>R$ ${stats.totalRecebido.toFixed(2)}</p></div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th style="text-align: center;">MEIO DE PAGAMENTO</th>
                        <th style="text-align: center;">VALOR</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>ESP√âCIE</td><td>R$ ${stats.resumo.especie.toFixed(2)}</td></tr>
                    <tr><td>PIX</td><td>R$ ${stats.resumo.pix.toFixed(2)}</td></tr>
                    <tr><td>CART√ÉO</td><td>R$ ${stats.resumo.cartao.toFixed(2)}</td></tr>
                    <tr><td>OUTROS</td><td>R$ ${stats.resumo.outros.toFixed(2)}</td></tr>
                </tbody>
            </table>
            <script>window.onload = function() { window.print(); window.close(); };<\/script>
        </body>
        </html>
    `);
    win.document.close();
};




// 2. RELAT√ìRIO DETALHADO (LISTA DE CLIENTES)
const imprimirRelatorioDetalhado = (stats, detailedList, viewMode, selectedDate, settings) => {
    console.log("Dados recebidos para impress√£o:", detailedList); // Para debug

    const dataEmissao = new Date().toLocaleDateString('pt-BR') + ' ' + new Date().toLocaleTimeString('pt-BR');
    let tituloPeriodo = selectedDate.split('-').reverse().join('-');

    // Se a lista estiver vazia, avisa o usu√°rio em vez de abrir p√°gina em branco
    if (!detailedList || detailedList.length === 0) {
        alert("Aten√ß√£o: N√£o existem recebimentos (entradas ou parcelas pagas) neste per√≠odo para gerar a lista.");
        return;
    }

    const win = window.open('', '_blank');
    win.document.write(`
        <html>
        <head>
            <title>Relat√≥rio Detalhado</title>
            <style>
                body { font-family: sans-serif; padding: 20px 15px 20px 15px; font-size: 10px; color: #000; }


                    .header p { 
        font-size: 16px;   /* Tamanho do texto do Per√≠odo */
        font-weight: bold; /* Deixa em negrito */
        margin-top: 5px;   /* Espa√ßamento em rela√ß√£o ao nome da √≥tica */
    }

    .header h2 {
        font-size: 24px;   /* Aproveite para aumentar o nome da sua √ìtica aqui */
    }


                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
                th { background: #f2f2f2; font-weight: bold; }
                .total-footer { margin-top: 20px; text-align: right; font-size: 18px; font-weight: bold; border-top: 2px solid #000; padding-top: 10px; }
            </style>
        </head>
        <body>
            <div class="header">
                <div>
                    <h2 style="margin:0">${settings?.nomeClinica || '√ìTICA ILUMINAR'}</h2>
                    <p>Relat√≥rio de Recebimentos - Per√≠odo: ${tituloPeriodo}</p>
                </div>
                <div style="text-align:right; font-size: 14px; font-weight: bold;">Emiss√£o: ${dataEmissao}</div>
            </div>

            <table>
<thead>
    <tr>
        <th style="text-align:center; width: 15%;">DATA PAGTO</th>       <!-- Largura da Data -->
        <th style="text-align:center; "width: 50%;">CLIENTE</th>                             <!-- Largura do Nome (Geralmente maior) -->
        <th style="text-align:center; "width: 20%;">TIPO</th>                   <!-- Largura do Tipo -->
        <th style="text-align:center; "width: 15%;">VALOR (R$)</th>         <!-- Largura do Valor -->
    </tr>
</thead>                <tbody>
                    ${detailedList.map(item => `
                        <tr>
                            <td style="text-align:center">${item.data ? item.data.split('-').reverse().join('/') : '---'}</td>
                            <td>${(item.cliente || 'CLIENTE N√ÉO IDENTIFICADO').toUpperCase()}</td>
                            <td>${item.tipo || 'PAGAMENTO'}</td>
                            <td style="text-align:right">R$ ${Number(item.valor || 0).toFixed(2)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>

            <div class="total-footer">
                TOTAL RECEBIDO: R$ ${Number(stats.totalRecebido || 0).toFixed(2)}
            </div>

            <script>
                window.onload = function() { 
                    window.print(); 
                };
            <\/script>
        </body>
        </html>
    `);
    win.document.close();
};







// --- 1. NOVA FUN√á√ÉO: IMPRIMIR CONTROLE DE O.S. ---
const imprimirControleOS = (data, viewMode, selectedDate, settings) => {
    const filter = viewMode === 'month' ? selectedDate.substring(0, 7) : selectedDate;
    const vendasPeriodo = data.sales.filter(s => s.date && s.date.startsWith(filter));
    
    const meses = ["JANEIRO", "FEVEREIRO", "MAR√áO", "ABRIL", "MAIO", "JUNHO", "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"];
    const [ano, mes] = selectedDate.split('-');
    const tituloData = viewMode === 'month' ? meses[parseInt(mes)-1] + "/" + ano : selectedDate.split('-').reverse().join('/');

    const win = window.open('', '_blank');
    
    let totalItensValidos = 0;

    const linhasTabela = vendasPeriodo.map((v, i) => {
        const cliente = data.clients.find(c => c.id === v.clientId);
        const ultimaReceita = cliente?.receitas?.[0];
        const nomeExibicao = (ultimaReceita?.pacienteNome || v.clientName || "N√ÉO IDENTIFICADO").toUpperCase();
    
    const osNumRaw = ultimaReceita?.numeroOS || 0;
    const osNumFormatado = osNumRaw.toString().padStart(4, '0');
    const dataExRaw = ultimaReceita?.dataConsulta || "9999-12-31";
    
    const apenasLentes = [];
    let custoLentes = 0;

    v.items.forEach(itemName => {
        const produto = data.products.find(p => p.nome === itemName);
        if (produto && produto.categoria === "LENTES") {
            apenasLentes.push(produto.nome);
            custoLentes += Number(produto.precoCusto || 0);
        }
    });

    if (apenasLentes.length === 0) return ''; 
    totalItensValidos++;

    const isPaga = v.dataOS_paga || false;
    const isLab = v.dataOS_lab || false;
    const isEntregue = v.dataOS_entregue || false;
    const dtEntrega = v.dataOS_entrega || "---";

    return `
        <tr data-custo="${custoLentes}" 
            data-os="${osNumRaw}" 
            data-exame="${dataExRaw}" 
            class="row-item" 
            id="row-${v.id}">
            <td class="col-index" style="text-align:center">00</td>
            <td style="text-align:center">${osNumFormatado}</td>
            <td style="text-align:center">${dataExRaw.split('-').reverse().join('/')}</td>
            <td>${nomeExibicao}</td> <!-- NOME ALTERADO PARA PACIENTE AQUI -->
            <td>${apenasLentes.join(' + ')}</td>
            <td style="text-align:center">
                <input type="checkbox" class="chk-paga" ${isPaga ? 'checked' : ''} 
                    onchange="salvarNoBanco('${v.id}', 'dataOS_paga', this.checked)">
            </td>
            <td style="text-align:center">
                <input type="checkbox" class="chk-lab" ${isLab ? 'checked' : ''} 
                    onchange="salvarNoBanco('${v.id}', 'dataOS_lab', this.checked)">
            </td>
            <td style="text-align:center">
                <input type="checkbox" class="chk-entregue" ${isEntregue ? 'checked' : ''} 
                    onchange="gerenciarEntrega('${v.id}', this.checked, '${v.id}')">
            </td>
            <td class="data-entrega" id="dt-${v.id}">${dtEntrega}</td>
        </tr>
    `;
}).join('');




    win.document.write(`
        <html>
        <head>
            <title>Controle de O.S. - ${tituloData}</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 10px; color: #000; font-size: 10px; }
                .main-title { background: #5d8233; color: white; text-align: center; font-size: 18px; font-weight: bold; padding: 10px; border: 1px solid #000; }
                table { width: 100%; border-collapse: collapse; }
                th { background: #8db4e2; border: 1px solid #000; padding: 5px; font-size: 9px; text-align: center; }
                td { border: 1px solid #000; padding: 6px; }
                .center { text-align: center; }
                .right { text-align: right; }
                .footer-blue { background: #8db4e2; font-weight: bold; font-size: 10px; }
                .total-box { background: #c4d79b; font-size: 20px; font-weight: bold; height: 45px; }
                input[type="checkbox"] { transform: scale(1.4); cursor: pointer; }
                .data-entrega { font-weight: bold; color: #333; text-align: center; }
                
                .no-print { background: #d4edda; padding: 15px; border-radius: 8px; border: 1px solid #c3e6cb; color: #155724; display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
                .controls { display: flex; gap: 10px; align-items: center; }
                select { padding: 8px; border-radius: 5px; border: 1px solid #5d8233; font-weight: bold; color: #5d8233; outline: none; cursor: pointer; }

                @media print { .no-print, .total-box { display: none !important; } body { padding: 0; } }
            </style>
        </head>
        <body>
            <div class="no-print">
                <div>
                    <p style="margin: 0; font-weight: bold;">‚úÖ ARQUIVO SINCRONIZADO</p>
                    <p style="margin: 0; font-size: 10px;">As marca√ß√µes s√£o salvas automaticamente.</p>
                </div>
                <div class="controls">
                    <label style="font-size: 10px; font-weight: bold;">ORDENAR POR:</label>
                    <select id="sort-select" onchange="reordenarTabela()">
                        <option value="os">N¬∫ DA O.S.</option>
                        <option value="data">DATA DO EXAME</option>
                    </select>
                    <button onclick="window.print()" style="padding:10px 20px; background:#5d8233; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">üñ®Ô∏è IMPRIMIR</button>
                </div>
            </div>

            <div class="main-title">CONTROLE DE O.S.'s - ${tituloData}</div>
            <table>
                <thead>
                    <tr>
                        <th width="35">ITEM</th><th width="60">O.S. CLIENTE</th><th width="85">DATA DO EXAME</th>
                        <th>CLIENTE</th><th>LENTE PEDIDA</th><th width="65">LENTE PAGA</th>
                        <th width="75">RECEBIDO LABORAT.</th><th width="75">ENTREGUE CLIENTES</th>
                        <th width="90">DATA DA ENTREGA</th>
                    </tr>
                </thead>
                <tbody id="corpo-tabela">${linhasTabela}</tbody>
                <tfoot>
                    <tr class="footer-blue">
                        <td colspan="5" style="text-align:right; padding-right:10px;">TOTAL DE CADASTRADOS NO SISTEMA</td>
                        <td class="center" id="resumo-paga">0</td><td class="center" id="resumo-lab">0</td>
                        <td class="center" id="resumo-entregue">0</td><td class="center">---</td>
                    </tr>
                    <tr class="total-box">
                        <td colspan="7" style="text-align:center;">TOTAL PAGO (CUSTO)</td>
                        <td colspan="2" style="text-align:right; color:#2e75b6; padding-right:10px;" id="display-pago">R$ 0,00</td>
                    </tr>
                    <tr class="total-box">
                        <td colspan="7" style="text-align:center;">FALTA PAGAR (CUSTO)</td>
                        <td colspan="2" style="text-align:right; color:red; padding-right:10px;" id="display-falta">R$ 0,00</td>
                    </tr>
                </tfoot>
            </table>

            <script>
                function reordenarTabela() {
                    const criterio = document.getElementById('sort-select').value;
                    const tbody = document.getElementById('corpo-tabela');
                    const rows = Array.from(tbody.querySelectorAll('.row-item'));

                    rows.sort((a, b) => {
                        if (criterio === 'os') {
                            const valA = parseInt(a.getAttribute('data-os')) || 0;
                            const valB = parseInt(b.getAttribute('data-os')) || 0;
                            return valA - valB;
                        } else {
                            const valA = a.getAttribute('data-exame');
                            const valB = b.getAttribute('data-exame');
                            return valA.localeCompare(valB);
                        }
                    });

                    rows.forEach((row, index) => {
                        row.querySelector('.col-index').innerText = (index + 1).toString().padStart(2, '0');
                        tbody.appendChild(row);
                    });
                }

                function salvarNoBanco(id, campo, valor, dataEntrega = null) {
                    if(window.opener && window.opener.updateOSStatus) {
                        window.opener.updateOSStatus(id, campo, valor, dataEntrega);
                    }
                    atualizarRelatorio();
                }

                function gerenciarEntrega(id, marcado, idElemento) {
                    const celulaData = document.getElementById('dt-' + idElemento);
                    const hoje = marcado ? new Date().toLocaleDateString('pt-BR') : "---";
                    celulaData.innerText = hoje;
                    salvarNoBanco(id, 'dataOS_entregue', marcado, hoje);
                }

                function atualizarRelatorio() {
                    let totalPago = 0, totalFalta = 0, countPaga = 0, countLab = 0, countEntregue = 0;
                    const linhas = document.querySelectorAll('.row-item');
                    linhas.forEach(linha => {
                        const custo = parseFloat(linha.getAttribute('data-custo')) || 0;
                        const chkPaga = linha.querySelector('.chk-paga').checked;
                        const chkLab = linha.querySelector('.chk-lab').checked;
                        const chkEntregue = linha.querySelector('.chk-entregue').checked;
                        if (chkPaga) { totalPago += custo; countPaga++; } else { totalFalta += custo; }
                        if (chkLab) countLab++;
                        if (chkEntregue) countEntregue++;
                    });
                    document.getElementById('resumo-paga').innerText = countPaga;
                    document.getElementById('resumo-lab').innerText = countLab;
                    document.getElementById('resumo-entregue').innerText = countEntregue;
                    document.getElementById('display-pago').innerText = "R$ " + totalPago.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                    document.getElementById('display-falta').innerText = "R$ " + totalFalta.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                }

                window.onload = () => {
                    reordenarTabela(); // Aplica a ordem inicial (O.S.)
                    atualizarRelatorio();
                };
            <\/script>
        </body>
        </html>
    `);
    win.document.close();
};





// MODAL DE ESCOLHA ATUALIZADO
const abrirModalEscolhaRelatorio = (stats, detailedList, viewMode, selectedDate, settings, allData) => {
    const modalId = 'modal-print-choice';
    if(document.getElementById(modalId)) document.getElementById(modalId).remove();

    const modalHtml = `
        <div id="${modalId}" style="position:fixed; inset:0; background:rgba(0,0,0,0.9); display:flex; align-items:center; justify-content:center; z-index:9999; font-family:sans-serif;">
            <div style="background:#111; border:1px solid #00f2ff; padding:30px; border-radius:20px; text-align:center; max-width:350px; width:90%; box-shadow: 0 0 30px rgba(0,242,255,0.3);">
                <h3 style="color:#00f2ff; margin-bottom:10px; font-size:16px; font-family:'Orbitron', sans-serif;">IMPRIMIR RELAT√ìRIO</h3>
                <p style="color:#ccc; font-size:12px; margin-bottom:25px;">Selecione o formato de impress√£o:</p>
                <div style="display:grid; gap:12px;">
                    <button id="rel-btn-simples" style="background:#00f2ff; color:#000; border:none; padding:15px; border-radius:10px; font-weight:bold; cursor:pointer; text-transform:uppercase; font-size:11px;">üìä Resumo de Caixa</button>
                    <button id="rel-btn-detalhado" style="background:#7000ff; color:#fff; border:none; padding:15px; border-radius:10px; font-weight:bold; cursor:pointer; text-transform:uppercase; font-size:11px;">üìã Lista de Clientes</button>
                    <button id="rel-btn-os" style="background:#5d8233; color:#fff; border:none; padding:15px; border-radius:10px; font-weight:bold; cursor:pointer; text-transform:uppercase; font-size:11px;">üëì Controle de O.S.</button>
                    <button id="rel-btn-close" style="background:transparent; color:#666; border:1px solid #333; padding:10px; border-radius:10px; cursor:pointer; font-size:10px; margin-top:10px;">CANCELAR</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    document.getElementById('rel-btn-simples').onclick = () => {
        imprimirRelatorioFinanceiro(stats, viewMode, selectedDate, settings);
        document.getElementById(modalId).remove();
    };
    document.getElementById('rel-btn-detalhado').onclick = () => {
        imprimirRelatorioDetalhado(stats, detailedList, viewMode, selectedDate, settings);
        document.getElementById(modalId).remove();
    };
    document.getElementById('rel-btn-os').onclick = () => {
        // Corre√ß√£o: Agora passa 'allData' corretamente
        imprimirControleOS(allData, viewMode, selectedDate, settings);
        document.getElementById(modalId).remove();
    };
    document.getElementById('rel-btn-close').onclick = () => document.getElementById(modalId).remove();
};







const App = () => {
    // 1. ESTADOS DO SISTEMA
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);
    const [view, setView] = useState('dashboard');
    const [menuOpen, setMenuOpen] = useState(false);
    const [listResetKey, setListResetKey] = useState(0);
    const [sourceId, setSourceId] = useState(null);
    const [isBlocked, setIsBlocked] = useState(false);
    const [extClientId, setExtClientId] = useState(null);
    const [extEditId, setExtEditId] = useState(null);
    const [data, setData] = useState({ 
        products: [], clients: [], installments: [], sales: [], templates: [], settings: null 
    });

    // 2. REFER√äNCIA PARA GERENCIAR OS OUVINTES (LISTENERS)
    const activeListeners = useRef([]);

    // 3. FUN√á√ÉO PARA DESLIGAR TODAS AS CONEX√ïES COM O BANCO
    const stopAllListeners = () => {
        activeListeners.current.forEach(unsub => {
            if (typeof unsub === 'function') unsub();
        });
        activeListeners.current = [];
    };

    // 4. FUN√á√ÉO PARA CARREGAR OS DADOS (PRODUTOS, CLIENTES, VENDAS)
    const startDataFetch = (idParaBusca) => {
        // Evita duplicar conex√µes
        if (activeListeners.current.length > 1) return;

        const q = (col) => db.collection(col).where("userId", "==", idParaBusca);
        
        const handleSnapError = (error) => {
            if (error.code === 'permission-denied') {
                console.warn("Acesso suspenso por regras de seguran√ßa (Inadimpl√™ncia).");
                stopAllListeners(); 
            } else {
                console.error("Erro no Firestore:", error);
            }
        };

        const setupListener = (colName, stateKey) => {
            const unsub = q(colName).onSnapshot(
                s => setData(p => ({ ...p, [stateKey]: s.docs.map(d => ({id: d.id, ...d.data()})) })),
                handleSnapError
            );
            activeListeners.current.push(unsub);
        };

        setupListener("products", "products");
        setupListener("clients", "clients");
        setupListener("installments", "installments");
        setupListener("sales", "sales");
        setupListener("templates", "templates");
    };

    // 5. MONITOR DE LOGIN E BLOQUEIO DE ALUGUEL
    useEffect(() => {
        const unsubscribeAuth = auth.onAuthStateChanged(async (u) => {
            if(u) {
                try {
                    // Busca dados do usu√°rio logado
                    const userDoc = await db.collection("usuarios").doc(u.uid).get();
                    
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        const idDoDono = userData.ownerId || u.uid;
                        setSourceId(idDoDono);
                        window.userPermissions = userData;

                        // Monitora o status de pagamento (BLOQUEIO) no documento do Dono
                        const unsubSettings = db.collection("settings").doc(idDoDono).onSnapshot(doc => {
                            if (doc.exists) {
                                const config = doc.data();


        // --- ADICIONE ESTA LINHA ABAIXO ---
        if (config.logo) {
            localStorage.setItem('otica_logo_cache', config.logo);
        }
        // ----------------------------------

        const hoje = new Date();
        const validade = config.validade?.toDate ? config.validade.toDate() : new Date(config.validade);
        const bloqueado = config.status === "bloqueado" || (validade && hoje > validade);

        if (bloqueado) {
            setIsBlocked(true);
            stopAllListeners(); 
        } else {
            setIsBlocked(false);
            startDataFetch(idDoDono); 
        }
        setData(prev => ({ ...prev, settings: config }));
    }
}, err => {
    if(err.code !== 'permission-denied') console.error("Erro Settings:", err);
});





                        activeListeners.current.push(unsubSettings);
                    }
                } catch (e) {
                    console.error("Erro de acesso:", e);
                }
            } else {
                stopAllListeners();
                setSourceId(null);
                setIsBlocked(false);
            }
            setUser(u);
            setLoading(false);
        });

        return () => {
            unsubscribeAuth();
            stopAllListeners();
        };
    }, []);

    // 6. TRAVAS DE TELA ANTES DE RENDERIZAR O SISTEMA
    if (loading) return <div className="h-screen bg-[#020617] flex items-center justify-center text-cyan-500 font-cyber italic animate-pulse">CARREGANDO SISTEMA...</div>;
    
    if (!user) return <AuthScreen auth={auth} />;

    if (isBlocked) {
        return (
            <div className="h-screen bg-[#020617] flex items-center justify-center p-6 text-center font-bold italic uppercase">
                <div className="glass p-10 rounded-[3rem] border border-red-500/50 max-w-lg shadow-[0_0_50px_rgba(239,68,68,0.2)]">
                    <div className="text-red-500 mb-6 flex justify-center">
                        <Icon name="shield-alert" size={64} />
                    </div>
                    <h1 className="font-cyber text-2xl text-white mb-4 italic">ACESSO SUSPENSO</h1>
                    <p className="text-gray-400 text-[10px] mb-8 tracking-widest leading-relaxed">
                        Sua licen√ßa de uso expirou ou foi suspensa. <br/>
                        Para regularizar seu acesso e n√£o perder seus dados, entre em contato com o suporte financeiro.
                    </p>
                    <a href="https://wa.me/5597991632841" target="_blank" className="btn-cyber px-8 py-4 rounded-2xl block font-black text-[10px] tracking-widest mb-4 hover:scale-105 transition-all">
                        FALAR COM O FINANCEIRO
                    </a>
                    <button onClick={() => auth.signOut()} className="text-gray-600 text-[9px] underline hover:text-white transition-all">SAIR DO SISTEMA</button>
                </div>
            </div>
        );
    }

    // Itens do menu baseados em permiss√µes
    const menuItems = [
        {id: 'dashboard', icon: 'layout-dashboard', label: 'In√≠cio', hide: window.userPermissions?.hideDashboard},
        {id: 'produtos', icon: 'package', label: 'Produto', hide: window.userPermissions?.hideProducts},
        {id: 'clientes', icon: 'user-plus', label: 'Cliente', hide: window.userPermissions?.hideClients},
        {id: 'vendas', icon: 'shopping-cart', label: 'Venda', hide: window.userPermissions?.lockSales},
        {id: 'lista_clientes', icon: 'users', label: 'Lista de Clientes', hide: window.userPermissions?.hideClientList},
        {id: 'templates', icon: 'message-square', label: 'Mensagens', hide: window.userPermissions?.hideTemplates},
        {id: 'relatorios', icon: 'bar-chart-2', label: 'Relat√≥rios', hide: window.userPermissions?.hideReports},
        {id: 'configuracoes', icon: 'settings', label: 'Configura√ß√µes', hide: window.userPermissions?.hideConfig}
    ].filter(item => !item.hide);




// L√≥gica para calcular dias restantes da licen√ßa
const calculateDaysLeft = () => {
    if (!data.settings?.validade) return null;
    
    // Converte a data do Firebase ou String para objeto Date
    const validade = data.settings.validade.toDate 
        ? data.settings.validade.toDate() 
        : new Date(data.settings.validade);
    
    const hoje = new Date();
    
    // Calcula a diferen√ßa em milissegundos e converte para dias
    const diffTime = validade - hoje;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    return diffDays;
};

const daysLeft = calculateDaysLeft();







    return (
        <div className="h-[100dvh] flex flex-col md:flex-row text-sm italic font-bold overflow-hidden bg-[#020617]">


<div className="md:hidden glass p-4 flex justify-between items-center z-[100]">
    <div className="flex items-center">
        {data.settings?.logo ? (
            <img src={data.settings.logo} className="max-h-10 w-auto object-contain" />
        ) : (
            <div className="font-cyber text-xs text-cyan-400 italic">√ìTICA <span className="text-purple-500">ILUMINAR</span></div>
        )}
    </div>
    <button onClick={() => setMenuOpen(!menuOpen)} className="p-2 text-cyan-400"><Icon name={menuOpen ? "x" : "menu"} /></button>
</div>



<nav className={`fixed md:static inset-y-0 left-0 w-72 glass border-r border-cyan-900/30 p-6 flex flex-col z-[150] transition-transform ${menuOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 pt-20 md:pt-6`}>
    
    {/* BOT√ÉO FECHAR (X) DENTRO DO MENU NO MOBILE */}
    <button 
        onClick={() => setMenuOpen(false)} 
        className="md:hidden absolute top-4 right-4 text-cyan-400 p-2"
    >
        <Icon name="x" size={24} />
    </button>

    {/* √ÅREA DA LOGO - APARECE PARA TODOS (No desktop centralizado, no mobile com ajuste) */}
    <div className="hidden md:flex mb-8 mt-2 flex-col items-center shrink-0">
        {data.settings?.logo ? (
            <img src={data.settings.logo} className="max-h-24 w-auto object-contain" />
        ) : (
            <div className="text-center font-cyber text-2xl text-cyan-400 italic">
                √ìTICA<span className="text-purple-500 font-bold">ILUMINAR</span>
            </div>
        )}
    </div>




                <div className="flex-1 overflow-y-auto">
{menuItems.map(item => (
    <button key={item.id} 
        onClick={() => { 
            // NOVA L√ìGICA AQUI:
            if (item.id === 'lista_clientes') {
                setExtClientId(null); // Limpa qualquer ID vindo do dashboard
                setExtEditId(null);   // Limpa qualquer edi√ß√£o pendente
                setListResetKey(prev => prev + 1); // Incrementa a chave para resetar o componente
            }
            setView(item.id); 
            setMenuOpen(false); 
        }}
        className={`flex items-center gap-4 w-full p-4 rounded-xl mb-2 ${view === item.id ? 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/50' : 'text-gray-400'}`}>
        <Icon name={item.icon} size={18} /> 
        <span className="text-[10px] uppercase">{item.label}</span>
    </button>
))}


                </div>
                <button onClick={() => auth.signOut()} className="p-4 text-red-500 flex items-center gap-4 hover:bg-red-500/10 rounded-xl transition-all"><Icon name="log-out" /> SAIR</button>
                
<div className="mt-auto pt-4 border-t border-white/5 px-4 mb-2">
                    <p className="text-[10px] text-cyan-400 font-cyber truncate italic">
                        {user?.email ? user.email.split('@')[0].toUpperCase() : 'USU√ÅRIO'}
                    </p>
                    <p className="text-[8px] text-gray-500 uppercase tracking-widest font-bold">
                        {window.userPermissions?.isAdmin ? 'üõ°Ô∏è Administrador' : 'üë§ Operador'}
                    </p>


    {/* EXIBI√á√ÉO DA VALIDADE DO SISTEMA */}
    {daysLeft !== null && (
        <p className={`text-[12px] font-black uppercase mt-2 tracking-tighter ${
            daysLeft <= 10 
            ? 'text-red-500 animate-pulse border-t border-red-500/20 pt-1' 
            : 'text-gray-500'
        }`}>
            {daysLeft > 0 
                ? `SISTEMA EXPIRA EM: ${daysLeft} DIAS` 
                : daysLeft === 0 
                    ? "SISTEMA EXPIRA HOJE!" 
                    : "SISTEMA EXPIRADO"}
        </p>
    )}




                </div>
            </nav>






<main className="flex-1 p-4 md:p-8 overflow-y-auto w-full no-print">
    <div className="max-w-7xl mx-auto">
        {view === 'dashboard' && <Dashboard data={data} onClientClick={(id) => { setExtClientId(id); setView('lista_clientes'); }} />}
        
        {/* TODOS OS M√ìDULOS ABAIXO DEVEM USAR uid={sourceId} */}
        {view === 'produtos' && <ProductsModule products={data.products} uid={sourceId} />}
        {view === 'clientes' && <ClientsModule uid={sourceId} clients={data.clients} editId={extEditId} onDone={() => setView('lista_clientes')} data={data} />}






{view === 'vendas' && (
    <SalesModule 
        data={data} 
        uid={sourceId} 
        onSaleFinish={(d) => { 
            // 1¬∫ - RECIBO (In√≠cio imediato)
            const vTotal = parseFloat(d.sale.total);
            const vEntry = parseFloat(d.sale.entry || 0);

            if (vEntry >= vTotal) {
                // Venda √† Vista: Recibo de Quita√ß√£o Total
                imprimirReciboVenda(
                    d.client, 
                    vTotal, 
                    d.sale.entryDat, 
                    d.sale.entryMet, 
                    data.settings, 
                    `QUITA√á√ÉO TOTAL DA VENDA - ITENS: ${d.sale.items.join(' + ')}`
                );
            } else if (vEntry > 0) {
                // Venda Parcelada: Recibo apenas da Entrada
                imprimirReciboVenda(
                    d.client, 
                    vEntry, 
                    d.sale.entryDat, 
                    d.sale.entryMet, 
                    data.settings, 
                    "PAGAMENTO DE ENTRADA / SINAL DE NEG√ìCIO"
                );
            }

            // 2¬∫ - CAPA DO CARN√ä (Aparece ap√≥s 0.6 segundos)
            setTimeout(() => {
                gerarCapaPDF(d, data.settings);
            }, 600);

            // 3¬∫ - CARN√ä (Aparece ap√≥s 1.2 segundos)
            setTimeout(() => {
                if (d.installments && d.installments.length > 0) {
                    gerarCarnePDF(d, data.settings);
                }
            }, 1200);

            // 4¬∫ - OS / ORDEM DE SERVI√áO (Aparece ap√≥s 1.8 segundos)
            setTimeout(() => {
                imprimirOS(d.client, d.sale, data);
            }, 1800);

            // 5¬∫ - CONTRATO (Aparece ap√≥s 2.4 segundos)
            setTimeout(() => {
                imprimirContrato(d.client, d.sale, d.installments, data.settings);
            }, 2400);
        }} 
    />
)}





        
        {view === 'templates' && <TemplatesModule templates={data.templates} uid={sourceId} />}
        {view === 'configuracoes' && <SettingsModule uid={sourceId} />}
        
        {/* LISTA DE CLIENTES APENAS L√ä OS DADOS */}
        {view === 'lista_clientes' && <ClientListView key={listResetKey} data={data} initialId={extClientId} onEdit={(id) => { setExtEditId(id); setView('clientes'); }} onCarne={(d) => gerarCarnePDF(d, data.settings)} />}
        {view === 'relatorios' && <ReportsModule data={data} />}
    </div>
</main>


        </div>
    );
};








const AuthScreen = ({ auth }) => {
    const [mousePos, setMousePos] = useState({ x: 0, y: 0, rawX: 0, rawY: 0 });
    const [isNeutralized, setIsNeutralized] = useState(false);
    
    // 1. Criamos a refer√™ncia para o input de e-mail
    const emailInputRef = useRef(null);

    // 2. Efeito para dar foco assim que a tela abre
    useEffect(() => {
        if (emailInputRef.current) {
            emailInputRef.current.focus();
        }
    }, []);

    const login = async (e) => {
        e.preventDefault();
        try { 
            await auth.signInWithEmailAndPassword(e.target.email.value, e.target.password.value); 
        } catch (err) { 
            alert("ACESSO NEGADO: Chave de seguran√ßa ou identifica√ß√£o inv√°lida."); 
        }
    };

    useEffect(() => {
        const handleMouseMove = (e) => {
            const { clientX, clientY } = e;
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            const x = (clientX - centerX) / centerX;
            const y = (clientY - centerY) / centerY;
            setMousePos({ x, y, rawX: clientX, rawY: clientY });

            const cardElement = document.querySelector('.eye-region');
            if (cardElement) {
                const rect = cardElement.getBoundingClientRect();
                const eyeCenterX = rect.left + rect.width / 2;
                if (Math.abs(clientX - eyeCenterX) < 15) {
                    setIsNeutralized(true);
                } else {
                    setIsNeutralized(false);
                }
            }
        };
        window.addEventListener("mousemove", handleMouseMove);
        return () => window.removeEventListener("mousemove", handleMouseMove);
    }, []);

    return (
        <div className="auth-screen neural-container">
            <style>{`
                .neural-container { position: fixed; inset: 0; background: radial-gradient(circle at center, #050a15 0%, #000 100%); display: flex; align-items: center; justify-content: center; z-index: 9999; cursor: none; }
                .retinoscope-streak { position: fixed; width: 2px; height: 100vh; background: linear-gradient(to bottom, transparent, #00f2ff, #fff, #00f2ff, transparent); box-shadow: 0 0 15px #00f2ff; pointer-events: none; z-index: 100; opacity: 0.8; }
                .streak-flare { position: fixed; width: 40px; height: 120px; background: radial-gradient(ellipse, rgba(0, 242, 255, 0.15) 0%, transparent 70%); pointer-events: none; z-index: 99; transform: translate(-50%, -50%); }
                .retino-card { background: rgba(5, 5, 10, 0.95); border: 1px solid rgba(0, 242, 255, 0.1); border-radius: 60px; padding: 50px; width: 100%; max-width: 440px; backdrop-filter: blur(30px); text-align: center; }
                .eye-region { width: 240px; height: 140px; margin: 0 auto 30px; position: relative; background: #0a0a12; border-radius: 50%; overflow: hidden; box-shadow: inset 0 0 40px #000; border: 1px solid rgba(255,255,255,0.05); }
                .cyber-input { background: rgba(0, 0, 0, 0.8) !important; border: 1px solid rgba(0, 242, 255, 0.1) !important; border-radius: 15px !important; color: white !important; font-size: 14px !important; letter-spacing: 2px; margin-bottom: 15px; text-align: center; }
                .btn-auth-elite { background: white; color: black; padding: 18px; border-radius: 15px; width: 100%; font-family: 'Orbitron', sans-serif; font-size: 11px; font-weight: 900; letter-spacing: 4px; cursor: pointer; transition: 0.4s; border: none; margin-top: 10px; }
                .btn-auth-elite:hover { box-shadow: 0 0 30px #00f2ff; letter-spacing: 6px; }
            `}</style>

            <div className="retinoscope-streak" style={{ left: mousePos.rawX }}></div>
            <div className="streak-flare" style={{ left: mousePos.rawX, top: mousePos.rawY }}></div>

            <div className="retino-card">
                <div className="eye-region">
                    <svg viewBox="0 0 120 80" width="100%" height="100%">
                        <defs>
                            <radialGradient id="skinGradient" cx="50%" cy="50%" r="50%">
                                <stop offset="0%" stopColor="#1a1a2e" />
                                <stop offset="100%" stopColor="#05050a" />
                            </radialGradient>
                            <radialGradient id="reflexGradient">
                                <stop offset="0%" stopColor="#ff9d00" />
                                <stop offset="70%" stopColor="#ff4500" />
                                <stop offset="100%" stopColor="#000" />
                            </radialGradient>
                            <radialGradient id="irisGradient" cx="50%" cy="50%" r="50%">
                                <stop offset="20%" stopColor="#00ff88" />
                                <stop offset="60%" stopColor="#0066ff" />
                                <stop offset="100%" stopColor="#001a33" />
                            </radialGradient>
                        </defs>
                        <rect width="120" height="80" fill="url(#skinGradient)" />
                        <path d="M10 40 Q60 5 110 40 Q60 75 10 40" fill="#000" />
                        <g>
                            <path fill="#e8e8e8" d="M10 40 Q60 5 110 40 Q60 75 10 40" />
                            <g style={{ transform: `translate(${mousePos.x * 14}px, ${mousePos.y * 8}px)` }}>
                                <circle cx="60" cy="40" r="18" fill="url(#irisGradient)" />
                                <circle cx="60" cy="40" r="17.5" fill="none" stroke="#ffffff" strokeWidth="0.1" opacity="0.3" />
                                <circle cx="60" cy="40" r="8" fill="#000" />
                                {isNeutralized && (
                                    <circle cx="60" cy="40" r="8" fill="url(#reflexGradient)">
                                        <animate attributeName="r" values="7;8.5;7" dur="1s" repeatCount="indefinite" />
                                    </circle>
                                )}
                                <ellipse cx="56" cy="35" rx="3" ry="5" fill="#fff" opacity="0.2" transform="rotate(-20 56 35)" />
                            </g>
                        </g>
                        <path fill="none" stroke="rgba(0,0,0,0.8)" strokeWidth="2" d="M10 40 Q60 5 110 40" />
                        <path fill="none" stroke="rgba(0,0,0,0.8)" strokeWidth="2" d="M10 40 Q60 75 110 40" />
                    </svg>
                </div>

                <div className="text-center mb-10">
                    <h1 className="font-cyber text-3xl text-white tracking-tighter uppercase italic">
                        √ìtica <span className="text-cyan-400">Iluminar</span>
                    </h1>
                    <p className="text-[10px] tracking-[0.5em] text-gray-600 uppercase mt-4 font-black">
                        Trazendo luz para seus olhos
                    </p>
                </div>

                <form onSubmit={login} className="flex flex-col">
                    <input 
                        ref={emailInputRef}
                        name="email"
                        type="email" 
                        placeholder="IDENTIFICA√á√ÉO NEURAL" 
                        className="cyber-input p-5 w-full outline-none"
                        required
                    />
                    <input 
                        name="password"
                        type="password" 
                        placeholder="CHAVE √ìPTICA" 
                        className="cyber-input p-5 w-full outline-none"
                        required
                    />

                    <button type="submit" className="btn-auth-elite">
                        {isNeutralized ? "RECONHECIMENTO OK" : "FOQUE NA LUZ"}
                    </button>
                </form>

                <div className="mt-8 flex justify-between items-center text-[7px] text-cyan-900 font-bold tracking-widest uppercase">
                    <span>Diagnostic Mode: active</span>
                    <span className={isNeutralized ? 'text-orange-500' : ''}>
                        {isNeutralized ? 'Reflex Found' : 'Searching...'}
                    </span>
                </div>
            </div>
        </div>
    );
};






const Dashboard = ({ data, onClientClick }) => {
    // Pegamos os totais com seguran√ßa
    const totalProdutosNoEstado = data.products ? data.products.length : 0;
    const totalClientesNoEstado = data.clients ? data.clients.length : 0;

    const [searchTerm, setSearchTerm] = useState("");
    const [showTemplatePicker, setShowTemplatePicker] = useState(false);
    const [selectedData, setSelectedData] = useState(null);

    const today = new Date().toISOString().split('T')[0];
    
    const filterInstallments = (list) => {
        return list.filter(i => {
            const searchLower = searchTerm.toLowerCase();
            const clientObj = data.clients.find(cl => cl.nome === i.clientName);
            const cpfLimpo = clientObj ? clientObj.cpf.replace(/\D/g, "") : "";
            const searchLimpo = searchLower.replace(/\D/g, "");
            const bateNome = i.clientName.toLowerCase().includes(searchLower);
            const bateCpf = searchLimpo !== "" && cpfLimpo.includes(searchLimpo);
            return bateNome || bateCpf;
        });
    };




// Filtra apenas parcelas pendentes que tenham valor maior que zero E cujo cliente exista na base
    const pending = data.installments.filter(i => {
        const clienteExiste = data.clients.some(cl => cl.nome.trim().toUpperCase() === i.clientName.trim().toUpperCase());
        const temValor = i.amount > 0;
        return i.status === 'pendente' && temValor && clienteExiste;
    });

    const baseHoje = pending.filter(i => i.dueDate === today);
    const baseAtrasados = pending.filter(i => i.dueDate <= today).sort((a, b) => a.dueDate.localeCompare(b.dueDate));



    const hojeList = filterInstallments(baseHoje);
    const atrasadosList = filterInstallments(baseAtrasados);



// C√°lculo de aniversariantes do dia
    const bdayHojeList = data.clients.filter(c => {
        if (!c.nascimento) return false;
        const [ano, mes, dia] = c.nascimento.split('-').map(Number);
        const hoje = new Date();
        return (hoje.getMonth() + 1 === mes && hoje.getDate() === dia);
    });



    const handleNavigation = (clientName) => {
        const client = data.clients.find(cl => cl.nome === clientName);
        if (client) onClientClick(client.id);
        else alert("Cliente n√£o encontrado.");
    };

    const abrirMensagem = (e, parcela) => {
        e.stopPropagation(); 
        const cliente = data.clients.find(c => c.nome === parcela.clientName);
        if (!cliente) return alert("Erro: Cadastro do cliente n√£o localizado.");
        if (!cliente.tel) return alert("Erro: Cliente n√£o possui telefone cadastrado.");
        
        setSelectedData({ cliente, parcela });
        setShowTemplatePicker(true);
    };



const abrirMensagemAniversario = (e, cliente) => {
        e.stopPropagation(); 
        if (!cliente.tel) return alert("Erro: Cliente n√£o possui telefone cadastrado.");
        setSelectedData({ cliente, parcela: null });
        setShowTemplatePicker(true);
    };




const dispararMensagem = (template) => {
        const { cliente, parcela } = selectedData;
        const nomeClinica = data.settings?.nomeClinica || "√ìTICA ILUMINAR";
        let msg = template.texto;

        if (parcela) {
            const hoje = new Date().toISOString().split('T')[0];
            const parcelasVencidas = data.installments.filter(inst => 
                inst.clientName.trim().toUpperCase() === cliente.nome.trim().toUpperCase() && 
                inst.status === 'pendente' && inst.dueDate <= hoje
            ).sort((a, b) => a.dueDate.localeCompare(b.dueDate));

            let valorTotalVencido = 0;
            let listaDatas = "";
            parcelasVencidas.forEach((p) => {
                valorTotalVencido += p.amount;
                listaDatas += `\n‚Ä¢ Vencimento: ${p.dueDate.split('-').reverse().join('/')} - Valor: R$ ${p.amount.toFixed(2)}`;
            });

            msg = msg.replace(/{{nome}}/g, cliente.nome)
                     .replace(/{{clinica}}/g, nomeClinica)
                     .replace(/{{valor}}/g, `R$ ${valorTotalVencido.toFixed(2)}`)
                     .replace(/{{vencimento}}/g, listaDatas);
        } else {
            msg = msg.replace(/{{nome}}/g, cliente.nome)
                     .replace(/{{clinica}}/g, nomeClinica)
                     .replace(/{{valor}}/g, "")
                     .replace(/{{vencimento}}/g, "");
        }

        const fone = `55${cliente.tel.replace(/\D/g, '')}`;
        window.open(`https://wa.me/${fone}?text=${encodeURIComponent(msg)}`, '_blank');
        setShowTemplatePicker(false);
    };





return (
        <div className="space-y-8 animate-in slide-in-from-bottom-4">
            







            {/* MODAL DE SELE√á√ÉO DE TEMPLATE */}
            {showTemplatePicker && (
                <div className="fixed inset-0 bg-black/90 z-[500] flex items-center justify-center p-4 no-print">
                    <div className="glass p-8 rounded-3xl border border-cyan-500/30 max-w-sm w-full">
                        <h3 className="font-cyber text-cyan-400 text-xs mb-6 text-center italic">SELECIONAR MODELO DE COBRAN√áA</h3>
                        <div className="space-y-3 max-h-80 overflow-y-auto pr-2">
                            {data.templates.length > 0 ? data.templates.map(t => (
                                <button key={t.id} onClick={() => dispararMensagem(t)} 
                                    className="w-full p-4 bg-white/5 hover:bg-green-500 hover:text-black rounded-xl text-left text-[10px] border border-white/5 transition-all uppercase font-bold">
                                    {t.titulo}
                                </button>
                            )) : <p className="text-[10px] text-center text-gray-500">Nenhum modelo cadastrado.</p>}
                        </div>
                        <button onClick={() => setShowTemplatePicker(false)} className="w-full mt-6 text-red-500 text-[10px] font-bold uppercase">FECHAR</button>
                    </div>
                </div>
            )}

<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                <div className="glass p-8 rounded-3xl border-l-4 border-cyan-500"><p className="text-[10px] text-gray-500 uppercase mb-2">Clientes</p><p className="text-4xl font-mono text-white">{data.clients.length}</p></div>
                <div className="glass p-8 rounded-3xl border-l-4 border-purple-500"><p className="text-[10px] text-gray-500 uppercase mb-2">Vendas</p><p className="text-4xl font-mono text-white">{data.sales.length}</p></div>
                <div className="glass p-8 rounded-3xl border-l-4 border-yellow-500 text-yellow-500"><p className="text-[10px] uppercase mb-2">Hoje</p><p className="text-4xl font-mono">{baseHoje.length}</p></div>
                <div className="glass p-8 rounded-3xl border-l-4 border-red-500 text-red-500"><p className="text-[10px] uppercase mb-2">Atrasados</p><p className="text-4xl font-mono">{baseAtrasados.length}</p></div>
                {/* CARD NOVO */}
                <div className="glass p-8 rounded-3xl border-l-4 border-red-600 text-red-600 animate-pulse"><p className="text-[10px] uppercase mb-2">Anivers√°rios</p><p className="text-4xl font-mono">{bdayHojeList.length}</p></div>


            </div>

            <div className="glass p-4 rounded-2xl border border-cyan-500/30">
                <div className="relative">
                    <span className="absolute inset-y-0 left-0 pl-3 flex items-center text-cyan-500"><Icon name="search" size={18} /></span>
                    <input 
                        type="text" 
                        placeholder="PESQUISAR PARCELA POR NOME OU CPF DO CLIENTE..." 
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        className="w-full pl-10 !bg-transparent border-none !text-lg font-cyber tracking-widest placeholder:text-gray-600 focus:ring-0"
                    />
                </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 italic uppercase">
                {/* VENCIMENTO HOJE */}
                <div className="glass p-3 rounded-3xl">
                    <h3 className="font-cyber text-[14px] text-yellow-500 mb-6 font-bold tracking-widest italic flex items-center gap-2">
                        <Icon name="calendar" size={14}/> Vencimento Hoje
                    </h3>
                    <div className="max-h-[500px] overflow-y-auto pr-2 space-y-2">
                        {hojeList.map(i => (




<div key={i.id} onClick={() => handleNavigation(i.clientName)} className="w-full text-left p-4 bg-white/5 hover:bg-yellow-500/10 rounded-xl border border-white/5 transition-colors cursor-pointer group">
    <div className="flex flex-col items-start w-full">
        <div className="flex items-center gap-2 mb-2 w-full">
            <button 
                onClick={(e) => { e.stopPropagation(); abrirMensagem(e, i); }} 
                className="p-1.5 bg-green-500/20 text-green-500 rounded-lg hover:bg-green-500 hover:text-black transition-all shrink-0"
            >
                <Icon name="message-circle" size={12} />
            </button>
            <span className="block group-hover:text-yellow-500 text-[10px] uppercase truncate">{i.clientName}</span>
        </div>
        <div className="flex justify-between items-center w-full text-[10px] uppercase font-bold">
            <span className="text-gray-500">PARCELA: {i.number}</span>
            <span className="text-white font-mono text-[11px]">R$ {i.amount.toFixed(2)}</span>
        </div>
    </div>
</div>
))}
                    </div>
                </div>






                {/* D√âBITOS EM ATRASO */}
                <div className="glass p-3 rounded-3xl">
                    <h3 className="font-cyber text-[14px] text-red-500 mb-6 font-bold tracking-widest italic flex items-center gap-2">
                        <Icon name="alert-circle" size={14}/> D√©bitos em Atraso
                    </h3>
                    <div className="max-h-[500px] overflow-y-auto pr-2 space-y-2">
                        {atrasadosList.map(i => (


<div key={i.id} onClick={() => handleNavigation(i.clientName)} className="w-full text-left p-4 bg-white/5 hover:bg-red-500/10 rounded-xl pulse-red border border-red-500/20 transition-colors cursor-pointer group">
    <div className="flex flex-col items-start w-full">
        <div className="flex items-center gap-2 mb-2 w-full">
            <button 
                onClick={(e) => { e.stopPropagation(); abrirMensagem(e, i); }} 
                className="p-1.5 bg-green-500/20 text-green-500 rounded-lg hover:bg-green-500 hover:text-black transition-all shrink-0"
            >
                <Icon name="message-circle" size={12} />
            </button>
            <span className="block text-white group-hover:text-red-500 text-[10px] uppercase truncate">{i.clientName}</span>
        </div>
        <div className="flex justify-between items-center w-full text-[9px] uppercase font-bold">
            <div className="flex gap-1.5 items-center">
                <span className="bg-red-500/20 text-red-400 px-1 rounded">VENC: {i.dueDate.split('-').reverse().join('/')}</span>
                <span className="bg-white/10 px-1 rounded text-white font-mono">PARC: {i.number}</span>
            </div>
            <span className="text-red-500 font-mono font-bold text-[12px]">R$ {i.amount.toFixed(2)}</span>
        </div>
    </div>
</div>
))}


                    </div>
                </div>



{/* ANIVERSARIANTES DE HOJE */}
                <div className="glass p-3 rounded-3xl border border-red-500/20">
                    <h3 className="font-cyber text-[14px] text-red-600 mb-6 font-bold tracking-widest italic flex items-center gap-2 animate-pulse">
                        <Icon name="cake" size={14}/> Aniversariantes de Hoje
                    </h3>
                    <div className="max-h-[500px] overflow-y-auto pr-2 space-y-2">
                        {bdayHojeList.map(c => (
                            <div key={c.id} onClick={() => onClientClick(c.id)} className="w-full text-left p-4 bg-red-500/10 hover:bg-red-500/20 rounded-xl flex justify-between items-center font-bold text-[11px] border border-red-500/30 transition-colors cursor-pointer group">


<div className="flex items-center gap-4">
    {/* COLUNA DE √çCONES: PRESENTE EM CIMA, MENSAGEM EMBAIXO */}
    <div className="flex flex-col gap-1 items-center">
        <div className="p-1.5 bg-red-500 text-white rounded-lg animate-bounce">
            <Icon name="gift" size={12} />
        </div>
        <button onClick={(e) => abrirMensagemAniversario(e, c)} className="p-1.5 bg-green-500/20 text-green-500 rounded-lg hover:bg-green-500 hover:text-black transition-all z-10">
            <Icon name="message-circle" size={12} />
        </button>
    </div>
    <div>
        <span className="block text-red-600 font-black">{c.nome}</span>
        <span className="text-[12px] text-gray-400">ANIVERSARIANTE DO DIA!</span>
    </div>
</div>


                                <Icon name="chevron-right" size={16} className="text-red-500" />
                            </div>
                        ))}
                        {bdayHojeList.length === 0 && (
                            <p className="text-[10px] text-center text-gray-600 py-10">Nenhum aniversariante hoje.</p>
                        )}
                    </div>
                </div>



            </div>
        </div>
    );
};








const SettingsModule = ({ uid }) => {
    const [loading, setLoading] = useState(true);
    const [editando, setEditando] = useState(false);
    const [activeTab, setActiveTab] = useState('empresa'); 
    
    // Novos estados para o Modal de Senha
    const [showPassModal, setShowPassModal] = useState(false);
    const [confirmPass, setConfirmPass] = useState("");

    const [config, setConfig] = useState({
        nomeClinica: "", slogan: "", cnpj: "", whatsapp: "",
        endereco: "", cidadeUf: "", cep: "", email: "",
        respTecnico: "", profissao: "", registro: "", logo: "",
        pixKey: "", pixName: "", pixCity: "",
        adminPassword: "" 
    });

    useEffect(() => {
        const unsubscribe = db.collection("settings").doc(uid).onSnapshot((doc) => {
            if (doc.exists) {
                const d = doc.data();
                setConfig({
                    ...d,
                    adminPassword: d.adminPassword || "1234" 
                });
            }
            setLoading(false);
        });
        return () => unsubscribe();
    }, [uid]);

    // Fun√ß√µes para o novo Modal
    const handleHabilitar = () => {
        setConfirmPass("");
        setShowPassModal(true);
    };

    const validarAcesso = () => {
        const senhaSalva = config.adminPassword || "1234";
        if (confirmPass === senhaSalva) {
            setEditando(true);
            setShowPassModal(false);
        } else {
            alert("SENHA INCORRETA!");
            setConfirmPass("");
        }
    };

    const handleChange = (e) => {
        const { name, value } = e.target;
        setConfig(prev => ({ ...prev, [name]: value }));
    };

    const handleLogoChange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => setConfig(prev => ({ ...prev, logo: event.target.result }));
        reader.readAsDataURL(file);
    };

    const save = async (e) => {
        e.preventDefault();
        try {
            await db.collection("settings").doc(uid).set(config);
            setEditando(false);
            alert("DADOS SALVOS!");
        } catch (err) { alert("ERRO AO SALVAR"); }
    };

    const fileInputRef = useRef(null);

    if (loading) return <div className="p-20 text-center text-cyan-500 font-cyber">CARREGANDO...</div>;

    return (
        <div className="italic uppercase font-bold text-sm">
            
            {/* NOVO MODAL DE SENHA MASCARADA */}
            {showPassModal && (
                <div className="fixed inset-0 bg-black/90 z-[999] flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="glass p-8 rounded-3xl border border-red-500/50 max-w-xs w-full text-center animate-in zoom-in-95">
                        <div className="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
                            <Icon name="lock" size={30} className="text-red-500" />
                        </div>
                        <h3 className="font-cyber text-white text-[11px] mb-4 tracking-widest">ACESSO RESTRITO</h3>
                        <input 
                            type="password" 
                            autoFocus
                            value={confirmPass} 
                            onChange={e => setConfirmPass(e.target.value)}
                            onKeyDown={e => e.key === 'Enter' && validarAcesso()}
                            className="w-full text-center mb-6 !text-2xl !border-red-500/30 tracking-[0.5em]"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        />
                        <div className="flex gap-2">
                            <button type="button" onClick={validarAcesso} className="flex-1 bg-red-600 text-white p-3 rounded-xl font-black text-[10px] hover:bg-red-500 transition-all">LIBERAR</button>
                            <button type="button" onClick={() => setShowPassModal(false)} className="flex-1 bg-white/10 text-white p-3 rounded-xl font-black text-[10px]">CANCELAR</button>
                        </div>
                    </div>
                </div>
            )}

            <h2 className="font-cyber text-2xl text-white mb-6">PAINEL DE CONFIGURA√á√ïES</h2>
            
<div className="flex gap-2 mb-0">
    <button type="button" onClick={() => setActiveTab('empresa')} className={`px-6 py-3 rounded-t-xl font-cyber text-[10px] ${activeTab === 'empresa' ? 'bg-cyan-500 text-black' : 'bg-white/5 text-gray-400'}`}>
        DADOS DA √ìTICA
    </button>
    <button type="button" onClick={() => setActiveTab('pagamento')} className={`px-6 py-3 rounded-t-xl font-cyber text-[10px] ${activeTab === 'pagamento' ? 'bg-purple-600 text-white' : 'bg-white/5 text-gray-400'}`}>
        DADOS DO PIX
    </button>
    {/* NOVA GUIA USU√ÅRIO ABAIXO */}
    <button type="button" onClick={() => setActiveTab('usuario')} className={`px-6 py-3 rounded-t-xl font-cyber text-[10px] ${activeTab === 'usuario' ? 'bg-orange-500 text-white' : 'bg-white/5 text-gray-400'}`}>
        USU√ÅRIO
    </button>
</div>

            <form onSubmit={save} className="glass p-6 rounded-b-3xl rounded-tr-3xl border-t-2 border-cyan-500/30">



          






                {/* GUIA 1 */}
{activeTab === 'empresa' && (
    <div className="grid grid-cols-1 md:grid-cols-12 gap-6">
        <div className="md:col-span-3 flex flex-col items-center">
            <div className="w-40 h-40 rounded-xl bg-black border border-white/10 flex items-center justify-center overflow-hidden relative">
                {config.logo ? <img src={config.logo} className="w-full h-full object-contain" /> : <div className="text-gray-700 text-[10px]">SEM FOTO</div>}
                {editando && <div onClick={() => fileInputRef.current.click()} className="absolute inset-0 bg-black/60 flex items-center justify-center cursor-pointer text-[10px] text-white">ALTERAR</div>}
            </div>
            <input type="file" ref={fileInputRef} onChange={handleLogoChange} className="hidden" accept="image/*" />
        </div>
        <div className="md:col-span-9 space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="md:col-span-2"><label>Nome Fantasia</label><input name="nomeClinica" value={config.nomeClinica} onChange={handleChange} disabled={!editando} className="w-full" /></div>
                <div className="md:col-span-2"><label>Slogan / Subt√≠tulo</label><input name="slogan" value={config.slogan} onChange={handleChange} disabled={!editando} className="w-full" /></div>
                <div><label>CNPJ / CPF</label><input name="cnpj" value={config.cnpj} onChange={handleChange} disabled={!editando} className="w-full" /></div>
                <div><label>WhatsApp</label><input name="whatsapp" value={config.whatsapp} onChange={handleChange} disabled={!editando} className="w-full" /></div>
                <div className="md:col-span-2"><label>Endere√ßo Completo</label><input name="endereco" value={config.endereco} onChange={handleChange} disabled={!editando} className="w-full" /></div>
                <div><label>Cidade - UF</label><input name="cidadeUf" value={config.cidadeUf} onChange={handleChange} disabled={!editando} className="w-full" /></div>
                <div><label>CEP</label><input name="cep" value={config.cep} onChange={handleChange} disabled={!editando} className="w-full" /></div>
                <div className="md:col-span-2"><label>E-mail</label><input name="email" value={config.email} onChange={handleChange} disabled={!editando} className="w-full normal-case" /></div>
            </div>
            
            {/* Bloco Respons√°vel T√©cnico */}
            <div className="p-4 bg-white/5 rounded-xl border border-white/5 space-y-4 mt-4">
                <p className="text-[10px] text-cyan-400 italic">RESPONS√ÅVEL T√âCNICO</p>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div><label>Nome</label><input name="respTecnico" value={config.respTecnico} onChange={handleChange} disabled={!editando} className="w-full" /></div>
                    <div><label>Profiss√£o</label><input name="profissao" value={config.profissao} onChange={handleChange} disabled={!editando} className="w-full" /></div>
                    <div><label>Registro</label><input name="registro" value={config.registro} onChange={handleChange} disabled={!editando} className="w-full" /></div>
                </div>
            </div>

            {/* --- O C√ìDIGO DA SENHA VAI AQUI (ABAIXO DO T√âCNICO) --- */}
            <div className="p-4 bg-red-900/10 rounded-xl border border-red-500/20 space-y-4 mt-4">
                <p className="text-[10px] text-red-400 italic font-black">SEGURAN√áA DO TERMINAL</p>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label>Nova Senha de Edi√ß√£o</label>
                        <input 
                            name="adminPassword" 
                            type="password"
                            value={config.adminPassword} 
                            onChange={handleChange} 
                            disabled={!editando} 
                            className="w-full !border-red-500/30" 
                            placeholder="Defina a senha para liberar edi√ß√µes"
                        />
                        <p className="text-[8px] text-gray-500 mt-1">* Esta senha ser√° solicitada sempre que desejar alterar configura√ß√µes ou dados do PIX.</p>
                    </div>
                </div>
            </div>
            {/* --- FIM DO C√ìDIGO DA SENHA --- */}

        </div>
    </div>
)}






                {/* GUIA 2 */}
                {activeTab === 'pagamento' && (
                    <div className="p-4 bg-purple-900/10 rounded-xl border border-purple-500/20 space-y-6">
                        <p className="text-purple-400 text-[10px] italic font-black">DADOS PARA O PIX DO CARN√ä</p>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label>Chave PIX</label>
                                {editando ? <input name="pixKey" value={config.pixKey} onChange={handleChange} className="w-full !border-purple-500/30" /> : <div className="p-2 bg-black/40 rounded text-gray-500 font-mono">****************</div>}
                            </div>
                            <div>
                                <label>Titular da Conta</label>
                                {editando ? <input name="pixName" value={config.pixName} onChange={handleChange} className="w-full !border-purple-500/30" /> : <div className="p-2 bg-black/40 rounded text-gray-500">****************</div>}
                            </div>
                            <div>
                                <label>Cidade da Ag√™ncia</label>
                                {editando ? <input name="pixCity" value={config.pixCity} onChange={handleChange} className="w-full !border-purple-500/30" /> : <div className="p-2 bg-black/40 rounded text-gray-500">****************</div>}
                            </div>
                        </div>
                    </div>
                )}




    {activeTab === 'usuario' && (
        <div className="p-4 bg-orange-900/10 rounded-xl border border-orange-500/20 space-y-6">
            <p className="text-orange-400 text-[10px] italic font-black">GERENCIAMENTO DE ACESSO</p>
            
            {/* O BOT√ÉO NOVO AQUI */}
            {window.userPermissions.isAdmin && (
                <button 
                    type="button"
                    onClick={() => window.acessarPainelRestricoes()}
                    className="w-full p-6 glass border border-cyan-500/50 rounded-2xl flex flex-col items-center gap-3 hover:bg-cyan-500/10 transition-all"
                >
                    <Icon name="shield-check" size={32} className="text-cyan-400" />
                    <span className="font-cyber text-[10px] text-white">PAINEL DE GEST√ÉO DE ACESSOS</span>
                    <p className="text-[8px] text-gray-500">Configurar permiss√µes de funcion√°rios</p>
                </button>
            )}
            {/* ... resto do seu c√≥digo de usu√°rio ... */}
        </div>
    )}









                {/* BOT√ïES */}
                <div className="flex justify-end gap-3 mt-10">
                    {!editando ? (
                        <button type="button" onClick={handleHabilitar} className="btn-cyber px-10 py-3 rounded-xl text-[10px]">EDITAR CONFIGURA√á√ïES</button>
                    ) : (
                        <>
                            <button type="button" onClick={() => setEditando(false)} className="bg-red-500/20 text-red-500 px-10 py-3 rounded-xl text-[10px]">CANCELAR</button>
                            <button type="submit" className="bg-green-600 text-white px-10 py-3 rounded-xl text-[10px] font-black">SALVAR ALTERA√á√ïES</button>
                        </>
                    )}
                </div>
            </form>
        </div>
    );
};









const ProductsModule = ({ products, uid }) => {
    const [editId, setEditId] = useState(null);
    const [isProcessing, setIsProcessing] = useState(false);
    const [listSearchTerm, setListSearchTerm] = useState(""); // Novo estado para busca na lista
    const [formData, setFormData] = useState({ 
        nome: "", 
        preco: "", 
        precoCusto: "", 
        codigo: "", 
        categoria: "ARMA√á√ÉO" 
    });

    // Ordena√ß√£o e Filtro da Lista
    const filteredProducts = useMemo(() => {
        return products
            .filter(p => 
                p.nome.toLowerCase().includes(listSearchTerm.toLowerCase()) || 
                p.codigo.includes(listSearchTerm)
            )
            .sort((a, b) => 
                (a.codigo || "").localeCompare((b.codigo || ""), undefined, { numeric: true })
            );
    }, [products, listSearchTerm]);


    const save = async (e) => {
        e.preventDefault();
        setIsProcessing(true);

        const newCodeStr = formData.codigo.trim();
        const newCodeNum = parseInt(newCodeStr);
        const nomeNormalizado = formData.nome.trim().toUpperCase();

        try {
            // --- VALIDA√á√ÉO DE DUPLICIDADE DE NOME ---
            const produtoExistente = products.find(p => 
                p.nome.trim().toUpperCase() === nomeNormalizado && p.id !== editId
            );

            if (produtoExistente) {
                alert(`‚ùå ERRO: O produto "${nomeNormalizado}" j√° est√° cadastrado (C√≥digo: ${produtoExistente.codigo}).`);
                setIsProcessing(false);
                return;
            }

            // 1. VERIFICAR SE O C√ìDIGO J√Å EXISTE (Para Re-sequenciamento)
            const duplicateCode = products.find(p => p.codigo === newCodeStr && p.id !== editId);

            if (duplicateCode && !isNaN(newCodeNum)) {
                const toShift = products
                    .filter(p => parseInt(p.codigo) >= newCodeNum && p.id !== editId)
                    .sort((a, b) => parseInt(b.codigo) - parseInt(a.codigo));

                for (const prod of toShift) {
                    const bumpedCode = (parseInt(prod.codigo) + 1).toString();
                    await db.collection("products").doc(prod.id).update({ codigo: bumpedCode });
                }
            }

            // 2. SALVAR O PRODUTO ATUAL
            const payload = { 
                ...formData, 
                nome: nomeNormalizado,
                codigo: newCodeStr,
                preco: parseFloat(formData.preco.toString().replace(',', '.')), 
                precoCusto: parseFloat(formData.precoCusto.toString().replace(',', '.')) || 0,
                userId: uid 
            };

            if (editId) {
                await db.collection("products").doc(editId).update(payload);
            } else {
                await db.collection("products").add(payload);
            }

            alert("‚úÖ Opera√ß√£o conclu√≠da!");
            setEditId(null);
            setFormData({ nome: "", preco: "", precoCusto: "", codigo: "", categoria: "ARMA√á√ÉO" });
        } catch (err) {
            console.error(err);
            alert("‚ùå Erro ao processar.");
        } finally {
            setIsProcessing(false);
        }
    };

    const edit = (p) => {
        setEditId(p.id);
        setFormData({ 
            nome: p.nome, 
            preco: p.preco, 
            precoCusto: p.precoCusto || "", 
            codigo: p.codigo, 
            categoria: p.categoria || "ARMA√á√ÉO" 
        });
    };

    return (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 animate-in fade-in italic uppercase font-bold">
            
            {isProcessing && (
                <div className="fixed inset-0 bg-black/70 z-[999] flex items-center justify-center backdrop-blur-sm">
                    <div className="text-cyan-400 font-cyber animate-bounce flex flex-col items-center">
                        <Icon name="refresh-cw" className="animate-spin mb-2" size={32}/>
                        VALIDANDO E ORGANIZANDO...
                    </div>
                </div>
            )}

            {/* Formul√°rio lateral */}
            <div className="lg:col-span-1">
                <form onSubmit={save} className="glass p-6 rounded-3xl border border-cyan-500/30 sticky top-4">
                    <h3 className="font-cyber text-cyan-400 mb-6 text-sm">
                        {editId ? 'AJUSTAR REGISTRO' : 'NOVO REGISTRO'}
                    </h3>
                    
                    <div className="space-y-4">
                        <div>
                            <label>C√≥digo (Sequencial)</label>
                            <input 
                                type="number"
                                value={formData.codigo} 
                                onChange={e => setFormData({...formData, codigo: e.target.value})} 
                                className="w-full !text-xl text-cyan-400 font-mono" 
                                required 
                                placeholder="Ex: 10"
                            />
                        </div>

                        <div>
                            <label>Categoria</label>
                            <select 
                                value={formData.categoria} 
                                onChange={e => setFormData({...formData, categoria: e.target.value})} 
                                className="w-full"
                            >
                                <option>ARMA√á√ÉO</option>
                                <option>LENTES</option>
                                <option>SOLAR</option>
                                <option>ACESS√ìRIOS</option>
                                <option>OUTROS</option>
                            </select>
                        </div>

                        <div>
                            <label>Descri√ß√£o/Nome (√önico)</label>
                            <input 
                                value={formData.nome} 
                                onChange={e => setFormData({...formData, nome: e.target.value.toUpperCase()})} 
                                className="w-full" 
                                required 
                                placeholder="NOME DO PRODUTO"
                            />
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label>Custo (R$)</label>
                                <input type="text" value={formData.precoCusto} onChange={e => setFormData({...formData, precoCusto: e.target.value})} className="w-full" placeholder="0,00" />
                            </div>
                            <div>
                                <label>Venda (R$)</label>
                                <input type="text" value={formData.preco} onChange={e => setFormData({...formData, preco: e.target.value})} className="w-full" required placeholder="0,00" />
                            </div>
                        </div>

                        <button type="submit" disabled={isProcessing} className="w-full btn-cyber p-4 rounded-xl font-cyber text-[10px] mt-4">
                            {editId ? 'ATUALIZAR' : 'CADASTRAR PRODUTO'}
                        </button>
                        
                        {editId && (
                            <button type="button" onClick={() => { setEditId(null); setFormData({nome:"", preco:"", precoCusto:"", codigo:"", categoria:"ARMA√á√ÉO"}); }} className="w-full text-[9px] text-gray-500 hover:text-white mt-2">CANCELAR EDI√á√ÉO</button>
                        )}
                    </div>
                </form>
            </div>

            {/* Lista de Produtos com Campo de Pesquisa */}
            <div className="lg:col-span-2 space-y-4">
                {/* CAMPO DE PESQUISA DA LISTA */}
                <div className="glass p-3 rounded-2xl border border-white/10 flex items-center gap-3">
                    <Icon name="search" size={18} className="text-cyan-500" />
                    <input 
                        type="text" 
                        placeholder="PESQUISAR NA LISTA DE PRODUTOS..." 
                        value={listSearchTerm}
                        onChange={(e) => setListSearchTerm(e.target.value)}
                        className="flex-1 !bg-transparent border-none !text-xs tracking-widest focus:ring-0"
                    />
                    {listSearchTerm && (
                        <button onClick={() => setListSearchTerm("")} className="text-gray-500 hover:text-white">
                            <Icon name="x" size={14} />
                        </button>
                    )}
                </div>

                <div className="glass rounded-3xl overflow-hidden border border-white/5">
                    <table className="w-full text-left text-[11px] font-mono">
                        <thead className="bg-white/5 text-cyan-400 font-cyber text-[9px]">
                            <tr>
                                <th className="p-4">C√ìD</th>
                                <th className="p-4">DESCRI√á√ÉO / CATEGORIA</th>
                                <th className="p-4">VENDA</th>
                                <th className="p-4 text-center">A√á√ÉO</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-white/5">
                            {filteredProducts.map(p => (
                                <tr key={p.id} className="hover:bg-white/5 transition-colors">
                                    <td className="p-2 px-4 text-cyan-500 font-bold text-sm">{p.codigo}</td>
                                    <td className="p-2">
                                        <span className="text-white font-bold block leading-tight">{p.nome}</span>
                                        <span className="text-[8px] text-purple-400">{p.categoria}</span>
                                    </td>
                                    <td className="p-2 text-white font-bold">R$ {parseFloat(p.preco).toFixed(2)}</td>
                                    <td className="p-2 flex justify-center gap-3">
                                        <button onClick={() => edit(p)} className="text-cyan-500 hover:scale-110"><Icon name="edit" size={14}/></button>
                                        <button onClick={async () => {
                                            if (!window.userPermissions.isAdmin && window.userPermissions.lockDelete) {
                                                return alert("üö´ ACESSO NEGADO.");
                                            }
                                            if (confirm("Deseja realmente excluir?")) {
                                                await db.collection("products").doc(p.id).delete();
                                            }
                                        }} className="text-red-500 hover:scale-110"><Icon name="trash-2" size={14}/></button>
                                    </td>
                                </tr>
                            ))}
                            {filteredProducts.length === 0 && (
                                <tr><td colSpan="4" className="p-10 text-center text-gray-600">NENHUM PRODUTO ENCONTRADO</td></tr>
                            )}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
};







const ClientsModule = ({ uid, clients, editId, onDone, data }) => {
    const [activeTab, setActiveTab] = useState('cadastro');
    
    // CONTROLE DE BLOQUEIO E FOCO
    const [isLocked, setIsLocked] = useState(editId ? false : true);
    const nameInputRef = useRef(null);

    const [formData, setFormData] = useState({
        nome: "", nascimento: "", tel: "", cpf: "", email: "", 
        cep: "", endereco: "", numero: "", bairro: "", 
        cidade: "", estado: "", referencia: "",
        receitas: [] 
    });

    const receitaTemplate = () => ({
        id: Date.now(),
        dataConsulta: new Date().toISOString().split('T')[0],
        pacienteNome: "", 
        pacienteTipo: "TITULAR",
        od: { esferico: "", cilindrico: "", eixo: "", dnp: "", altura: "", avLonge: "", avPerto: "" },
        oe: { esferico: "", cilindrico: "", eixo: "", dnp: "", altura: "", avLonge: "", avPerto: "" },
        ad: "", lente: "", obs: ""
    });

    const [currentReceita, setCurrentReceita] = useState(receitaTemplate());

    useEffect(() => {
        if (editId) {
            const c = clients.find(cl => cl.id === editId);
            if (c) {
                setFormData(c);
                setIsLocked(false); // Se for edi√ß√£o, libera os campos
                if (c.receitas && c.receitas.length > 0) {
                    setCurrentReceita(c.receitas[0]);
                }
            }
        }
    }, [editId, clients]);

    // FUN√á√ÉO NOVO CLIENTE
    const prepararNovoCliente = () => {
        setFormData({
            nome: "", nascimento: "", tel: "", cpf: "", email: "", 
            cep: "", endereco: "", numero: "", bairro: "", 
            cidade: "", estado: "", referencia: "",
            receitas: []
        });
        setCurrentReceita(receitaTemplate());
        setIsLocked(false);
        setActiveTab('cadastro');
        
        setTimeout(() => {
            if(nameInputRef.current) nameInputRef.current.focus();
        }, 100);
    };

    const autoFormat = (tipo, valor) => {
        let v = valor.trim().replace(',', '.');
        if (!v) return "";
        switch (tipo) {
            case 'esferico':
                let nEsf = parseFloat(v);
                if (isNaN(nEsf)) return v;
                return (nEsf > 0 ? "+" : "") + nEsf.toFixed(2).replace('.', ',');
            case 'cilindrico':
                let nCil = Math.abs(parseFloat(v));
                if (isNaN(nCil)) return v;
                return "-" + nCil.toFixed(2).replace('.', ',');
            case 'eixo':
                let nEixo = v.replace(/\D/g, "");
                return nEixo ? nEixo + "¬∞" : "";
            case 'avLonge':
                let digitos = v.replace(/\D/g, "");
                if (digitos.startsWith("20") && digitos.length > 2) return "20/" + digitos.substring(2);
                return digitos ? "20/" + digitos : "";
            case 'avPerto':
                let digitosP = v.replace(/\D/g, "");
                return digitosP ? "J" + digitosP : "";
            case 'ad':
                let nAd = Math.abs(parseFloat(v));
                if (isNaN(nAd)) return v;
                return "+" + nAd.toFixed(2).replace('.', ',');
            default: return v;
        }
    };

    const handleBlurReceita = (olho, campo, valor) => {
        const formatado = autoFormat(campo, valor);
        setCurrentReceita(prev => ({
            ...prev,
            [olho]: { ...prev[olho], [campo]: formatado }
        }));
    };

    const handleBlurAD = (valor) => {
        const formatado = autoFormat('ad', valor);
        setCurrentReceita(prev => ({ ...prev, ad: formatado }));
    };

    const handleReceitaDirect = (olho, campo, valor) => {
        setCurrentReceita(prev => ({
            ...prev,
            [olho]: { ...prev[olho], [campo]: valor }
        }));
    };

    const handleChange = (e) => {
        const { name, value } = e.target;
        let val = value;
        if (name !== 'email') val = val.toUpperCase();

        if (name === 'cpf') {
            val = val.replace(/\D/g, "").replace(/^(\d{3})(\d)/, "$1.$2").replace(/^(\d{3})\.(\d{3})(\d)/, "$1.$2.$3").replace(/^(\d{3})\.(\d{3})\.(\d{3})(\d)/, "$1.$2.$3-$4").substring(0, 14);
        }
        if (name === 'tel') {
            val = val.replace(/\D/g, "").replace(/^(\d{2})(\d)/g, "($1) $2").replace(/(\d{5})(\d)/, "$1-$2").substring(0, 15);
        }
        if (name === 'cep') {
            val = val.replace(/\D/g, "").replace(/^(\d{5})(\d)/, "$1-$2").substring(0, 9);
        }
        setFormData(prev => ({ ...prev, [name]: val }));
    };

    const iniciarNovaConsulta = () => {
        const nova = receitaTemplate();
        nova.pacienteNome = formData.nome;
        setCurrentReceita(nova);
        alert("Nova consulta iniciada.");
    };

    const excluirReceita = async (id) => {
        if (!window.userPermissions.isAdmin && window.userPermissions.lockDelete) {
            return alert("üö´ ACESSO NEGADO.");
        }
        if (!confirm("Excluir esta receita?")) return;
        const novasReceitas = formData.receitas.filter(r => r.id !== id);
        setFormData(prev => ({ ...prev, receitas: novasReceitas }));
        if (editId) await db.collection("clients").doc(editId).update({ receitas: novasReceitas });
    };

    const save = async (e) => {
        e.preventDefault();
        try {
            let historicoAtual = [...(formData.receitas || [])];
            const index = historicoAtual.findIndex(r => r.id === currentReceita.id);
            
            if (!currentReceita.numeroOS) {
                const todasAsReceitas = (data.clients || []).flatMap(c => c.receitas || []);
                const maiorNumero = todasAsReceitas.reduce((max, r) => {
                    const n = parseInt(r.numeroOS) || 0;
                    return n > max ? n : max;
                }, 0);
                currentReceita.numeroOS = maiorNumero + 1;
            }

            if (index !== -1) {
                historicoAtual[index] = currentReceita;
            } else {
                historicoAtual.unshift(currentReceita);
            }

            const payload = { ...formData, receitas: historicoAtual };
            if (editId) {
                await db.collection("clients").doc(editId).update(payload);
            } else {
                await db.collection("clients").add({ ...payload, userId: uid, createdAt: new Date().toISOString() });
            }
            
            alert("‚úÖ Salvo com sucesso!");
            onDone();
        } catch (err) { 
            console.error(err);
            alert("‚ùå Erro ao salvar"); 
        }
    };

    return (
        <div className="animate-in fade-in">
            <div className="flex gap-2 mb-4">
                <button type="button" onClick={() => setActiveTab('cadastro')} className={`px-6 py-2 rounded-t-xl font-cyber text-[10px] ${activeTab === 'cadastro' ? 'bg-cyan-500 text-black' : 'bg-white/5 text-gray-400'}`}>DADOS PESSOAIS</button>
                <button type="button" onClick={() => setActiveTab('receita')} className={`px-6 py-2 rounded-t-xl font-cyber text-[10px] ${activeTab === 'receita' ? 'bg-cyan-500 text-black' : 'bg-white/5 text-gray-400'}`}>RECEITA / PRONTU√ÅRIO</button>
            </div>

            <form onSubmit={save} className="glass p-8 rounded-b-3xl italic uppercase font-bold border-t-0">
                {activeTab === 'cadastro' ? (
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <h3 className="md:col-span-4 font-cyber text-sm text-cyan-400 border-b border-cyan-500/20 pb-4 mb-2">IDENTIFICA√á√ÉO COMPLETA</h3>
                        <div className="md:col-span-2">
                            <label>Nome Completo</label>
                            <input ref={nameInputRef} name="nome" value={formData.nome} onChange={handleChange} className="w-full" required disabled={isLocked} />
                        </div>
                        <div><label>Nascimento</label><input name="nascimento" type="date" value={formData.nascimento} onChange={handleChange} className="w-full" disabled={isLocked} /></div>
                        <div><label>Celular</label><input name="tel" value={formData.tel} onChange={handleChange} className="w-full" required disabled={isLocked} /></div>
                        <div><label>CPF</label><input name="cpf" value={formData.cpf} onChange={handleChange} className="w-full" required disabled={isLocked} /></div>
                        <div className="md:col-span-2"><label>E-mail</label><input name="email" type="email" value={formData.email} onChange={handleChange} className="w-full" disabled={isLocked} /></div>
                        <div><label>CEP</label><input name="cep" value={formData.cep} onChange={handleChange} className="w-full" disabled={isLocked} /></div>
                        <div className="md:col-span-2"><label>Endere√ßo</label><input name="endereco" value={formData.endereco} onChange={handleChange} className="w-full" disabled={isLocked} /></div>
                        <div><label>N¬∫</label><input name="numero" value={formData.numero} onChange={handleChange} className="w-full" disabled={isLocked} /></div>
                        <div><label>Bairro</label><input name="bairro" value={formData.bairro} onChange={handleChange} className="w-full" disabled={isLocked} /></div>
                        <div><label>Cidade</label><input name="cidade" value={formData.cidade} onChange={handleChange} className="w-full" disabled={isLocked} /></div>
                        <div><label>UF</label><input name="estado" value={formData.estado} onChange={handleChange} maxLength="2" className="w-full" disabled={isLocked} /></div>
                        <div className="md:col-span-4"><label>Ponto de Refer√™ncia</label><input name="referencia" value={formData.referencia} onChange={handleChange} className="w-full" disabled={isLocked} /></div>
                    </div>
                ) : (
                    <div className="grid grid-cols-1 md:grid-cols-12 gap-8">
                        <div className="md:col-span-3 border-r border-white/10 pr-4">
                            <button type="button" onClick={iniciarNovaConsulta} disabled={isLocked} className="w-full bg-green-600 disabled:opacity-50 text-white p-3 rounded-xl mb-4 text-[10px] font-cyber">+ NOVA CONSULTA</button>
                            <p className="text-[9px] text-gray-500 mb-2 font-cyber">HIST√ìRICO</p>
                            <div className="space-y-2 max-h-96 overflow-y-auto pr-2">
                                {(formData.receitas || []).map((r, idx) => (
                                    <div key={r.id || idx} className="flex gap-1 items-center">
                                        <button type="button" onClick={() => setCurrentReceita(r)} className={`flex-1 p-3 rounded-lg text-left text-[10px] border ${currentReceita.id === r.id ? 'border-cyan-500 bg-cyan-500/10 text-cyan-400' : 'border-white/5 bg-white/5 text-gray-400'}`}>
                                            üìÖ {r.dataConsulta.split('-').reverse().join('/')} <br/>
                                            <span className="text-[8px] opacity-70">{r.pacienteNome?.substring(0, 15)}...</span>
                                        </button>
                                        <button type="button" onClick={() => excluirReceita(r.id)} className="p-2 text-red-500 hover:bg-red-500/20 rounded-lg"><Icon name="trash-2" size={14} /></button>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="md:col-span-9 space-y-6">
                            <div className="flex justify-between items-center border-b border-purple-500/20 pb-4">
                                <h3 className="font-cyber text-sm text-purple-400">DADOS T√âCNICOS</h3>
                                <div className="flex items-center gap-2">
                                    <label className="m-0 text-[10px]">DATA:</label>
                                    <input type="date" value={currentReceita.dataConsulta} disabled={isLocked} onChange={e => setCurrentReceita({...currentReceita, dataConsulta: e.target.value})} className="!w-32 py-1 !text-[10px]" />
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 bg-white/5 p-4 rounded-xl border border-purple-500/20 mb-4">
                                <div className="md:col-span-3">
                                    <label>Nome do Paciente</label>
                                    <input 
                                        value={currentReceita.pacienteNome || ""} 
                                        onChange={e => setCurrentReceita({...currentReceita, pacienteNome: e.target.value.toUpperCase()})}
                                        className="w-full !text-cyan-400 font-bold"
                                        placeholder="NOME DE QUEM VAI USAR O √ìCULOS"
                                        disabled={isLocked || currentReceita.pacienteTipo === "TITULAR"}
                                    />
                                </div>
                                <div>
                                    <label>V√≠nculo</label>
                                    <select 
                                        value={currentReceita.pacienteTipo || "TITULAR"} 
                                        disabled={isLocked}
                                        onChange={e => {
                                            const tipo = e.target.value;
                                            const nome = tipo === "TITULAR" ? formData.nome : "";
                                            setCurrentReceita(prev => ({...prev, pacienteTipo: tipo, pacienteNome: nome}));
                                        }}
                                        className="w-full text-[10px]"
                                    >
                                        <option value="TITULAR">O PR√ìPRIO CLIENTE</option>
                                        <option value="DEPENDENTE">DEPENDENTE</option>
                                    </select>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 md:grid-cols-8 gap-3 items-end">
                                <div className="text-cyan-400 font-cyber text-[10px] pb-2">OLHO DIR.</div>
                                <div><label>Esf.</label><input value={currentReceita.od.esferico} disabled={isLocked} onChange={e => handleReceitaDirect('od', 'esferico', e.target.value)} onBlur={e => handleBlurReceita('od', 'esferico', e.target.value)} className="w-full" /></div>
                                <div><label>Cil.</label><input value={currentReceita.od.cilindrico} disabled={isLocked} onChange={e => handleReceitaDirect('od', 'cilindrico', e.target.value)} onBlur={e => handleBlurReceita('od', 'cilindrico', e.target.value)} className="w-full" /></div>
                                <div><label>Eixo</label><input value={currentReceita.od.eixo} disabled={isLocked} onChange={e => handleReceitaDirect('od', 'eixo', e.target.value)} onBlur={e => handleBlurReceita('od', 'eixo', e.target.value)} className="w-full" /></div>
                                <div><label>DNP</label><input value={currentReceita.od.dnp} disabled={isLocked} onChange={e => handleReceitaDirect('od', 'dnp', e.target.value)} className="w-full" /></div>
                                <div><label>Alt.</label><input value={currentReceita.od.altura} disabled={isLocked} onChange={e => handleReceitaDirect('od', 'altura', e.target.value)} className="w-full" /></div>
                                <div><label>AV L</label><input value={currentReceita.od.avLonge} disabled={isLocked} onChange={e => handleReceitaDirect('od', 'avLonge', e.target.value)} onBlur={e => handleBlurReceita('od', 'avLonge', e.target.value)} className="w-full" /></div>
                                <div><label>AV P</label><input value={currentReceita.od.avPerto} disabled={isLocked} onChange={e => handleReceitaDirect('od', 'avPerto', e.target.value)} onBlur={e => handleBlurReceita('od', 'avPerto', e.target.value)} className="w-full" /></div>
                            </div>

                            <div className="grid grid-cols-2 md:grid-cols-8 gap-3 items-end">
                                <div className="text-purple-400 font-cyber text-[10px] pb-2">OLHO ESQ.</div>
                                <div><label>Esf.</label><input value={currentReceita.oe.esferico} disabled={isLocked} onChange={e => handleReceitaDirect('oe', 'esferico', e.target.value)} onBlur={e => handleBlurReceita('oe', 'esferico', e.target.value)} className="w-full" /></div>
                                <div><label>Cil.</label><input value={currentReceita.oe.cilindrico} disabled={isLocked} onChange={e => handleReceitaDirect('oe', 'cilindrico', e.target.value)} onBlur={e => handleBlurReceita('oe', 'cilindrico', e.target.value)} className="w-full" /></div>
                                <div><label>Eixo</label><input value={currentReceita.oe.eixo} disabled={isLocked} onChange={e => handleReceitaDirect('oe', 'eixo', e.target.value)} onBlur={e => handleBlurReceita('oe', 'eixo', e.target.value)} className="w-full" /></div>
                                <div><label>DNP</label><input value={currentReceita.oe.dnp} disabled={isLocked} onChange={e => handleReceitaDirect('oe', 'dnp', e.target.value)} className="w-full" /></div>
                                <div><label>Alt.</label><input value={currentReceita.oe.altura} disabled={isLocked} onChange={e => handleReceitaDirect('oe', 'altura', e.target.value)} className="w-full" /></div>
                                <div><label>AV L</label><input value={currentReceita.oe.avLonge} disabled={isLocked} onChange={e => handleReceitaDirect('oe', 'avLonge', e.target.value)} onBlur={e => handleBlurReceita('oe', 'avLonge', e.target.value)} className="w-full" /></div>
                                <div><label>AV P</label><input value={currentReceita.oe.avPerto} disabled={isLocked} onChange={e => handleReceitaDirect('oe', 'avPerto', e.target.value)} onBlur={e => handleBlurReceita('oe', 'avPerto', e.target.value)} className="w-full" /></div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                                <div><label>Adi√ß√£o (AD)</label><input value={currentReceita.ad} disabled={isLocked} onChange={e => setCurrentReceita({...currentReceita, ad: e.target.value})} onBlur={e => handleBlurAD(e.target.value)} className="w-full" /></div>
                                <div className="md:col-span-3"><label>Lente Recomendada</label><input value={currentReceita.lente} disabled={isLocked} onChange={e => setCurrentReceita({...currentReceita, lente: e.target.value})} className="w-full" /></div>
                            </div>
                            <div><label>Observa√ß√µes</label><textarea value={currentReceita.obs} disabled={isLocked} onChange={e => setCurrentReceita({...currentReceita, obs: e.target.value})} className="w-full bg-black/50 border border-white/10 rounded-lg p-3 text-white h-20 text-[11px]"></textarea></div>
                        </div>
                    </div>
                )}
                
                <div className="flex gap-3 mt-8 pt-4 border-t border-white/5">
                    <button type="button" onClick={prepararNovoCliente} className="bg-white/10 hover:bg-white/20 text-white px-8 py-3 rounded-xl text-[10px] font-cyber transition-all border border-white/10">
                        + NOVO CLIENTE
                    </button>
                    <button type="submit" disabled={isLocked} className={`btn-cyber px-10 py-3 rounded-xl text-[10px] ${isLocked ? 'opacity-50 grayscale' : ''}`}>
                        SALVAR FICHA COMPLETA
                    </button>
                </div>
            </form>
        </div>
    );
};










        const SalesModule = ({ data, uid, onSaleFinish }) => {
    const [cart, setCart] = useState([]);
    const [clId, setClId] = useState("");
    const [clSearch, setClSearch] = useState("");
    const [prSearch, setPrSearch] = useState("");
    const [totalManual, setTotalManual] = useState(0);
    const [entry, setEntry] = useState(0);
    const [entryMet, setEntryMet] = useState("Esp√©cie");
    const [entryDat, setEntryDat] = useState(new Date().toISOString().split('T')[0]);
    const [firstDate, setFirstDate] = useState(new Date().toISOString().split('T')[0]);
    const [numPar, setNumPar] = useState(1);
    const [pars, setPars] = useState([]);


// --- ADICIONE ESTE BLOCO AQUI ---
const salesSearchRef = useRef(null);
const totalInputRef = useRef(null);


const [highlightedIndex, setHighlightedIndex] = useState(-1);

// Filtramos os clientes antes para poder navegar neles
const filteredClients = data.clients
    .filter(c => c.nome.toLowerCase().includes(clSearch.toLowerCase()))
    .slice(0, 5);

useEffect(() => {
    if (salesSearchRef.current) {
        salesSearchRef.current.focus();
    }
}, []);



    useEffect(() => {
        const sum = cart.reduce((acc, i) => acc + i.preco, 0);
        setTotalManual(sum);
    }, [cart]);


    // >>> COLE O C√ìDIGO DOS PRODUTOS AQUI EMBAIXO <<<
    const [prodHighlightedIndex, setProdHighlightedIndex] = useState(-1);

    const availableProducts = data.products
        .filter(p => p.nome.toLowerCase().includes(prSearch.toLowerCase()) || p.codigo.includes(prSearch))
        .slice(0, 10); 

    useEffect(() => {
        setProdHighlightedIndex(-1);
    }, [prSearch]);





    useEffect(() => {
        if (!firstDate || firstDate.length < 10) return;
        try {
            const start = new Date(firstDate + 'T12:00:00');
            if (isNaN(start.getTime())) return;
            const temp = [];
            const val = (subtotal / numPar).toFixed(2);
            for (let i = 0; i < numPar; i++) {
                const d = new Date(start); 
                d.setMonth(start.getMonth() + i);
                if (!isNaN(d.getTime())) {
                    temp.push({ 
                        n: i + 1, 
                        val, 
                        date: d.toISOString().split('T')[0] 
                    });
                }
            }
            setPars(temp);
        } catch (e) { console.error(e); }
    }, [numPar, totalManual, entry, firstDate]);

    const subtotal = totalManual - entry;







const finish = async () => {
    if (!clId || cart.length === 0) return alert("‚ùå Dados Incompletos");
    
    const cl = data.clients.find(c => c.id === clId);
    
    // Convertemos para n√∫mero para garantir a compara√ß√£o correta
    const vTotal = parseFloat(totalManual);
    const vEntry = parseFloat(entry || 0);
    const isPaidInFull = vEntry >= vTotal;

    const saleData = { 
        userId: uid, 
        clientId: cl.id, 
        clientName: cl.nome, 
        total: vTotal, 
        entry: vEntry, 
        entryMet, 
        entryDat, 
        date: entryDat, 
        items: cart.map(i => i.nome),
        status: isPaidInFull ? 'quitada' : 'pendente' // Flag opcional de status
    };

    try {
        const sale = await db.collection("sales").add(saleData);
        const instsForPrint = [];

        // S√ì GERA PARCELAS SE N√ÉO ESTIVER QUITADA
        if (!isPaidInFull) {
            for (let p of pars) {
                const amountNum = parseFloat(p.val);
                const inst = { 
                    userId: uid, 
                    saleId: sale.id, 
                    clientName: cl.nome, 
                    number: p.n, 
                    total: numPar, 
                    amount: amountNum, 
                    dueDate: p.date, 
                    status: 'pendente' 
                };
                await db.collection("installments").add(inst);
                instsForPrint.push(inst);
            }
        }

        alert(isPaidInFull ? "üöÄ Venda √† Vista Finalizada (QUITADA)!" : "üöÄ Venda Parcelada Finalizada!");
        
        // Chamamos o finish enviando os dados (se estiver quitada, installments vai vazio)
        onSaleFinish({ client: cl, sale: saleData, installments: instsForPrint });
        
        setCart([]); 
        setEntry(0); 
        setClId(""); 
        setClSearch("");
    } catch (err) {
        console.error(err);
        alert("Erro ao finalizar venda.");
    }
};








    return (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 animate-in fade-in italic uppercase font-bold">
            <div className="glass p-6 rounded-3xl space-y-6">
                {/* BUSCA DE CLIENTE DIN√ÇMICA */}

<div className="relative">
    <label className="text-[9px]">Buscar Cliente</label>
    <input 
        ref={salesSearchRef} // <--- ADICIONE ISSO AQUI
        type="text" 
        value={clSearch} 
        onChange={e => {
            setClSearch(e.target.value);
            if(clId) setClId(""); 
        }}



    // --- ADICIONE ESTE EVENTO ABAIXO ---
    onKeyDown={e => {
        if (filteredClients.length === 0) return;

        if (e.key === "ArrowDown") {
            setHighlightedIndex(prev => (prev < filteredClients.length - 1 ? prev + 1 : prev));
        } else if (e.key === "ArrowUp") {
            setHighlightedIndex(prev => (prev > 0 ? prev - 1 : 0));
        } else if (e.key === "Enter" && highlightedIndex >= 0) {
            const selected = filteredClients[highlightedIndex];
            setClId(selected.id);
            setClSearch(selected.nome);
            setHighlightedIndex(-1);
        }
    }}



        className="w-full uppercase" 
        placeholder="DIGITE O NOME DO CLIENTE..." 
    />
                    
                    {/* Lista Suspensa de Clientes (S√≥ aparece se houver texto e nenhum selecionado) */}
                    {clSearch.length > 0 && !clId && (
                        <div className="absolute z-50 w-full mt-1 glass border border-cyan-500/50 rounded-xl overflow-hidden shadow-2xl">
{filteredClients.map((c, idx) => (
    <div 
        key={c.id} 
        onClick={() => {
            setClId(c.id);
            setClSearch(c.nome);
            setHighlightedIndex(-1);
        }}
        className={`p-3 cursor-pointer border-b border-white/5 last:border-0 text-[11px] transition-colors ${
            highlightedIndex === idx ? 'bg-cyan-500 text-black' : 'bg-black/90 text-white hover:bg-cyan-500/20'
        }`}
    >
        {c.nome} <span className="text-[9px] opacity-70 ml-2">({c.cpf})</span>
    </div>
))}
                            {data.clients.filter(c => c.nome.toLowerCase().includes(clSearch.toLowerCase())).length === 0 && (
                                <div className="p-3 bg-black/90 text-gray-500 text-[10px]">NENHUM CLIENTE ENCONTRADO</div>
                            )}
                        </div>
                    )}
                    {clId && (
                        <div className="absolute right-3 top-7 text-green-500 animate-pulse">
                            <Icon name="check-circle" size={16} />
                        </div>
                    )}
                </div>

                {/* BUSCA DE PRODUTO */}
                <div>
                    <label className="text-[9px]">Buscar Produto</label>


<input 
    type="text" 
    value={prSearch} 
    onChange={e => setPrSearch(e.target.value)} 
    onKeyDown={e => {
	
	if (e.key === 'Tab') {
            e.preventDefault(); // Impede o comportamento padr√£o de ir para o pr√≥ximo bot√£o
            totalInputRef.current.focus();
            totalInputRef.current.select(); // J√° seleciona o valor para facilitar a troca
            return;
        }

        if (availableProducts.length === 0) return;

        if (e.key === "ArrowDown") {
            setProdHighlightedIndex(prev => (prev < availableProducts.length - 1 ? prev + 1 : prev));
        } else if (e.key === "ArrowUp") {
            setProdHighlightedIndex(prev => (prev > 0 ? prev - 1 : 0));
        } else if (e.key === "Enter" && prodHighlightedIndex >= 0) {
            const selectedProd = availableProducts[prodHighlightedIndex];
            setCart([...cart, selectedProd]);
            setPrSearch("");
            setProdHighlightedIndex(-1);
        }
    }}
    className="w-full mb-2 uppercase" 
    placeholder="NOME OU C√ìDIGO..." 
/>


<div className="max-h-64 overflow-y-auto space-y-2 pr-2">
    {availableProducts.map((p, idx) => (
        <button 
            key={p.id} 
            onClick={() => {
                setCart([...cart, p]);
                setPrSearch("");
                setProdHighlightedIndex(-1);
            }} 
            className={`w-full flex justify-between p-4 rounded-2xl border italic text-[11px] transition-all ${
                prodHighlightedIndex === idx 
                ? 'bg-cyan-500 text-black border-cyan-400 scale-[1.02] shadow-lg shadow-cyan-500/20' 
                : 'bg-white/5 text-white border-white/5 hover:bg-cyan-500/10'
            }`}
        >
            <span className={prodHighlightedIndex === idx ? 'font-black' : ''}>{p.nome}</span>
            <span className={`font-mono ${prodHighlightedIndex === idx ? 'text-black' : 'text-cyan-400'}`}>
                R$ {p.preco.toFixed(2)}
            </span>
        </button>
    ))}
    {prSearch && availableProducts.length === 0 && (
        <div className="p-4 text-center text-gray-500 text-[10px]">PRODUTO N√ÉO ENCONTRADO</div>
    )}
</div>
                </div>

                {/* CARRINHO (Lista de Itens Selecionados) */}
                {cart.length > 0 && (
                    <div className="border-t border-white/10 pt-4">
                        <label className="text-[9px] text-cyan-500">Itens no Pedido</label>
                        <div className="space-y-2 mt-2">
                            {cart.map((item, idx) => (
                                <div key={idx} className="flex justify-between items-center text-[10px] bg-white/5 p-2 rounded-lg">
                                    <span>{item.nome}</span>
                                    <button onClick={() => setCart(cart.filter((_, i) => i !== idx))} className="text-red-500 hover:text-red-400">
                                        <Icon name="trash-2" size={14} />
                                    </button>
                                </div>
                            ))}
                        </div>
                    </div>
                )}
            </div>

            <div className="glass p-8 rounded-3xl border border-cyan-500/30 flex flex-col justify-between">
    <div>

<div className="flex justify-between items-center mb-6">
    <h3 className="font-cyber text-[20px] text-cyan-300">Total</h3>
    <input 
        ref={totalInputRef} // <--- ADICIONE ISSO AQUI
        type="number" 
        step="0.01" 
        value={totalManual} 
        onChange={(e) => setTotalManual(e.target.value)} 
        className="!text-4xl font-mono text-white italic bg-transparent border-none text-center w-full focus:ring-0 focus:outline-none"
    />
</div>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div><label>Entrada (R$)</label><input type="number" value={entry} onChange={e=>setEntry(e.target.value)} className="w-full" /></div>
            <div><label>Pagto Entrada</label><select value={entryMet} onChange={e=>setEntryMet(e.target.value)} className="w-full text-[9px]">{METODOS.map(m=><option key={m}>{m}</option>)}</select></div>
            <div><label>Data Entrada</label><input type="date" value={entryDat} onChange={e=>setEntryDat(e.target.value)} className="w-full text-[10px]" /></div>
        </div>

        {/* L√ìGICA NOVA: S√ì MOSTRA SE O TOTAL FOR MAIOR QUE A ENTRADA */}
        {parseFloat(totalManual) > parseFloat(entry || 0) ? (
            <>
                <div className="grid grid-cols-2 gap-3 mt-4 animate-in slide-in-from-top-2">
                    <div><label>1¬™ Parcela</label><input type="date" value={firstDate} onChange={e=>setFirstDate(e.target.value)} className="w-full text-[10px]" /></div>
                    <div><label>N¬∫ Parcelas</label><select value={numPar} onChange={e=>setNumPar(parseInt(e.target.value))} className="w-full font-bold">{[1,2,3,4,5,6,7,8].map(n=><option key={n} value={n}>{n}x</option>)}</select></div>
                </div>
                <div className="bg-black/40 p-5 rounded-2xl max-h-40 overflow-y-auto space-y-2 border border-white/5 text-[10px] font-mono mt-4 italic">
                    {pars.map((p, i) => ( 
                        <div key={i} className="flex justify-between border-b border-white/5 pb-1 uppercase font-bold">
                            <span>{p.n}¬∫ - {p.date.split('-').reverse().join('/')}</span>
                            <span className="text-cyan-400">R$ {p.val}</span>
                        </div> 
                    ))}
                </div>
            </>
        ) : (
            <div className="mt-6 p-4 bg-green-500/10 border border-green-500/30 rounded-2xl text-center">
                <p className="text-green-500 text-[10px] font-black">VENDA √Ä VISTA IDENTIFICADA</p>
                <p className="text-gray-400 text-[8px]">O VALOR TOTAL SER√Å QUITADO PELA ENTRADA.</p>
            </div>
        )}
    </div>
    <button onClick={finish} className="w-full btn-cyber p-5 rounded-2xl font-cyber uppercase font-bold text-xs tracking-widest mt-6">Efetuar Opera√ß√£o</button>
</div>


        </div>
    );
};








const TemplatesModule = ({ templates, uid }) => {
    const [editId, setEditId] = useState(null);
    const [formData, setFormData] = useState({ titulo: "", texto: "" });


    const save = async (e) => {
        e.preventDefault();
        try {
            if (editId) {
                await db.collection("templates").doc(editId).update(formData);
            } else {
                await db.collection("templates").add({ ...formData, userId: uid });
            }
            alert("‚úÖ Template salvo!");
            setEditId(null);
            setFormData({ titulo: "", texto: "" });
        } catch (err) { alert("Erro ao salvar"); }
    };





    return (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 animate-in fade-in italic font-bold uppercase">
            <div className="lg:col-span-1">
                <form onSubmit={save} className="glass p-6 rounded-3xl border border-purple-500/30 sticky top-4">
                    <h3 className="font-cyber text-purple-400 mb-6 text-sm">NOVO MODELO</h3>
                    <div className="space-y-4">
                        <div>
                            <label>T√≠tulo do Modelo</label>
                            <input value={formData.titulo} onChange={e => setFormData({...formData, titulo: e.target.value.toUpperCase()})} className="w-full" placeholder="EX: LEMBRETE DE COBRAN√áA" required />
                        </div>
                        <div>
                            <label>Mensagem</label>
                            <textarea value={formData.texto} onChange={e => setFormData({...formData, texto: e.target.value})} className="w-full h-40 bg-black/50 border border-white/10 rounded-lg p-3 text-white outline-none text-[11px]" placeholder="Use {{nome}} para o nome do cliente..." required />
                        </div>
<div className="text-[8px] text-gray-500 space-y-1">
    <p>Tags: {"{{nome}}"}, {"{{vencimento}}"}</p>
    <p>Extras: {"{{valor}}"}, {"{{clinica}}"}</p> 
</div>
                        <button type="submit" className="w-full btn-cyber p-4 rounded-xl font-cyber text-[10px] mt-4">SALVAR MODELO</button>
                    </div>
                </form>
            </div>






{/* LISTA DE TEMPLATES COM TEXTO COMPLETO */}
<div className="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4"> 
    {templates.map(t => (
        <div key={t.id} className="glass p-4 rounded-2xl border border-white/5 flex flex-col h-fit">
            <div className="mb-3">
                <h4 className="text-cyan-400 font-cyber text-[10px] mb-2 border-b border-cyan-500/20 pb-1 italic">
                    {t.titulo}
                </h4>
                {/* O segredo est√° no whitespace-pre-wrap e na remo√ß√£o do line-clamp */}
                <p className="text-[11px] text-gray-300 normal-case font-normal leading-relaxed whitespace-pre-wrap">
                    {t.texto}
                </p>
            </div>
            <div className="flex justify-end gap-4 mt-auto pt-3 border-t border-white/5">
                <button 
                    onClick={() => { setEditId(t.id); setFormData({titulo: t.titulo, texto: t.texto}); }} 
                    className="text-cyan-500 hover:scale-110 transition-transform flex items-center gap-1 text-[9px]"
                >
                    <Icon name="edit" size={14}/> EDITAR
                </button>
<button 
    onClick={() => {
        if (!window.userPermissions.isAdmin && window.userPermissions.lockDelete) {
            return alert("üö´ ACESSO NEGADO.");
        }
        if (confirm("Excluir?")) db.collection("templates").doc(t.id).delete();
    }} 
    className="text-red-500 hover:scale-110 transition-transform flex items-center gap-1 text-[9px]"
>
    <Icon name="trash-2" size={14}/> EXCLUIR
</button>


            </div>
        </div>
    ))}




            </div>
        </div>
    );
};






// --INICIO DO C√ìDIGO DO PAGAMENTO--
const ClientListView = ({ data, initialId, onEdit, onCarne }) => {
    const [selId, setSelId] = useState(initialId);
    const [selSaleId, setSelSaleId] = useState(null);
    const [search, setSearch] = useState("");
    const [reportClientId, setReportClientId] = useState(null);
    const [showTemplatePicker, setShowTemplatePicker] = useState(false); 
    const [clientToMessage, setClientToMessage] = useState(null);
    const [payingId, setPayingId] = useState(null);
    const [payStep, setPayStep] = useState('menu'); 
    const [partialValue, setPartialValue] = useState(0);
    const [renegocId, setRenegocId] = useState(null);
    const [newDueDate, setNewDueDate] = useState(""); 

    const searchInputRef = useRef(null); 
    const [listHighlightedIndex, setListHighlightedIndex] = useState(-1);

    // --- L√ìGICA DE FILTRAGEM CORRIGIDA E ROBUSTA ---
    const filteredList = data.clients.filter(c => {
        const searchTerm = search.toLowerCase().trim();
        if (!searchTerm) return true;

        // 1. Busca por Nome
        const bateNome = c.nome && c.nome.toLowerCase().includes(searchTerm);
        
        // 2. Busca por CPF (remove pontos e tra√ßos para comparar apenas n√∫meros)
        const cpfLimpo = c.cpf ? c.cpf.replace(/\D/g, "") : "";
        const searchLimpa = searchTerm.replace(/\D/g, "");
        const bateCpf = searchLimpa !== "" && cpfLimpo.includes(searchLimpa);
        
        // 3. Busca por N√∫mero da OS (L√≥gica aprofundada)
        const bateOS = c.receitas && c.receitas.some(r => {
            if (!r.numeroOS) return false;
            const osStr = r.numeroOS.toString();
            // Compara o n√∫mero puro (ex: 5) e tamb√©m com zeros √† esquerda (ex: 00005)
            return osStr.includes(searchTerm) || osStr.padStart(5, '0').includes(searchTerm);
        });

        return bateNome || bateCpf || bateOS;
    });

    // Foco autom√°tico ao montar o componente
    useEffect(() => {
        if (searchInputRef.current) {
            searchInputRef.current.focus();
        }
    }, []); 

    // Reseta o destaque da lista ao digitar
    useEffect(() => {
        setListHighlightedIndex(-1);
    }, [search]);






const excluirClienteCompleto = async (cliente) => {
    if (!window.userPermissions.isAdmin && window.userPermissions.lockDelete) {
        return alert("üö´ ACESSO NEGADO: Voc√™ n√£o tem permiss√£o para excluir cadastros de clientes.");
    }
    if (!confirm(`‚ö†Ô∏è ATEN√á√ÉO CR√çTICA...`)) return;
        
        try {
            // 1. Busca e deleta todas as PARCELAS pelo nome do cliente
            const snapshotParcelas = await db.collection("installments")
                .where("clientName", "==", cliente.nome)
                .get();
            
            // 2. Busca e deleta todas as VENDAS pelo ID do cliente
            const snapshotVendas = await db.collection("sales")
                .where("clientId", "==", cliente.id)
                .get();

            // Usamos um lote (batch) para deletar tudo de uma vez de forma segura
            const batch = db.batch();
            
            snapshotParcelas.forEach(doc => batch.delete(doc.ref));
            snapshotVendas.forEach(doc => batch.delete(doc.ref));
            
            // 3. Por fim, deleta o cadastro do cliente
            batch.delete(db.collection("clients").doc(cliente.id));

            await batch.commit();
            alert("‚úÖ Cliente e todos os dados vinculados foram removidos!");
        } catch (err) {
            console.error(err);
            alert("Erro ao realizar exclus√£o total.");
        }
    };





    useEffect(() => { 
        setSelId(initialId);      
        setSelSaleId(null);       
        setPayingId(null); // Limpa modal de pagamento se aberto
        setPayStep('menu');
    }, [initialId]);

    const activeInst = data.installments.find(i => i.id === payingId);





    // --- FUN√á√ïES DE L√ìGICA (RESTAURADAS DO ORIGINAL) ---
const dispararMensagem = (template, cliente) => {
    if(!cliente) return;
    const hoje = new Date();
    const hojeIso = hoje.toISOString().split('T')[0];

    // --- L√ìGICA DE COBRAN√áA ---
    const parcelasVencidas = data.installments.filter(inst => 
        inst.clientName.trim().toUpperCase() === cliente.nome.trim().toUpperCase() && 
        inst.status === 'pendente' &&
        inst.dueDate <= hojeIso
    ).sort((a, b) => a.dueDate.localeCompare(b.dueDate));

    let valorTotalVencido = 0;
    let listaDatas = "";
    if (parcelasVencidas.length > 0) {
        parcelasVencidas.forEach((p) => {
            valorTotalVencido += p.amount;
            listaDatas += `\n‚Ä¢ Vencimento: ${p.dueDate.split('-').reverse().join('/')} - Valor: R$ ${p.amount.toFixed(2)}`;
        });
    } else {
        listaDatas = "Nenhuma parcela em aberto.";
    }

    // --- L√ìGICA DA RECEITA ---
    let dataReceitaTxt = "N√£o encontrada";
    let statusReceitaTxt = "";
    const receitas = cliente.receitas || [];
    const ultimaReceita = receitas.length > 0 
        ? [...receitas].sort((a, b) => b.dataConsulta.localeCompare(a.dataConsulta))[0] 
        : null;

    if (ultimaReceita) {
        const dtConsulta = new Date(ultimaReceita.dataConsulta + 'T12:00:00');
        dataReceitaTxt = ultimaReceita.dataConsulta.split('-').reverse().join('/');
        const dtVencimento = new Date(dtConsulta);
        dtVencimento.setFullYear(dtVencimento.getFullYear() + 1);
        if (hoje > dtVencimento) {
            statusReceitaTxt = `‚ö†Ô∏è ATEN√á√ÉO: Sua √∫ltima receita foi em ${dataReceitaTxt} e j√° est√° VENCIDA.`;
        } else {
            statusReceitaTxt = `Sua √∫ltima receita foi em ${dataReceitaTxt} e ainda √© v√°lida.`;
        }
    }

    // --- L√ìGICA DA DATA DA COMPRA ---
    const vendas = data.sales.filter(s => s.clientId === cliente.id);
    const ultimaVenda = vendas.length > 0 
        ? [...vendas].sort((a, b) => b.date.localeCompare(a.date))[0] 
        : null;
    const dataCompraTxt = ultimaVenda ? ultimaVenda.date.split('-').reverse().join('/') : "N√£o encontrada";

    // --- MONTAGEM DA MENSAGEM ---
    const nomeClinica = data.settings?.nomeClinica || "√ìTICA ILUMINAR";

    let msg = template.texto
        .replace(/{{nome}}/g, cliente.nome)
        .replace(/{{clinica}}/g, nomeClinica)
        .replace(/{{valor}}/g, `R$ ${valorTotalVencido.toFixed(2)}`)
        .replace(/{{vencimento}}/g, listaDatas)
        .replace(/{{data_receita}}/g, dataReceitaTxt)
        .replace(/{{vencimento_receita}}/g, statusReceitaTxt)
        .replace(/{{data_compra}}/g, dataCompraTxt); // <--- NOVA TAG AQUI

    const fone = `55${cliente.tel.replace(/\D/g,'')}`;
    window.open(`https://wa.me/${fone}?text=${encodeURIComponent(msg)}`, '_blank');
    setShowTemplatePicker(false);
    setClientToMessage(null);
};





const confirmarBaixa = async (tipo, detalhes) => {
    const idParaAtualizar = payingId;
    const instAtual = data.installments.find(i => i.id === idParaAtualizar);

    if (!idParaAtualizar || !instAtual) return;

    // 1. FECHA O MODAL ANTES DE TUDO
    // Isso faz a UI voltar para a tela de Detalhamento da Venda na hora
    setPayingId(null);
    setPayStep('menu');

    try {
        const hoje = new Date().toISOString();
        const instRef = db.collection("installments").doc(idParaAtualizar);

        if (tipo === 'TOTAL') {
            await instRef.update({ 
                status: 'pago', 
                paymentDate: hoje, 
                paymentMethod: detalhes.metodo 
            });
        } 
        else if (tipo === 'DESCONTO') {
            await instRef.update({ 
                status: 'pago', 
                paymentDate: hoje, 
                paymentMethod: detalhes.motivo, 
                obs: "Baixa por benef√≠cio/desconto" 
            });
        }
        else if (tipo === 'PARCIAL') {
            const valorPagoAgora = parseFloat(detalhes.valorPago);
            const saldoRestante = instAtual.amount - valorPagoAgora;
            
            await instRef.update({ 
                amount: valorPagoAgora, 
                status: 'pago', 
                paymentDate: hoje, 
                paymentMethod: detalhes.metodo 
            });
            
            if (saldoRestante > 0) {
                const { id, ...dadosNovos } = instAtual; 
                await db.collection("installments").add({ 
                    ...dadosNovos, 
                    amount: saldoRestante, 
                    status: 'pendente', 
                    numberSuffix: '(Saldo)' 
                });
            }
        }
        // O sistema atualizar√° sozinho via onSnapshot do Firebase
    } catch (err) { 
        console.error("Erro ao processar:", err);
    }
};




const salvarRenegociacao = async () => {
        if(!newDueDate) return;
        try {
            await db.collection("installments").doc(renegocId).update({ 
                dueDate: newDueDate, 
                renegociado: true 
            });
            
            // FECHA O MODAL PRIMEIRO PARA A TELA ESCURA SUMIR
            setRenegocId(null);
            
            // Pequeno delay para o alert n√£o travar a anima√ß√£o de fechar
            setTimeout(() => alert("üìÖ VENCIMENTO ATUALIZADO COM SUCESSO!"), 100);
            
        } catch (err) { 
            alert("‚ùå Erro ao atualizar data."); 
            setRenegocId(null); // Fecha o modal mesmo se der erro
        }
    };



const excluirVenda = async (saleId) => {
    if (!window.userPermissions.isAdmin && window.userPermissions.lockDelete) {
        return alert("üö´ ACESSO NEGADO: Voc√™ n√£o tem permiss√£o para excluir vendas.");
    }
    if (!confirm("‚ö†Ô∏è ATEN√á√ÉO: Isso excluir√° permanentemente a venda...")) return;

        try {
            // 1. Deleta a Venda
            await db.collection("sales").doc(saleId).delete();
            // 2. Filtra e deleta todas as parcelas dessa venda
            const parcelasParaDeletar = data.installments.filter(i => i.saleId === saleId);
            for (const inst of parcelasParaDeletar) {
                await db.collection("installments").doc(inst.id).delete();
            }
            alert("üóëÔ∏è Venda e parcelas removidas!");
        } catch (err) { alert("Erro ao excluir venda."); }
    };






    // --- COMPONENTE DO RELAT√ìRIO ---
const ClientReport = ({ clientId, onClose }) => {
        const client = data.clients.find(c => c.id === clientId);
        const sales = data.sales.filter(s => s.clientId === clientId);
        const installments = data.installments.filter(i => i.clientName === client.nome);

        if (!client) return null;

        return (
            /* Esta div √© o fundo que fica preto na tela, mas ficar√° branco no papel */
            <div className="fixed inset-0 bg-black/95 z-[500] overflow-y-auto p-4 md:p-10 flex justify-center print-backdrop-fix">
                
                {/* Esta div √© o papel branco do relat√≥rio */}
                <div className="bg-white text-black w-full max-w-4xl p-8 rounded-none shadow-2xl print-area relative h-fit min-h-full">
                    
                    {/* Bot√µes - no-print para n√£o sa√≠rem na impressora */}
                    <div className="flex justify-end gap-4 mb-8 no-print">
                        <button onClick={() => window.print()} className="bg-cyan-600 text-white px-6 py-2 rounded font-bold text-[10px] uppercase flex items-center gap-2">
                            <Icon name="printer" size={14}/> Imprimir Agora
                        </button>
                        <button onClick={onClose} className="bg-red-600 text-white px-6 py-2 rounded font-bold text-[10px] uppercase">
                            Fechar
                        </button>
                    </div>

                    {/* CABE√áALHO */}
                    <div className="border-b-4 border-black pb-4 mb-6 flex justify-between items-end">




                        <div>
                            <h1 className="text-3xl font-black italic">PRONTU√ÅRIO DO PACIENTE</h1>
                            <p className="text-sm font-bold uppercase">Sistema de Gest√£o</p>
                        </div>
                        <div className="text-right text-[10px]">
                            <p>DATA DE EMISS√ÉO: {new Date().toLocaleDateString()}</p>
                        </div>
                    </div>

                    {/* DADOS PESSOAIS */}
                    <div className="grid grid-cols-2 gap-4 mb-8">
                        <div className="col-span-2 bg-gray-100 p-2 font-black border-l-4 border-black uppercase text-xs">Informa√ß√µes do Cliente</div>
                        <div className="border-b border-gray-300 pb-1"><label className="text-[9px] text-gray-500 block">NOME</label><span className="font-bold">{client.nome}</span></div>
                        <div className="border-b border-gray-300 pb-1"><label className="text-[9px] text-gray-500 block">CPF</label><span className="font-bold">{client.cpf}</span></div>
                        <div className="border-b border-gray-300 pb-1"><label className="text-[9px] text-gray-500 block">TELEFONE</label><span className="font-bold">{client.tel}</span></div>
                        <div className="border-b border-gray-300 pb-1"><label className="text-[9px] text-gray-500 block">ENDERE√áO</label><span className="text-[10px]">{client.endereco}, {client.numero} - {client.bairro}</span></div>
                    </div>

                    {/* CONSULTAS */}
                    <div className="mb-8">
                        <div className="bg-gray-100 p-2 font-black border-l-4 border-black uppercase text-xs mb-4">Hist√≥rico de Receitas</div>
                        {(client.receitas || []).length > 0 ? client.receitas.map((rec, rIdx) => (
                            <div key={rIdx} className="mb-6 border border-gray-300 p-4 break-inside-avoid">
                                <div className="font-bold text-[10px] bg-gray-50 p-1 mb-2">DATA: {rec.dataConsulta?.split('-').reverse().join('/')}</div>
                                <table className="w-full text-center border-collapse border border-black text-[10px]">
                                    <thead>
                                        <tr className="bg-gray-100">
                                            <th className="border border-black p-1">OLHO</th><th className="border border-black p-1">ESF</th><th className="border border-black p-1">CIL</th><th className="border border-black p-1">EIXO</th><th className="border border-black p-1">DNP</th><th className="border border-black p-1">ALT</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td className="border border-black font-bold">OD</td>
                                            <td className="border border-black">{rec.od?.esferico}</td><td className="border border-black">{rec.od?.cilindrico}</td><td className="border border-black">{rec.od?.eixo}</td><td className="border border-black">{rec.od?.dnp}</td><td className="border border-black">{rec.od?.altura}</td>
                                        </tr>
                                        <tr>
                                            <td className="border border-black font-bold">OE</td>
                                            <td className="border border-black">{rec.oe?.esferico}</td><td className="border border-black">{rec.oe?.cilindrico}</td><td className="border border-black">{rec.oe?.eixo}</td><td className="border border-black">{rec.oe?.dnp}</td><td className="border border-black">{rec.oe?.altura}</td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div className="mt-2 text-[10px]">
                                    <p><strong>AD:</strong> {rec.ad} | <strong>LENTE:</strong> {rec.lente}</p>
                                    <p><strong>OBS:</strong> {rec.obs}</p>
                                </div>
                            </div>
                        )) : <p className="text-center text-xs py-4">Nenhum exame registrado.</p>}
                    </div>

                    {/* Se√ß√£o 3: Hist√≥rico de Compras */}
                    <div className="mb-8">
                        <div className="bg-gray-100 p-2 font-black border-l-4 border-black uppercase text-sm mb-2">Hist√≥rico de Vendas e Pagamentos</div>
                        {sales.map((sale, sIdx) => (
                            <div key={sale.id} className="border border-black p-4 mb-4">
                                <div className="flex justify-between font-bold border-b border-black mb-2 pb-1 text-sm uppercase">
                                    <span>Venda #{sIdx + 1} - {new Date(sale.date).toLocaleDateString()}</span>
                                    <span>Total: R$ {sale.total.toFixed(2)}</span>
                                </div>
                                <div className="text-xs mb-3">
                                    <p><span className="font-bold">PRODUTOS:</span> {sale.items?.join(' + ')}</p>
                                    <p><span className="font-bold">ENTRADA:</span> R$ {sale.entry || 0} ({sale.entryMet}) em {new Date(sale.entryDat).toLocaleDateString()}</p>
                                </div>
                                <div className="grid grid-cols-5 gap-2 text-[10px]">
                                    {installments.filter(i => i.saleId === sale.id).map(inst => (
                                        <div key={inst.id} className={`p-2 border ${inst.status === 'pago' ? 'bg-green-50 border-green-600' : 'bg-red-50 border-red-500'}`}>
                                            <span className="font-bold block">PARC. {inst.number}</span>
                                            <span>VALOR: R$ {inst.amount.toFixed(2)}</span><br/>
                                            <span>VENC: {inst.dueDate.split('-').reverse().join('/')}</span><br/>
                                            <span className={`font-black uppercase ${inst.status === 'pago' ? 'text-green-800' : 'text-red-700'}`}>
                                                {inst.status === 'pago' ? '‚úì PAGO' : '‚ö† PENDENTE'}
                                            </span>
                                            {inst.status === 'pago' && inst.paymentDate && (
                                                <div className="mt-1 pt-1 border-t border-green-400 font-bold text-green-900">
                                                    PAGO EM: {inst.paymentDate.split('T')[0].split('-').reverse().join('/')}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="mt-10 border-t border-black pt-4 text-center text-[9px] font-bold uppercase">
                        Documento gerado pelo Sistema da √ìtica Iluminar
                    </div>
                </div>
            </div>
        );
    };








    // --- RENDERIZA√á√ÉO SE CLIENTE SELECIONADO ---

    if (selId) {
        const c = data.clients.find(cl => cl.id === selId);
        
        // SEGURAN√áA 1: Se o cliente sumiu ou n√£o foi encontrado, volta pra lista
        if (!c) {
            setSelId(null);
            return null;
        }

        const sales = data.sales.filter(s => s.clientId === selId);
        const currentSale = data.sales.find(s => s.id === selSaleId);
        const insts = data.installments.filter(i => i.saleId === selSaleId);

        // SEGURAN√áA 2: Localiza a parcela que est√° sendo paga de forma segura
        const activeInst = payingId ? data.installments.find(i => i.id === payingId) : null;

        return (


            <div className="space-y-4 animate-in fade-in italic uppercase font-bold">
                
                {/* MODAL RENEGOCIA√á√ÉO */}
                {renegocId && (
                    <div className="fixed inset-0 bg-black/90 z-[250] flex items-center justify-center p-4">
                        <div className="glass p-8 rounded-3xl border border-yellow-500/50 max-w-xs w-full text-center">
                            <Icon name="calendar-clock" size={40} className="text-yellow-500 mx-auto mb-4" />
                            <h3 className="font-cyber text-white text-xs mb-4">RENEGOCIAR VENCIMENTO</h3>
                            <input type="date" value={newDueDate} onChange={e => setNewDueDate(e.target.value)} className="w-full text-center mb-6" />
                            <div className="flex gap-2">
                                <button onClick={salvarRenegociacao} className="flex-1 bg-yellow-500 text-black p-3 rounded-xl font-black text-[10px]">ATUALIZAR</button>
                                <button onClick={() => setRenegocId(null)} className="flex-1 bg-white/10 text-white p-3 rounded-xl font-black text-[10px]">CANCELAR</button>
                            </div>
                        </div>
                    </div>
                )}

{/* MODAL PAGAMENTO COM TRAVA ANTI-ERRO */}
{payingId && (() => {
    const activeInst = data.installments.find(i => i.id === payingId);
    
    // Se a parcela sumiu ou mudou, n√£o renderiza nada (evita tela preta)
    if (!activeInst) return null;

    return (
        <div className="fixed inset-0 bg-black/95 backdrop-blur-md z-[200] flex items-center justify-center p-4 no-print">
            <div className="glass p-8 rounded-3xl max-w-sm w-full border border-cyan-500/30 text-center uppercase shadow-2xl">
                <div className="mb-6">
                    <h3 className="font-cyber text-cyan-400 text-[10px] mb-2 tracking-widest italic">Terminal de Recebimento</h3>
                    <p className="text-white text-2xl mt-2 font-mono italic">
                        R$ {Number(activeInst.amount || 0).toFixed(2)}
                    </p>
                </div>
                {payStep === 'menu' && (
                    <div className="grid gap-3">
                        <button onClick={() => setPayStep('recebido')} className="w-full p-4 bg-green-500/20 text-green-400 border border-green-500/40 rounded-xl hover:bg-green-500/30 transition-all flex justify-between items-center text-[10px]">PAGAMENTO INTEGRAL <Icon name="chevron-right" size={14}/></button>
                        <button onClick={() => setPayStep('desconto')} className="w-full p-4 bg-purple-500/20 text-purple-400 border border-purple-500/40 rounded-xl hover:bg-purple-500/30 transition-all flex justify-between items-center text-[10px]">DESCONTO / CORTESIA <Icon name="chevron-right" size={14}/></button>
                        <button onClick={() => { setPayStep('parcial'); setPartialValue(activeInst.amount); }} className="w-full p-4 bg-yellow-500/20 text-yellow-400 border border-yellow-500/40 rounded-xl hover:bg-yellow-500/30 transition-all flex justify-between items-center text-[10px]">PAGAR PARTE DO VALOR <Icon name="chevron-right" size={14}/></button>
                        <button onClick={() => setPayingId(null)} className="mt-4 text-[9px] text-red-500">CANCELAR</button>
                    </div>
                )}
                {payStep === 'recebido' && (
                    <div className="grid gap-2">
                        {["Esp√©cie", "Cart√£o D√©bito", "Cart√£o Cr√©dito", "PIX"].map(m => (
                            <button key={m} onClick={() => confirmarBaixa('TOTAL', {metodo: m})} className="w-full p-3 bg-white/5 border border-white/10 rounded-xl hover:bg-cyan-500 hover:text-black text-[10px]">{m}</button>
                        ))}
                        <button onClick={() => setPayStep('menu')} className="mt-4 text-[9px] text-gray-500">VOLTAR</button>
                    </div>
                )}
                {payStep === 'parcial' && (
                    <div className="space-y-4">
                        <input type="number" step="0.01" value={partialValue} onChange={e => setPartialValue(e.target.value)} className="w-full !text-2xl text-center text-yellow-500 font-mono bg-transparent border-b border-yellow-500/30 mb-4" />
                        <div className="grid grid-cols-2 gap-2">
                            {["Esp√©cie", "PIX", "Cart√£o"].map(m => (
                                <button key={m} onClick={() => confirmarBaixa('PARCIAL', {metodo: m, valorPago: partialValue})} className="p-3 bg-white/5 border border-white/10 rounded-xl text-[9px] hover:bg-yellow-500 hover:text-black">{m}</button>
                            ))}
                        </div>
                        <button onClick={() => setPayStep('menu')} className="mt-4 text-[9px] text-gray-500 block w-full">VOLTAR</button>
                    </div>
                )}
                {payStep === 'desconto' && (
                    <div className="grid gap-2">
                        {["Cortesia", "Desconto Especial", "Fidelidade", "Ajuste de Saldo"].map(m => (
                            <button key={m} onClick={() => confirmarBaixa('DESCONTO', {motivo: m})} className="w-full p-3 bg-white/5 border border-white/10 rounded-xl hover:bg-purple-500 hover:text-black text-[10px]">{m}</button>
                        ))}
                        <button onClick={() => setPayStep('menu')} className="mt-4 text-[9px] text-gray-500">VOLTAR</button>
                    </div>
                )}
            </div>
        </div>
    );
})()}




                <button onClick={() => { if(selSaleId) setSelSaleId(null); else setSelId(null); }} className="text-[10px] text-cyan-400 font-bold flex items-center gap-2 mb-6"><Icon name="arrow-left" size={12}/> Voltar</button>
                <h3 className="font-cyber text-sm text-white border-l-4 border-cyan-500 pl-4 uppercase">{c?.nome}</h3>





                
{!selSaleId ? sales.map(s => {
    const parcelasDestaVenda = data.installments.filter(i => i.saleId === s.id);
    const temDebito = parcelasDestaVenda.some(i => i.status === 'pendente');
    return (
        <div key={s.id} onClick={() => setSelSaleId(s.id)} className={`glass p-5 rounded-2xl flex justify-between items-center cursor-pointer mb-2 border transition-all ${temDebito ? 'border-red-500/30 hover:border-red-500' : 'border-green-500/30 hover:border-green-500'}`}>
            <div className="flex flex-col gap-1 flex-1">
                <div className="flex items-center gap-3">
                    <span className="text-gray-300">Venda: {new Date(s.date).toLocaleDateString()}</span>
                    {temDebito ? (
                        <span className="text-[12px] text-red-500 font-black flex items-center gap-1"><span className="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>CLIENTE DEVENDO</span>
                    ) : (
                        <span className="text-[10px] text-green-500 font-black flex items-center gap-1"><span className="w-2 h-2 bg-green-500 rounded-full"></span>VENDA QUITADA</span>
                    )}
                </div>
                
                {/* LINHA ADICIONADA: Exibi√ß√£o dos Produtos */}
                <div className="mt-1">
                    <span className="text-[14px] text-purple-400 font-black">PRODUTOS: </span>
                    <span className="text-[16px] text-white/80 lowercase">
                        {s.items && s.items.length > 0 ? s.items.join(' + ') : 'n√£o especificado'}
                    </span>
                </div>
            </div>
            
            <div className="text-right ml-4">
                <span className="text-cyan-400 font-mono text-lg block">R$ {s.total.toFixed(2)}</span>
                <span className="text-[8px] text-gray-500">CLIQUE PARA DETALHES</span>


		<button 
                    onClick={(e) => { e.stopPropagation(); excluirVenda(s.id); }} 
                    className="mt-2 text-red-500 hover:text-red-700 flex items-center gap-1 justify-end w-full text-[10px] border-t border-white/5 pt-2"
                >
                    <Icon name="trash-2" size={12}/> EXCLUIR VENDA
                </button>


            </div>
        </div>
    );
}) : (






<div className="glass p-8 rounded-3xl overflow-x-auto">
    <div className="flex flex-col md:flex-row justify-between items-center mb-6 no-print gap-4">
        <h4 className="font-bold text-xs italic text-cyan-400 uppercase tracking-widest">
            Detalhamento da Venda e Cobran√ßa
        </h4>

        <div className="flex flex-wrap gap-2 justify-center">



    {/* NOVO BOT√ÉO CONTRATO */}
    <button 
        onClick={() => imprimirContrato(c, currentSale, insts, data.settings)}
        className="bg-blue-600/10 text-blue-400 border border-blue-500/30 px-4 py-2 rounded-xl text-[9px] font-black hover:bg-blue-600 hover:text-white transition-all"
    >
        IMPRIMIR CONTRATO
    </button>






            {/* BOT√ÉO OS */}
            <button 
                onClick={() => imprimirOS(c, currentSale, data)}
                className="bg-orange-500/10 text-orange-400 border border-orange-500/30 px-4 py-2 rounded-xl text-[9px] font-black hover:bg-orange-500 hover:text-black transition-all"
            >
                IMPRIMIR OS
            </button>

            {/* BOT√ÉO CAPA CORRIGIDO */}
            <button 
                onClick={(e) => {
                    e.preventDefault();
                    gerarCapaPDF({ client: c, sale: currentSale }, data.settings);
                }} 
                className="bg-purple-500/10 text-purple-400 border border-purple-500/30 px-4 py-2 rounded-xl text-[9px] font-black hover:bg-purple-500 hover:text-black transition-all"
            >
                IMPRIMIR CAPA
            </button>
            
            {/* BOT√ÉO CARN√ä */}
            <button 
                onClick={() => onCarne({ client: c, sale: currentSale, installments: insts })} 
                className="bg-cyan-500/10 text-cyan-400 border border-cyan-500/30 px-4 py-2 rounded-xl text-[9px] font-black hover:bg-cyan-500 hover:text-black transition-all"
            >
                GERAR CARN√ä
            </button>



    {/* NOVO BOT√ÉO: RECIBO DE QUITA√á√ÉO (S√≥ aparece se n√£o houver d√©bitos) */}
    {!insts.some(i => i.status === 'pendente') && (
        <button 
            onClick={() => imprimirReciboVenda(c, currentSale.total, currentSale.date, "DIVERSOS", data.settings, `QUITA√á√ÉO TOTAL DA VENDA - ITENS: ${currentSale.items.join(', ')}`)} 
            className="bg-green-600/20 text-green-400 border border-green-600/30 px-4 py-2 rounded-xl text-[9px] font-black hover:bg-green-600 hover:text-white transition-all"
        >
            RECIBO QUITA√á√ÉO
        </button>
    )}




        </div>





                        </div>
                        <table className="w-full text-left text-[11px] font-mono">
                            <thead>
                                <tr className="text-gray-500 border-b border-white/5 uppercase">
                                    <th className="p-4">Parcela</th><th className="p-4">Vencimento</th><th className="p-4">Valor</th><th className="p-4">Data Pagto</th><th className="p-4">Status</th><th className="p-4 text-center">A√ß√£o</th>
                                </tr>
                            </thead>





<tbody>
    {currentSale?.entry > 0 && (
        <tr className="border-b border-white/10 bg-white/5">
            <td className="p-4 text-cyan-400 font-bold">VALOR ENTRADA</td>
            <td className="p-4">{new Date(currentSale.entryDat + 'T12:00:00').toLocaleDateString()}</td>
            <td className="p-4 font-bold text-white">R$ {parseFloat(currentSale.entry).toFixed(2)}</td>
            <td className="p-4">{new Date(currentSale.entryDat + 'T12:00:00').toLocaleDateString()}</td>
            <td className="p-4"><span className="text-green-500">LIQUIDADO</span></td>
            <td className="p-4 text-center">
                <div className="flex items-center justify-center gap-2">
                    <Icon name="check-circle" size={16} className="text-green-500" />
                    <button 
                        title="Imprimir Recibo de Entrada"
                        onClick={() => imprimirReciboVenda(c, currentSale.entry, currentSale.entryDat, currentSale.entryMet, data.settings, "PAGAMENTO DE ENTRADA/SINAL")} 
                        className="text-white bg-white/10 p-1.5 rounded-lg hover:bg-white/20 transition-all"
                    >
                        <Icon name="file-text" size={14} />
                    </button>
                </div>
            </td>
        </tr>
    )}

    {/* LISTA DE PARCELAS */}
    {insts.sort((a,b) => a.number - b.number).map(i => {
        if (!i || !i.status) return null;
        const hojeFormatado = new Date().toISOString().split('T')[0];
        const estaVencida = i.status === 'pendente' && i.dueDate < hojeFormatado;

        return (
            <tr key={i.id} className={`border-b border-white/5 ${estaVencida ? 'bg-red-500/5' : ''}`}>
                <td className="p-4">{i.number}¬∫ {i.numberSuffix || ''}</td>
                
                {/* COLUNA DE VENCIMENTO COM BOT√ÉO DE ALTERAR AO LADO */}
                <td className="p-4">
                    <div className="flex items-center gap-2">
                        <span className={estaVencida ? 'text-red-500' : ''}>
                            {i.dueDate?.split('-').reverse().join('/') || '--/--/--'}
                        </span>
                        {i.status === 'pendente' && (
                            <button 
                                title="Alterar Data de Vencimento"
                                onClick={() => { setRenegocId(i.id); setNewDueDate(i.dueDate); }} 
                                className="text-yellow-500 hover:text-yellow-300 transition-colors p-1"
                            >
                                <Icon name="calendar-days" size={14} />
                            </button>
                        )}
                    </div>
                </td>

                <td className="p-4 font-bold">R$ {Number(i.amount || 0).toFixed(2)}</td>
                <td className="p-4">{i.paymentDate?.split('T')[0].split('-').reverse().join('/') || '--'}</td>
                <td className="p-4">
                    <span className={estaVencida ? 'text-red-500 font-black' : (i.status === 'pago' ? 'text-green-500' : 'text-white')}>
                        {estaVencida ? 'VENCIDA' : i.status.toUpperCase()}
                    </span>
                </td>
                <td className="p-4 text-center">
                    <div className="flex justify-center items-center gap-2">
                        {i.status === 'pendente' ? (
                            <button onClick={() => setPayingId(i.id)} className="bg-cyan-500 text-black px-4 py-1 rounded-xl text-[9px] font-black hover:bg-white transition-all">RECEBER</button>
                        ) : (
                            <>
                                <Icon name="check-circle" size={16} className="text-green-500" />
                                <button 
                                    title="Imprimir Recibo"
                                    onClick={() => imprimirReciboVenda(c, i.amount, i.paymentDate, i.paymentMethod, data.settings, `PAGAMENTO DA PARCELA ${i.number}/${i.total}`)} 
                                    className="text-white bg-white/10 p-1.5 rounded-lg hover:bg-white/20 transition-all"
                                >
                                    <Icon name="file-text" size={14} />
                                </button>
                            </>
                        )}
                    </div>
                </td>
            </tr>
        );
    })}
</tbody>


                        </table>
                    </div>
                )}
            </div>
        );
    }





// --- LISTA DE CLIENTES (PADR√ÉO) ---
    return (
        <div className="space-y-6 animate-in fade-in italic uppercase font-bold">
            {reportClientId && <ClientReport clientId={reportClientId} onClose={() => setReportClientId(null)} />}
            
            <div className="flex gap-4 items-end">
                <div className="flex-1">
                    <label className="mb-2">Busca de Clientes (NOME, CPF OU N¬∫ O.S.)</label>
                    <input 
                        ref={searchInputRef}
                        type="text" 
                        value={search} 
                        onChange={e => setSearch(e.target.value)} 
                        onKeyDown={e => {
                            if (filteredList.length === 0) return;
                            if (e.key === "ArrowDown") {
                                setListHighlightedIndex(prev => (prev < filteredList.length - 1 ? prev + 1 : prev));
                            } else if (e.key === "ArrowUp") {
                                setListHighlightedIndex(prev => (prev > 0 ? prev - 1 : 0));
                            } else if (e.key === "Enter" && listHighlightedIndex >= 0) {
                                const selected = filteredList[listHighlightedIndex];
                                setSelId(selected.id); 
                                setListHighlightedIndex(-1);
                            }
                        }}
                        placeholder="DIGITE NOME, CPF OU O N√öMERO DA O.S. PARA LOCALIZAR..." 
                        className="w-full font-bold text-[10px] h-11 tracking-widest border-cyan-500/30 focus:border-cyan-500" 
                    />
                </div>
                <button onClick={() => setSearch("")} className="btn-cyber px-6 py-2 rounded-lg font-bold text-[10px] h-11">LIMPAR</button>
            </div>






{/* --- VERS√ÉO MOBILE (CARDS) --- */}
<div className="md:hidden space-y-4">
    {data.clients
        .filter(c => c.nome.toLowerCase().includes(search.toLowerCase()) || c.cpf.includes(search))
        .map((c, idx) => { // <--- CORRE√á√ÉO AQUI
            const hoje = new Date(); hoje.setHours(0,0,0,0);
            
            // 1. C√ÅLCULO ANIVERS√ÅRIO
            let ehAniversariante = false;
            if (c.nascimento) {
                const [ano, mes, dia] = c.nascimento.split('-').map(Number);
                let niver = new Date(hoje.getFullYear(), mes - 1, dia);
                if (niver < hoje) niver.setFullYear(hoje.getFullYear() + 1);
                const diffNiver = Math.ceil((niver - hoje) / (1000 * 60 * 60 * 24));
                ehAniversariante = (diffNiver === 0 || diffNiver === 365);
            }

            // 2. C√ÅLCULO EXAME VENCIDO (RECEITA)
            const receitasCliente = c.receitas || [];
            const ultimaReceita = receitasCliente.length > 0 
                ? [...receitasCliente].sort((a, b) => b.dataConsulta.localeCompare(a.dataConsulta))[0] 
                : null;

            let exameVencido = false;
            if (ultimaReceita) {
                const dataVencimento = new Date(ultimaReceita.dataConsulta + 'T12:00:00');
                dataVencimento.setFullYear(dataVencimento.getFullYear() + 1);
                if (hoje >= dataVencimento) {
                    exameVencido = true;
                }
            }

            // 3. DEFINI√á√ÉO DAS CLASSES DO CARD
            let cardClass = "glass p-4 rounded-2xl border transition-all ";

            if (listHighlightedIndex === idx) { // Agora o idx existe e n√£o dar√° erro!
                cardClass += "bg-gray-500 border-white shadow-[0_0_15px_rgba(255,255,255,0.3)] "; 
            } else if (ehAniversariante) {
                cardClass += "pulse-red-row border-red-500/50 ";
            }

            return (
                <div key={c.id} className={cardClass}>
                    <div className="flex justify-between items-start mb-3">
                        <div onClick={() => setSelId(c.id)} className="cursor-pointer flex-1">
                            <p className={`font-bold text-base leading-tight ${ehAniversariante ? 'text-red-500' : (exameVencido ? 'text-yellow-500' : 'text-cyan-400')}`}>
                                {c.nome}
                                {ehAniversariante && <span className="text-xl ml-2">üéÇ</span>}
                                {exameVencido && <span className="text-xl ml-2">üëì</span>}
                            </p>
                            <p className="text-[10px] text-gray-400 font-mono mt-1">{c.cpf}</p>
                            
                            <div className="flex gap-2 mt-1">
                                {ehAniversariante && <span className="text-[8px] bg-red-500 text-white px-2 py-0.5 rounded-full font-black animate-bounce">ANIVERS√ÅRIO</span>}
                                {exameVencido && <span className="text-[8px] bg-yellow-600 text-white px-2 py-0.5 rounded-full font-black">RECEITA VENCIDA</span>}
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={()=>onEdit(c.id)} className="p-2 bg-cyan-500/10 text-cyan-500 rounded-lg"><Icon name="edit" size={16}/></button>
                            <button onClick={()=>setReportClientId(c.id)} className="p-2 bg-purple-500/10 text-purple-500 rounded-lg"><Icon name="file-text" size={16}/></button>
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-2 gap-2 border-t border-white/5 pt-3 mb-3">
                        <div className="text-[9px]">
                            <p className="text-gray-500 uppercase">Contato</p>
                            <p className="text-white font-bold">{c.tel}</p>
                        </div>
                        <div className="text-[9px] text-right">
                            <p className="text-gray-500 uppercase">√öltima Receita</p>
                            <p className={`font-bold ${exameVencido ? 'text-red-500' : 'text-white'}`}>
                                {ultimaReceita ? ultimaReceita.dataConsulta.split('-').reverse().join('/') : '--'}
                            </p>
                        </div>
                    </div>

                    <div className="flex gap-2">
                        <button 
                            onClick={() => { setClientToMessage(c); setShowTemplatePicker(true); }} 
                            className="flex-1 bg-green-600 text-white py-2.5 rounded-xl text-[10px] font-black flex items-center justify-center gap-2"
                        >
                            <Icon name="message-circle" size={14}/> WHATSAPP
                        </button>
                        <button 
                            onClick={() => excluirClienteCompleto(c)} 
                            className="p-2.5 bg-red-500/10 text-red-500 rounded-xl"
                        >
                            <Icon name="trash-2" size={14}/>
                        </button>
                    </div>
                </div>
            );
        })}
</div>





{/* --- VERS√ÉO DESKTOP (TABELA) --- */}
<div className="hidden md:block glass rounded-3xl overflow-hidden shadow-xl">
    <table className="w-full text-left text-[10px] font-mono italic uppercase">
<thead className="bg-white/5 font-cyber text-cyan-400 uppercase text-[9px] border-b border-white/5">
    <tr>
        <th className="p-5">Nome</th>
        <th className="p-5">CPF</th>
        <th className="p-5">√öltima Receita</th>
        <th className="p-5">Data/Nascimento</th>
        <th className="p-5">Contato</th>
        <th className="p-5 text-center">Terminal</th>
    </tr>
</thead>
        <tbody className="divide-y divide-white/5">
            {filteredList.map((c, idx) => { // Usamos a lista filtrada e o √≠ndice
    		const hoje = new Date(); hoje.setHours(0,0,0,0);







                
                // 1. C√ÅLCULO DE ANIVERSARIANTE (PISCA VERMELHO)
                let ehAniversariante = false;
                if (c.nascimento) {
                    const [ano, mes, dia] = c.nascimento.split('-').map(Number);
                    let niver = new Date(hoje.getFullYear(), mes - 1, dia);
                    if (niver < hoje) niver.setFullYear(hoje.getFullYear() + 1);
                    const diffNiver = Math.ceil((niver - hoje) / (1000 * 60 * 60 * 24));
                    ehAniversariante = (diffNiver === 0 || diffNiver === 365);
                }

                // 2. NOVO C√ÅLCULO DE EXAME VENCIDO (OLHANDO PARA A RECEITA/PRONTU√ÅRIO) - PISCA AMARELO
                const receitasCliente = c.receitas || [];
                const ultimaReceita = receitasCliente.length > 0 
                    ? [...receitasCliente].sort((a, b) => b.dataConsulta.localeCompare(a.dataConsulta))[0] 
                    : null;

                let exameVencido = false;

                if (ultimaReceita) {
                    const dataVencimento = new Date(ultimaReceita.dataConsulta + 'T12:00:00');
                    dataVencimento.setFullYear(dataVencimento.getFullYear() + 1);
                    if (hoje >= dataVencimento) {
                        exameVencido = true;
                    }
                }

    // DEFINI√á√ÉO DA CLASSE DA LINHA (ALTERE PARA ESTA ABAIXO)
    let rowClass = "hover:bg-cyan-200/5 transition-colors italic font-bold cursor-pointer ";
    
    if (listHighlightedIndex === idx) {
        rowClass += "bg-gray-500 text-black "; // COR QUANDO SELECIONADO PELA SETA
    } else if (ehAniversariante) {
        rowClass += "pulse-red-row ";
    } else if (exameVencido) {
        rowClass += "pulse-yellow ";
    }

                return (
                    <tr key={c.id} className={rowClass}>
                        {/* NOME COM EMOJIS DIN√ÇMICOS */}
                        <td 
                            className={`p-5 font-bold cursor-pointer transition-all ${ehAniversariante ? 'text-red-600 scale-105' : 'text-cyan-400'}`} 
                            onClick={() => setSelId(c.id)}
                        >
                            {c.nome} 
                            {ehAniversariante && <span className="text-2xl ml-2" title="Aniversariante!">üéÇ</span>}
                            {exameVencido && <span className="text-2xl ml-2" title="Exame Vencido!">üëì</span>}
                        </td>

                        <td className="p-5">{c.cpf}</td>

                        {/* COLUNA DATA DA RECEITA */}
                        <td className="p-5">
                            {ultimaReceita ? (
                                <>
                                    <span className="block">{new Date(ultimaReceita.dataConsulta + 'T12:00:00').toLocaleDateString()}</span>
                                    <span className={`block text-[9px] mt-1 font-black ${exameVencido ? 'text-red-500 animate-pulse' : 'text-green-500'}`}>
                                        {exameVencido ? '‚ö†Ô∏è RECEITA VENCIDA!' : '‚úÖ RECEITA EM DIA'}
                                    </span>
                                </>
                            ) : '--'}
                        </td>

                        <td className="p-5">
                            {c.nascimento ? c.nascimento.split('-').reverse().join('/') : '--'}
                            {ehAniversariante && (
                                <span className="block text-[9px] mt-1 font-black text-red-600 animate-bounce">
                                    üéâ FELIZ ANIVERS√ÅRIO!
                                </span>
                            )}
                        </td>

                        <td className="p-5 text-purple-400">{c.tel}</td>

                        <td className="p-5 flex justify-center gap-3">
                            <button onClick={()=>onEdit(c.id)} title="Editar/Nova Receita" className="text-cyan-500 hover:scale-110">
                                <Icon name="edit" size={16}/>
                            </button>
                            <button onClick={() => { setClientToMessage(c); setShowTemplatePicker(true); }} title="WhatsApp" className="text-green-500 hover:scale-110">
                                <Icon name="message-circle" size={16}/>
                            </button>
                            <button onClick={()=>setReportClientId(c.id)} title="Prontu√°rio" className="text-purple-500 hover:scale-110">
                                <Icon name="file-text" size={16}/>
                            </button>
                            <button onClick={() => excluirClienteCompleto(c)} title="Excluir" className="text-red-500 hover:scale-110">
                                <Icon name="trash-2" size={16}/>
                            </button>
                        </td>
                    </tr>
                );
            })}
        </tbody>
    </table>
</div>





            {/* MODAL MENSAGENS */}
            {showTemplatePicker && (
                <div className="fixed inset-0 bg-black/90 z-[500] flex items-center justify-center p-4">
                    <div className="glass p-8 rounded-3xl border border-cyan-500/30 max-w-sm w-full">
                        <h3 className="font-cyber text-cyan-400 text-xs mb-6 text-center">ESCOLHER MODELO</h3>
                        <div className="space-y-3 max-h-80 overflow-y-auto pr-2">
                            {data.templates.map(t => (
                                <button key={t.id} onClick={() => dispararMensagem(t, clientToMessage)} 
                                    className="w-full p-4 bg-white/5 hover:bg-cyan-500 hover:text-black rounded-xl text-left text-[10px] border border-white/5 transition-all">
                                    {t.titulo}
                                </button>
                            ))}
                        </div>
                        <button onClick={() => { setShowTemplatePicker(false); setClientToMessage(null); }} className="w-full mt-6 text-red-500 text-[10px]">CANCELAR</button>
                    </div>
                </div>
            )}
        </div>
    );
};










const PrintCarne = ({ data, settings, onCancel }) => { // Adicionamos 'settings'
    // BUSCA DO BANCO OU PADR√ÉO
    const SEU_PIX_KEY = settings?.pixKey || " ";
    const SEU_NOME = settings?.pixName || " ";
    const SUA_CIDADE = settings?.pixCity || " ";

    return (
        <div className="fixed inset-0 bg-black/90 z-[9999] overflow-auto p-4 flex flex-col items-center no-print italic">
            <div className="bg-white p-8 w-full max-w-2xl text-black font-sans print-area rounded-xl">
                <div className="flex justify-between mb-8 no-print italic font-bold">
                    <button onClick={() => window.print()} className="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 uppercase text-xs"><Icon name="printer" /> Imprimir</button>
                    <button onClick={onCancel} className="bg-red-600 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 uppercase text-xs"><Icon name="x" /> Fechar</button>
                </div>
                
                {data.installments.map((inst, idx) => {
                    // Gera o c√≥digo PIX espec√≠fico para esta parcela
                    const pixValue = generatePixPayload(
                        SEU_PIX_KEY, 
                        SEU_NOME, 
                        SUA_CIDADE, 
                        inst.amount,
                        `PARC${inst.number}`
                    );

                    return (
                        <div key={idx} className="carne-item mb-10 border-2 border-black p-4 flex flex-col font-bold uppercase italic">
                            <div className="flex justify-between border-b-2 border-black pb-2 mb-4">
                                <h1 className="text-lg">√ìTICA ILUMINAR - CARN√ä DE PAGAMENTO</h1>
                                <span>PARCELA {inst.number}/{data.installments.length}</span>
                            </div>
                            
                            <div className="flex justify-between gap-4">
                                <div className="flex-1 grid grid-cols-1 gap-1 text-[12px]">
                                    <p>CLIENTE: {data.client.nome}</p>
                                    <p>CPF: {data.client.cpf}</p>
                                    <p>COMPRA: {data.sale.items.join(', ')}</p>
                                    <div className="mt-4 border-t border-black pt-2">
                                        <p className="text-lg uppercase">Vencimento: {inst.dueDate.split('-').reverse().join('/')}</p>
                                        <p className="text-xl font-bold italic uppercase">Valor: R$ {inst.amount.toFixed(2)}</p>
                                    </div>
                                </div>
                                
                                {/* √ÅREA DO QR CODE */}
                                <div className="flex flex-col items-center justify-center text-center">
                                    <QRCodeComponent value={pixValue} size={110} />
                                    <span className="text-[8px] mt-1">Pague via PIX</span>
                                </div>
                            </div>
                            
                            <div className="mt-6 border-t border-dashed border-gray-400 pt-4 text-[9px] text-center">
                                ASSINATURA: ____________________________________________________
                            </div>
                        </div>
                    );
                })}
            </div>
        </div>
    );
};





const ReportsModule = ({ data }) => {
    const [viewMode, setViewMode] = useState('month');
    const [selectedDate, setSelectedDate] = useState(new Date().toLocaleDateString('en-CA'));
    const selectedMonth = selectedDate.substring(0, 7);

    const stats = React.useMemo(() => {
        const filter = viewMode === 'month' ? selectedMonth : selectedDate;

        const salesInPeriod = (data.sales || []).filter(s => s.date && s.date.startsWith(filter));
        const entriesInPeriod = (data.sales || []).filter(s => s.entryDat && s.entryDat.startsWith(filter));
        const paidInstallments = (data.installments || []).filter(i => 
            i.status === 'pago' && i.paymentDate && i.paymentDate.startsWith(filter)
        );

        let detailedList = [];
        let resumo = { especie: 0, pix: 0, cartao: 0, outros: 0 };
        let listaDiaria = {};

        const getCategory = (method) => {
            const m = (method || "").toLowerCase();
            if (m.includes("esp√©cie") || m.includes("especie")) return "especie";
            if (m.includes("pix")) return "pix";
            if (m.includes("cart√£o") || m.includes("cartao") || m.includes("d√©bito") || m.includes("debito") || m.includes("cr√©dito") || m.includes("credito")) return "cartao";
            return "outros";
        };

        // 1. Processar Entradas
        entriesInPeriod.forEach(s => {
            const val = Number(s.entry || 0);
            resumo[getCategory(s.entryMet)] += val;
            detailedList.push({ 
                data: s.entryDat, 
                cliente: s.clientName, 
                tipo: "Entrada/Sinal", 
                valor: val 
            });
            
            const dia = s.entryDat;
            if(!listaDiaria[dia]) listaDiaria[dia] = 0;
            listaDiaria[dia] += val;
        });

        // 2. Processar Parcelas
        paidInstallments.forEach(i => {
            const val = Number(i.amount || 0);
            resumo[getCategory(i.paymentMethod)] += val;
            const dataPagto = i.paymentDate.split('T')[0];
            detailedList.push({ 
                data: dataPagto, 
                cliente: i.clientName, 
                tipo: `Parc. ${i.number}/${i.total || ''}`, 
                valor: val 
            });
            
            if(!listaDiaria[dataPagto]) listaDiaria[dataPagto] = 0;
            listaDiaria[dataPagto] += val;
        });

        detailedList.sort((a, b) => a.data.localeCompare(b.data));

        return {
            totalVendido: salesInPeriod.reduce((acc, s) => acc + (Number(s.total) || 0), 0),
            totalRecebido: Object.values(resumo).reduce((a, b) => a + b, 0),
            resumo,
            qtdVendas: salesInPeriod.length,
            detailedList,
            listaDiaria: Object.entries(listaDiaria).sort((a,b) => b[0].localeCompare(a[0]))
        };
    }, [data, selectedDate, viewMode, selectedMonth]);

    return (
        <div className="space-y-8 animate-in fade-in italic uppercase font-bold">
            {/* CABE√áALHO */}
            <div className="flex flex-col md:flex-row justify-between items-center gap-6 bg-black/20 p-6 rounded-3xl border border-white/5">
                <div>
                    <h2 className="font-cyber text-2xl text-cyan-400">TERMINAL FINANCEIRO</h2>
                    <p className="text-[10px] text-gray-500">RELAT√ìRIOS E FLUXO DE CAIXA</p>
                </div>
                
                <div className="flex flex-wrap items-center gap-4">
                    <button 
    onClick={() => abrirModalEscolhaRelatorio(stats, stats.detailedList, viewMode, selectedDate, data.settings, data)}
    className="flex items-center gap-2 px-6 py-3 bg-cyan-500/10 border border-cyan-500/30 rounded-xl text-[10px] font-black hover:bg-cyan-500 hover:text-black text-cyan-400 transition-all"
>
    <Icon name="printer" size={14} /> IMPRIMIR RELAT√ìRIO
</button>

                    <div className="flex bg-black/40 p-1 rounded-xl border border-white/10">
                        <button onClick={() => setViewMode('month')} className={`px-4 py-2 rounded-lg text-[10px] ${viewMode === 'month' ? 'bg-cyan-500 text-black' : 'text-gray-500'}`}>M√äS</button>
                        <button onClick={() => setViewMode('day')} className={`px-4 py-2 rounded-lg text-[10px] ${viewMode === 'day' ? 'bg-cyan-500 text-black' : 'text-gray-500'}`}>DIA</button>
                    </div>

                    <input 
                        type={viewMode === 'month' ? "month" : "date"} 
                        value={viewMode === 'month' ? selectedDate.substring(0, 7) : selectedDate} 
                        onChange={(e) => setSelectedDate(e.target.value)}
                        className="glass p-2 rounded-xl border-cyan-500/30 bg-transparent text-cyan-400 font-mono outline-none"
                    />
                </div>
            </div>

            {/* CARDS GRANDES (LINHA 1 DA IMAGEM) */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="glass p-8 rounded-3xl border border-purple-500/50 border-l-4 border-l-purple-500">
                    <p className="text-[10px] text-gray-500 mb-2 font-cyber">CONTRATOS FECHADOS</p>
                    <p className="text-5xl font-mono text-white italic">R$ {stats.totalVendido.toFixed(2)}</p>
                </div>
                <div className="glass p-8 rounded-3xl border border-green-500/50 border-l-4 border-l-green-500">
                    <p className="text-[10px] text-gray-500 mb-2 font-cyber">CAIXA REAL (RECEBIDO)</p>
                    <p className="text-5xl font-mono text-green-400 italic">R$ {stats.totalRecebido.toFixed(2)}</p>
                </div>
            </div>

            {/* CARDS DETALHADOS (LINHA 2 DA IMAGEM) */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="glass p-6 rounded-2xl border border-white/5 text-center flex flex-col items-center">
                    <div className="text-yellow-500 mb-2"><Icon name="banknote" size={24} /></div>
                    <p className="text-[9px] text-gray-500 mb-1">ESP√âCIE</p>
                    <p className="text-2xl font-mono text-white italic">R$ {stats.resumo.especie.toFixed(2)}</p>
                </div>
                <div className="glass p-6 rounded-2xl border border-white/5 text-center flex flex-col items-center">
                    <div className="text-cyan-400 mb-2"><Icon name="qr-code" size={24} /></div>
                    <p className="text-[9px] text-gray-500 mb-1">PIX</p>
                    <p className="text-2xl font-mono text-white italic">R$ {stats.resumo.pix.toFixed(2)}</p>
                </div>
                <div className="glass p-6 rounded-2xl border border-white/5 text-center flex flex-col items-center">
                    <div className="text-purple-400 mb-2"><Icon name="credit-card" size={24} /></div>
                    <p className="text-[9px] text-gray-500 mb-1">CART√ÉO/D√âBITO</p>
                    <p className="text-2xl font-mono text-white italic">R$ {stats.resumo.cartao.toFixed(2)}</p>
                </div>
            </div>

            {/* TABELA DE FECHAMENTO DI√ÅRIO */}
            <div className="glass rounded-3xl overflow-hidden border border-white/5">
                <div className="bg-white/5 p-4 border-b border-white/10">
                    <h3 className="font-cyber text-[10px] text-cyan-400 uppercase italic">TOTAIS RECEBIDOS POR DIA</h3>
                </div>
                <table className="w-full text-left text-[11px] font-mono italic">
                    <thead>
                        <tr className="text-gray-500 border-b border-white/5 uppercase text-[9px]">
                            <th className="p-4">DATA PAGTO</th>
                            <th className="p-4 text-right">TOTAL RECEBIDO</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-white/5">
                        {stats.listaDiaria.length > 0 ? stats.listaDiaria.map(([dia, valor]) => (
                            <tr key={dia} className="hover:bg-white/5">
                                <td className="p-4">{dia.split('-').reverse().join('/')}</td>
                                <td className="p-4 text-right text-cyan-400">R$ {valor.toFixed(2)}</td>
                            </tr>
                        )) : (
                            <tr><td colSpan="2" className="p-10 text-center text-gray-500 italic">Nenhuma movimenta√ß√£o no per√≠odo.</td></tr>
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    );
};






    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>





<script>
    (function() {
        const block = (e) => {
            // Se o terminal estiver desbloqueado, n√£o bloqueia nada
            if (sessionStorage.getItem('terminal_unlocked') === 'true') return;

            const key = e.key.toLowerCase();
            const ctrl = e.ctrlKey || e.metaKey;

            // Bloqueia Ctrl+S e Ctrl+U
            if (ctrl && (key === 's' || key === 'u')) {
                e.preventDefault();
                // Apenas avisamos, sem esconder o root para n√£o gerar tela preta eterna
                console.warn("A√ß√£o bloqueada pelo sistema de seguran√ßa.");
                return false;
            }
        };
        window.addEventListener('keydown', block, true);
    })();
</script>





<!-- MODAL PAINEL DE RESTRI√á√ïES (GEST√ÉO DE ACESSOS) -->
<div id="modal-restricoes" class="fixed inset-0 bg-black/98 backdrop-blur-xl hidden z-[1000] flex items-center justify-center p-4 overflow-hidden">
    <div class="glass p-6 md:p-10 rounded-[2rem] w-full max-w-[95%] shadow-2xl text-white max-h-[90vh] flex flex-col border border-cyan-500/30">
        <div class="flex justify-between items-start mb-8">
            <div>
                <h3 class="text-xl font-cyber italic text-cyan-400 uppercase tracking-tighter">Gest√£o de Acessos</h3>
                <p class="text-gray-500 text-[9px] font-bold uppercase tracking-[0.3em]">Permiss√µes por conta de funcion√°rio</p>
            </div>
            <button onclick="window.openModalPerm('modal-novo-usuario')" class="btn-cyber px-6 py-3 rounded-xl flex items-center gap-2 text-[10px] font-black">
                <i data-lucide="user-plus" style="width:14px"></i> NOVO USU√ÅRIO
            </button>
        </div>
        <div class="overflow-x-auto flex-1 custom-scroll">
            <table class="w-full text-left min-w-[1000px] text-[10px]">
                <thead class="bg-white/5 text-cyan-400 uppercase font-bold">


		     <tr>
                        <th class="py-4 px-6 text-right">A√ß√µes</th>
                        <th class="py-4 px-6">E-mail do Usu√°rio</th>
                        <th class="py-4 px-6 text-center">Admin</th>
                        <th class="py-4 px-6 text-center">In√≠cio</th>
                        <th class="py-4 px-6 text-center">Clientes</th>
                        <th class="py-4 px-6 text-center">Lista Clientes</th>
                        <th class="py-4 px-6 text-center">Mensagens</th>
                        <th class="py-4 px-6 text-center">Relat√≥rios</th>
                        <th class="py-4 px-6 text-center">Produtos</th>
                        <th class="py-4 px-6 text-center">Vendas</th>
                        <th class="py-4 px-6 text-center">Configs</th>
                        <th class="py-4 px-6 text-center">Excluir</th>
                    </tr>


                </thead>
                <tbody id="lista-usuarios-sistema" class="divide-y divide-white/5">
                    <!-- Gerado via JS -->
                </tbody>
            </table>
        </div>
        <button onclick="window.closeModalPerm('modal-restricoes')" class="mt-8 bg-white/5 py-4 rounded-2xl font-bold uppercase text-[10px] hover:bg-white/10 transition-all">FECHAR PAINEL</button>
    </div>
</div>

<!-- MODAL CADASTRAR NOVO USU√ÅRIO -->
<div id="modal-novo-usuario" class="fixed inset-0 bg-black/90 backdrop-blur-md hidden z-[1100] flex items-center justify-center p-4">
    <div class="glass p-8 rounded-3xl w-full max-w-md shadow-2xl text-white border border-cyan-500/30">
        <h3 class="text-sm font-cyber italic text-cyan-400 uppercase mb-6 text-center">Cadastrar Funcion√°rio</h3>
        <div class="space-y-4">
            <div>
                <label>E-mail de Acesso</label>
                <input type="email" id="new-user-email" class="w-full" placeholder="exemplo@otica.com">
            </div>
            <div>
                <label>Senha Provis√≥ria</label>
                <input type="password" id="new-user-pass" class="w-full" placeholder="******">
            </div>
            <button onclick="window.saveNewUser()" class="w-full btn-cyber py-4 rounded-xl font-bold text-[10px] mt-2">CRIAR CONTA</button>
            <button onclick="window.closeModalPerm('modal-novo-usuario')" class="w-full bg-white/5 py-3 rounded-xl text-[10px] font-bold mt-2">CANCELAR</button>
        </div>
    </div>
</div>






</body>
</html>